import{c as te,a as Je,u as ne,r,b as ve,d as et,R as Z,j as n,e as tt}from"./client-wkiQ-CGV.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],st=te("camera",nt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],at=te("chevron-up",rt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ot=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],it=te("circle",ot);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],ct=te("copy",lt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dt=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],ut=te("ellipsis-vertical",dt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],gt=te("eye",ht);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]],pt=te("grid-3x3",mt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]],xt=te("image-plus",ft);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],bt=te("loader-circle",wt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=[["path",{d:"m14.622 17.897-10.68-2.913",key:"vj2p1u"}],["path",{d:"M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z",key:"18tc5c"}],["path",{d:"M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15",key:"ytzfxy"}]],vt=te("paintbrush",yt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=[["path",{d:"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z",key:"e79jfc"}],["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}]],Xe=te("palette",Ct);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=[["path",{d:"m12 9-8.414 8.414A2 2 0 0 0 3 18.828v1.344a2 2 0 0 1-.586 1.414A2 2 0 0 1 3.828 21h1.344a2 2 0 0 0 1.414-.586L15 12",key:"1y3wsu"}],["path",{d:"m18 9 .4.4a1 1 0 1 1-3 3l-3.8-3.8a1 1 0 1 1 3-3l.4.4 3.4-3.4a1 1 0 1 1 3 3z",key:"110lr1"}],["path",{d:"m2 22 .414-.414",key:"jhxm08"}]],St=te("pipette",kt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=[["path",{d:"m15 14 5-5-5-5",key:"12vg1m"}],["path",{d:"M20 9H9.5A5.5 5.5 0 0 0 4 14.5A5.5 5.5 0 0 0 9.5 20H13",key:"6uklza"}]],jt=te("redo-2",Pt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],It=te("save",Nt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],Lt=te("share-2",Mt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Ut=te("smile",Rt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=[["path",{d:"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z",key:"4pj2yx"}],["path",{d:"M20 3v4",key:"1olli1"}],["path",{d:"M22 5h-4",key:"1gvqau"}],["path",{d:"M4 17v2",key:"vumght"}],["path",{d:"M5 18H3",key:"zchphs"}]],De=te("sparkles",Et);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],Ft=te("undo-2",Dt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],At=te("upload",Tt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],zt=te("users",$t);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Ae=te("x",_t);function ze(e,t,s,o=l=>l){return e*o(.5-t*(.5-s))}function Ot(e){return[-e[0],-e[1]]}function me(e,t){return[e[0]+t[0],e[1]+t[1]]}function ue(e,t){return[e[0]-t[0],e[1]-t[1]]}function ge(e,t){return[e[0]*t,e[1]*t]}function Vt(e,t){return[e[0]/t,e[1]/t]}function ke(e){return[e[1],-e[0]]}function _e(e,t){return e[0]*t[0]+e[1]*t[1]}function Ht(e,t){return e[0]===t[0]&&e[1]===t[1]}function Gt(e){return Math.hypot(e[0],e[1])}function Xt(e){return e[0]*e[0]+e[1]*e[1]}function Oe(e,t){return Xt(ue(e,t))}function Ye(e){return Vt(e,Gt(e))}function Yt(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function Se(e,t,s){let o=Math.sin(s),l=Math.cos(s),m=e[0]-t[0],k=e[1]-t[1],d=m*l-k*o,E=m*o+k*l;return[d+t[0],E+t[1]]}function Fe(e,t,s){return me(e,ge(ue(t,e),s))}function Ve(e,t,s){return me(e,ge(t,s))}var{min:ye,PI:Wt}=Math,He=.275,Pe=Wt+1e-4;function Bt(e,t={}){let{size:s=16,smoothing:o=.5,thinning:l=.5,simulatePressure:m=!0,easing:k=x=>x,start:d={},end:E={},last:q=!1}=t,{cap:X=!0,easing:v=x=>x*(2-x)}=d,{cap:T=!0,easing:S=x=>--x*x*x+1}=E;if(e.length===0||s<=0)return[];let w=e[e.length-1].runningLength,h=d.taper===!1?0:d.taper===!0?Math.max(s,w):d.taper,_=E.taper===!1?0:E.taper===!0?Math.max(s,w):E.taper,N=Math.pow(s*o,2),K=[],H=[],B=e.slice(0,10).reduce((x,O)=>{let V=O.pressure;if(m){let a=ye(1,O.distance/s),C=ye(1,1-a);V=ye(1,x+(C-x)*(a*He))}return(x+V)/2},e[0].pressure),R=ze(s,l,e[e.length-1].pressure,k),J,c=e[0].vector,I=e[0].point,b=I,u=I,p=b,U=!1;for(let x=0;x<e.length;x++){let{pressure:O}=e[x],{point:V,vector:a,distance:C,runningLength:A}=e[x];if(x<e.length-1&&w-A<3)continue;if(l){if(m){let ie=ye(1,C/s),pe=ye(1,1-ie);O=ye(1,B+(pe-B)*(ie*He))}R=ze(s,l,O,k)}else R=s/2;J===void 0&&(J=R);let $=A<h?v(A/h):1,Y=w-A<_?S((w-A)/_):1;R=Math.max(.01,R*Math.min($,Y));let oe=(x<e.length-1?e[x+1]:e[x]).vector,se=x<e.length-1?_e(a,oe):1,fe=_e(a,c)<0&&!U,xe=se!==null&&se<0;if(fe||xe){let ie=ge(ke(c),R);for(let pe=1/13,re=0;re<=1;re+=pe)u=Se(ue(V,ie),V,Pe*re),K.push(u),p=Se(me(V,ie),V,Pe*-re),H.push(p);I=u,b=p,xe&&(U=!0);continue}if(U=!1,x===e.length-1){let ie=ge(ke(a),R);K.push(ue(V,ie)),H.push(me(V,ie));continue}let de=ge(ke(Fe(oe,a,se)),R);u=ue(V,de),(x<=1||Oe(I,u)>N)&&(K.push(u),I=u),p=me(V,de),(x<=1||Oe(b,p)>N)&&(H.push(p),b=p),B=O,c=a}let M=e[0].point.slice(0,2),L=e.length>1?e[e.length-1].point.slice(0,2):me(e[0].point,[1,1]),F=[],Q=[];if(e.length===1){if(!(h||_)||q){let x=Ve(M,Ye(ke(ue(M,L))),-(J||R)),O=[];for(let V=1/13,a=V;a<=1;a+=V)O.push(Se(x,M,Pe*2*a));return O}}else{if(!(h||_&&e.length===1))if(X)for(let O=1/13,V=O;V<=1;V+=O){let a=Se(H[0],M,Pe*V);F.push(a)}else{let O=ue(K[0],H[0]),V=ge(O,.5),a=ge(O,.51);F.push(ue(M,V),ue(M,a),me(M,a),me(M,V))}let x=ke(Ot(e[e.length-1].vector));if(_||h&&e.length===1)Q.push(L);else if(T){let O=Ve(L,x,R);for(let V=1/29,a=V;a<1;a+=V)Q.push(Se(O,L,Pe*3*a))}else Q.push(me(L,ge(x,R)),me(L,ge(x,R*.99)),ue(L,ge(x,R*.99)),ue(L,ge(x,R)))}return K.concat(Q,H.reverse(),F)}function qt(e,t={}){var s;let{streamline:o=.5,size:l=16,last:m=!1}=t;if(e.length===0)return[];let k=.15+(1-o)*.85,d=Array.isArray(e[0])?e:e.map(({x:S,y:w,pressure:h=.5})=>[S,w,h]);if(d.length===2){let S=d[1];d=d.slice(0,-1);for(let w=1;w<5;w++)d.push(Fe(d[0],S,w/4))}d.length===1&&(d=[...d,[...me(d[0],[1,1]),...d[0].slice(2)]]);let E=[{point:[d[0][0],d[0][1]],pressure:d[0][2]>=0?d[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],q=!1,X=0,v=E[0],T=d.length-1;for(let S=1;S<d.length;S++){let w=m&&S===T?d[S].slice(0,2):Fe(v.point,d[S],k);if(Ht(v.point,w))continue;let h=Yt(w,v.point);if(X+=h,S<T&&!q){if(X<l)continue;q=!0}v={point:w,pressure:d[S][2]>=0?d[S][2]:.5,vector:Ye(ue(v.point,w)),distance:h,runningLength:X},E.push(v)}return E[0].vector=((s=E[1])==null?void 0:s.vector)||[0,0],E}function Kt(e,t={}){return Bt(qt(e,t),t)}const W=Je;class Qt{logs=[];enabled=!1;enable(){this.enabled=!0,console.log("%c🔍 P2P Logger Enabled","color: blue; font-weight: bold"),console.log("Monitoring P2P vs Convex activity..."),window.__p2pLogger=this}disable(){this.enabled=!1}logP2P(t,s){if(!this.enabled)return;const o={timestamp:Date.now(),type:"p2p",action:t,details:s};this.logs.push(o),console.log(`%c[P2P] ${t}`,"color: green",s||"")}logConvex(t,s){if(!this.enabled)return;const o={timestamp:Date.now(),type:"convex",action:t,details:s};this.logs.push(o),t.includes("updateLiveStroke")?console.warn(`%c⚠️ [CONVEX] ${t} - P2P should handle this!`,"color: red",s||""):console.log(`%c[CONVEX] ${t}`,"color: orange",s||"")}getStats(){const t=this.logs.filter(l=>l.type==="p2p").length,s=this.logs.filter(l=>l.type==="convex").length,o=this.logs.filter(l=>l.type==="convex"&&l.action.includes("updateLiveStroke")).length;return console.log("%c📊 P2P vs Convex Stats","color: blue; font-weight: bold"),console.log(`P2P Messages: ${t}`),console.log(`Convex Calls: ${s}`),console.log(`Live Stroke via Convex: ${o} ${o>0?"❌ (should be 0)":"✅"}`),{p2pCount:t,convexCount:s,liveStrokeCount:o}}clear(){this.logs=[],console.log("Logger cleared")}getLogs(){return this.logs}}const Ne=new Qt;function We(e){const t=ne(W.users.createAnonymousUser),[s,o]=r.useState({id:null,name:`User ${Math.floor(Math.random()*1e3)}`,color:`hsl(${Math.floor(Math.random()*360)}, 70%, 50%)`}),[l,m]=r.useState(!1),k=ve(W.paintingSessions.getSession,e?{sessionId:e}:"skip"),d=ve(W.strokes.getSessionStrokes,e?{sessionId:e}:"skip"),E=ve(W.presence.getSessionPresence,e?{sessionId:e}:"skip"),q=ve(W.liveStrokes.getLiveStrokes,e?{sessionId:e}:"skip"),X=ne(W.paintingSessions.createSession),v=ne(W.strokes.addStroke),T=ne(W.strokes.clearSession),S=ne(W.strokes.removeLastStroke),w=ne(W.strokes.restoreLastDeletedStroke),h=ne(W.presence.updatePresence),_=ne(W.presence.leaveSession),N=ne(W.liveStrokes.updateLiveStroke),K=ne(W.liveStrokes.clearLiveStroke),H=ne(W.liveStrokes.clearSessionLiveStrokes),B=ne(W.viewerAcks.upsertViewerState),R=ne(W.viewerAcks.removeViewerState),J=ve(W.viewerAcks.getViewerState,e&&s.id?{sessionId:e,viewerId:s.id}:"skip"),c=r.useRef(0);r.useEffect(()=>{!l&&!s.id&&(console.log("🆕 Creating anonymous user:",s.name),m(!0),t({name:s.name}).then(a=>{console.log("✅ User created with ID:",a),o(C=>({...C,id:a})),m(!1)}).catch(a=>{console.error("❌ Failed to create anonymous user:",a),m(!1)}))},[t,s.name,s.id,l]),r.useEffect(()=>{J?.lastAckedStrokeOrder&&(c.current=J.lastAckedStrokeOrder)},[J]),r.useEffect(()=>{if(d&&d.length>0&&e&&s.id){const a=d.reduce((C,A)=>Math.max(C,A.strokeOrder),0);a>c.current&&(c.current=a,B({sessionId:e,viewerId:s.id,lastAckedStrokeOrder:a}))}},[d,e,s.id,B]);const I=r.useCallback(async(a,C=800,A=600)=>await X({name:a,canvasWidth:C,canvasHeight:A,isPublic:!0}),[X]),b=r.useCallback(async(a,C,A,$=1)=>{if(!(!e||!s.id))return await v({sessionId:e,userId:s.id,userColor:s.color,points:a,brushColor:C,brushSize:A,opacity:$})},[e,v,s]),u=r.useCallback(async(a,C,A,$)=>{if(!e||!s.id){console.log("⚠️ Skipping presence update - no session or user ID");return}return await h({sessionId:e,userId:s.id,userColor:s.color,userName:s.name,cursorX:a,cursorY:C,isDrawing:A,currentTool:$})},[e,h,s]),p=r.useCallback(async()=>{e&&await Promise.all([T({sessionId:e}),H({sessionId:e})])},[e,T,H]),U=r.useCallback(async()=>e?await S({sessionId:e}):!1,[e,S]),M=r.useCallback(async()=>e?await w({sessionId:e}):!1,[e,w]),L=r.useRef(null),F=r.useRef(null),Q=r.useRef(0),x=r.useCallback((a,C,A,$=1)=>{if(!e||!s.id)return;const Y=Date.now(),oe=Y-Q.current;if(F.current={points:a,brushColor:C,brushSize:A,opacity:$},a.length===1||oe>=16){Q.current=Y,Ne.logConvex("updateLiveStroke",{pointCount:a.length}),N({sessionId:e,userId:s.id,userColor:s.color,userName:s.name,points:a,brushColor:C,brushSize:A,opacity:$}),F.current=null,L.current&&(clearTimeout(L.current),L.current=null);return}L.current&&clearTimeout(L.current),L.current=setTimeout(()=>{const se=F.current;se&&(Q.current=Date.now(),Ne.logConvex("updateLiveStroke (throttled)",{pointCount:se.points.length}),N({sessionId:e,userId:s.id,userColor:s.color,userName:s.name,points:se.points,brushColor:se.brushColor,brushSize:se.brushSize,opacity:se.opacity}),F.current=null),L.current=null},16)},[e,N,s]),O=r.useCallback(async()=>{if(!(!e||!s.id))return await K({sessionId:e,userId:s.id})},[e,s.id,K]);r.useEffect(()=>{const a=e,C=s.id;return s.name,()=>{a&&C&&(_({sessionId:a,userId:C}),R({sessionId:a,viewerId:C})),L.current&&clearTimeout(L.current)}},[e,_,R,s.id,s.name]);const V=r.useMemo(()=>d||[],[d]);return{session:k,strokes:V,presence:E||[],liveStrokes:q||[],currentUser:s,createNewSession:I,addStrokeToSession:b,updateUserPresence:u,clearSession:p,undoLastStroke:U,redoLastStroke:M,updateLiveStrokeForUser:x,clearLiveStrokeForUser:O,isLoading:k===void 0||l||!s.id}}const Zt={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}],dataChannelOptions:{ordered:!1,maxRetransmits:0,protocol:"paint-preview"},maxPeersForMesh:4,sfuUrl:void 0,turnUrl:void 0,turnUsername:void 0,turnCredential:void 0};function Jt(){const e={...Zt};if(typeof window<"u"){const t=window.__ENV__||{};t.VITE_SFU_URL&&(e.sfuUrl=t.VITE_SFU_URL),t.VITE_TURN_URL&&(e.turnUrl=t.VITE_TURN_URL,e.turnUsername=t.VITE_TURN_USERNAME,e.turnCredential=t.VITE_TURN_CREDENTIAL,e.iceServers.push({urls:e.turnUrl,username:e.turnUsername,credential:e.turnCredential}))}return e}function en(e){const t=new ArrayBuffer(22),s=new DataView(t);s.setUint8(0,e.t.charCodeAt(0)),s.setUint8(1,e.t.charCodeAt(1));const o=e.id.substring(0,8);for(let l=0;l<8;l++)s.setUint8(2+l,o.charCodeAt(l)||0);return s.setFloat32(10,e.x,!0),s.setFloat32(14,e.y,!0),s.setFloat32(18,e.p,!0),t}function tn(e){if(e.byteLength!==22)return console.error("Invalid packet size:",e.byteLength),null;const t=new DataView(e),s=String.fromCharCode(t.getUint8(0),t.getUint8(1));if(s!=="pt")return console.error("Invalid packet type:",s),null;let o="";for(let d=0;d<8;d++)o+=String.fromCharCode(t.getUint8(2+d));const l=t.getFloat32(10,!0),m=t.getFloat32(14,!0),k=t.getFloat32(18,!0);return{t:"pt",id:o,x:l,y:m,p:k}}function nn(e){const t=new ArrayBuffer(11),s=new DataView(t);return s.setUint8(0,e.t.charCodeAt(0)),s.setUint8(1,e.t.charCodeAt(1)),s.setFloat32(2,e.x,!0),s.setFloat32(6,e.y,!0),s.setUint8(10,e.drawing?1:0),t}function sn(e){if(e.byteLength!==11)return null;const t=new DataView(e);return String.fromCharCode(t.getUint8(0),t.getUint8(1))!=="cu"?null:{t:"cu",x:t.getFloat32(2,!0),y:t.getFloat32(6,!0),drawing:t.getUint8(10)===1}}function rn(e){return e.byteLength===22?tn(e):e.byteLength===11?sn(e):null}class an{config;peers=new Map;mode="mesh";convexClient;sessionId;peerId;roomKey;pollingInterval=null;metrics={latency:0,packetsSent:0,packetsReceived:0,bytesTransferred:0,connectedPeers:0};onPacketReceived;onPeerConnected;onPeerDisconnected;onModeChanged;constructor(t){this.config=Jt(),this.convexClient=t.convexClient,this.sessionId=t.sessionId,this.peerId=t.peerId,this.roomKey=t.roomKey,this.onPacketReceived=t.onPacketReceived,this.onPeerConnected=t.onPeerConnected,this.onPeerDisconnected=t.onPeerDisconnected,this.onModeChanged=t.onModeChanged,console.log("P2PManager created with peerId:",this.peerId)}async init(){try{console.log("🚀 P2P: Initializing...",{sessionId:this.sessionId,peerId:this.peerId});const{peers:t,mode:s}=await this.convexClient.mutation(W.webrtc.joinP2PSession,{sessionId:this.sessionId,peerId:this.peerId,roomKey:this.roomKey});console.log("🔍 P2P: Found peers:",t.length,"Mode:",s),this.mode=s,this.onModeChanged?.(s);for(const o of t)console.log("🤝 P2P: Connecting to peer:",o),await this.connectToPeer(o);this.startSignalPolling(),console.log("✅ P2P: Initialization complete")}catch(t){throw console.error("❌ P2P: Failed to initialize:",t),t}}async connectToPeer(t){if(this.peers.has(t))return;const s=new RTCPeerConnection({iceServers:this.config.iceServers}),o={peerId:t,connection:s,dataChannel:null,isConnected:!1};this.peers.set(t,o),s.onicecandidate=async k=>{k.candidate&&await this.sendSignal(t,"ice-candidate",{candidate:k.candidate.candidate,sdpMid:k.candidate.sdpMid,sdpMLineIndex:k.candidate.sdpMLineIndex,usernameFragment:k.candidate.usernameFragment})};const l=s.createDataChannel("paint-preview",this.config.dataChannelOptions);this.setupDataChannel(l,o);const m=await s.createOffer();await s.setLocalDescription(m),await this.sendSignal(t,"offer",{type:m.type,sdp:m.sdp})}setupDataChannel(t,s){s.dataChannel=t,t.onopen=()=>{console.log("✅ P2P: Data channel opened with peer:",s.peerId),s.isConnected=!0,this.metrics.connectedPeers++,this.onPeerConnected?.(s.peerId),Ne.logP2P("peerConnected",{peerId:s.peerId})},t.onclose=()=>{s.isConnected=!1,this.metrics.connectedPeers--,this.onPeerDisconnected?.(s.peerId)},t.onmessage=o=>{this.handleDataChannelMessage(s.peerId,o.data)},t.onerror=o=>{console.error(`Data channel error with peer ${s.peerId}:`,o)}}handleDataChannelMessage(t,s){if(s instanceof ArrayBuffer){const o=rn(s);o?(this.metrics.packetsReceived++,this.metrics.bytesTransferred+=s.byteLength,o.t==="pt"?(console.log("📥 P2P: Received stroke packet",{from:t,strokeId:o.id,x:o.x,y:o.y,pressure:o.p}),Ne.logP2P("receivePacket",{from:t,strokeId:o.id})):o.t,this.onPacketReceived?.(t,o)):console.error("❌ P2P: Failed to decode packet from",t)}}async sendSignal(t,s,o){await this.convexClient.mutation(W.webrtc.sendSignal,{sessionId:this.sessionId,fromPeerId:this.peerId,toPeerId:t,type:s,data:o})}startSignalPolling(){this.pollingInterval=setInterval(async()=>{try{const t=await this.convexClient.query(W.webrtc.getSignals,{sessionId:this.sessionId,peerId:this.peerId});if(t.length>0){console.log(`📨 P2P: Received ${t.length} signals`);for(const o of t)await this.handleSignal(o);const s=t.map(o=>o.id);await this.convexClient.mutation(W.webrtc.deleteSignals,{signalIds:s})}}catch(t){console.error("Signal polling error:",t)}},1e3)}async handleSignal(t){let s=this.peers.get(t.fromPeerId);if(t.type==="offer"){if(!s){const l=new RTCPeerConnection({iceServers:this.config.iceServers});s={peerId:t.fromPeerId,connection:l,dataChannel:null,isConnected:!1},this.peers.set(t.fromPeerId,s),l.onicecandidate=async m=>{m.candidate&&await this.sendSignal(t.fromPeerId,"ice-candidate",{candidate:m.candidate.candidate,sdpMid:m.candidate.sdpMid,sdpMLineIndex:m.candidate.sdpMLineIndex,usernameFragment:m.candidate.usernameFragment})},l.ondatachannel=m=>{this.setupDataChannel(m.channel,s)}}await s.connection.setRemoteDescription(new RTCSessionDescription(t.data));const o=await s.connection.createAnswer();await s.connection.setLocalDescription(o),await this.sendSignal(t.fromPeerId,"answer",{type:o.type,sdp:o.sdp})}else if(t.type==="answer"&&s)await s.connection.setRemoteDescription(new RTCSessionDescription(t.data));else if(t.type==="ice-candidate"&&s){const o=new RTCIceCandidate(t.data);await s.connection.addIceCandidate(o)}}sendPacket(t){const s=en(t);let o=0;for(const l of this.peers.values())if(l.isConnected&&l.dataChannel?.readyState==="open")try{l.dataChannel.send(s),this.metrics.packetsSent++,this.metrics.bytesTransferred+=s.byteLength,o++}catch(m){console.error(`Failed to send packet to peer ${l.peerId}:`,m)}o>0&&Ne.logP2P("sendPacket",{strokeId:t.id,peers:o})}sendCursorPacket(t){const s=nn(t);for(const o of this.peers.values())if(o.isConnected&&o.dataChannel?.readyState==="open")try{o.dataChannel.send(s)}catch{}}getMetrics(){return{...this.metrics}}async destroy(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null);for(const t of this.peers.values())t.dataChannel&&t.dataChannel.close(),t.connection.close();this.peers.clear();try{await this.convexClient.mutation(W.webrtc.leaveP2PSession,{sessionId:this.sessionId,peerId:this.peerId})}catch(t){console.error("Error leaving P2P session:",t)}}}function Be({sessionId:e,userId:t,enabled:s=!0,presence:o=[]}){const l=et(),m=r.useRef(null),[k,d]=r.useState(!1),[E,q]=r.useState("fallback"),[X,v]=r.useState(new Map),[T,S]=r.useState(new Map),[w,h]=r.useState(null),_=r.useRef(null),N=r.useCallback((c,I)=>{if(I.t==="cu"){S(b=>{const u=new Map(b);return u.set(c,{x:I.x,y:I.y,drawing:I.drawing}),u});return}console.log("🎨 P2P: Processing remote stroke",{peerId:c,strokeId:I.id}),v(b=>{const u=new Map(b),p=`${c}:${I.id}`,U=u.get(p);if(U)U.points.push({x:I.x,y:I.y,pressure:I.p}),U.lastUpdate=Date.now(),console.log("🔄 P2P: Updated stroke",p,"points:",U.points.length);else{const M={peerId:c,strokeId:I.id,points:[{x:I.x,y:I.y,pressure:I.p}],color:o.find(L=>L.userName===c)?.userColor||"#FF0000",size:20,lastUpdate:Date.now()};u.set(p,M),console.log("✨ P2P: Created new stroke",p)}return console.log("📋 P2P: Total remote strokes:",u.size),u})},[]),K=r.useCallback(c=>{console.log(`Peer connected: ${c}`),d(!0)},[]),H=r.useCallback(c=>{console.log(`Peer disconnected: ${c}`),v(I=>{const b=new Map(I);for(const[u]of b)u.startsWith(`${c}:`)&&b.delete(u);return b})},[]);r.useEffect(()=>{if(console.log("🔍 P2P Hook - Enabled:",s,"SessionId:",e,"UserId:",t),!s||!e||!t){console.log("⚠️ P2P Hook - Skipping initialization:",{enabled:s,hasSession:!!e,hasUserId:!!t});return}const c=`session-${e}`,I=new an({sessionId:e,peerId:t,roomKey:c,convexClient:l,onPacketReceived:N,onPeerConnected:K,onPeerDisconnected:H,onModeChanged:q});return m.current=I,I.init().catch(b=>{console.error("Failed to initialize P2P:",b),d(!1)}),_.current=setInterval(()=>{m.current&&h(m.current.getMetrics())},1e3),()=>{_.current&&clearInterval(_.current),I.destroy(),m.current=null,d(!1),v(new Map),S(new Map)}},[s,e,t,l,N,K,H]),r.useEffect(()=>{const c=setInterval(()=>{const I=Date.now();v(b=>{const u=new Map(b);let p=!1;for(const[U,M]of u)I-M.lastUpdate>5e3&&(u.delete(U),p=!0);return p?u:b})},1e3);return()=>clearInterval(c)},[]);const B=r.useCallback((c,I,b,u)=>{if(!m.current||!k)return;const p={t:"pt",id:c.substring(0,8),x:I,y:b,p:u};m.current.sendPacket(p)},[k]),R=r.useCallback((c,I,b)=>{if(!m.current||!k)return;const u={t:"cu",x:c,y:I,drawing:b};m.current.sendCursorPacket(u)},[k]),J=r.useCallback((c,I)=>{v(b=>{const u=new Map(b);return u.delete(`${c}:${I}`),u})},[]);return{isConnected:k,connectionMode:E,remoteStrokes:X,remoteCursors:T,sendStrokePoint:B,sendCursorPosition:R,clearRemoteStroke:J,metrics:w}}function qe(e){const t=ve(W.images.getSessionImages,e?{sessionId:e}:"skip"),s=ne(W.images.updateImageTransform),o=ne(W.images.updateImageLayerOrder),l=ne(W.images.deleteImage),m=r.useCallback(async(T,S,w)=>{await s({imageId:T,x:S,y:w})},[s]),k=r.useCallback(async(T,S)=>{await s({imageId:T,scale:S})},[s]),d=r.useCallback(async(T,S)=>{await s({imageId:T,rotation:S})},[s]),E=r.useCallback(async(T,S)=>{await s({imageId:T,opacity:S})},[s]),q=r.useCallback(async(T,S)=>{await s({imageId:T,...S})},[s]),X=r.useCallback(async(T,S)=>{await o({imageId:T,newLayerOrder:S})},[o]),v=r.useCallback(async T=>{await l({imageId:T})},[l]);return{images:t||[],isLoading:t===void 0,moveImage:m,scaleImage:k,rotateImage:d,setImageOpacity:E,updateImageTransform:q,changeLayerOrder:X,deleteImage:v}}const Ie=(e,t)=>(e+t)/2;function on(e,t=!0){const s=e.length;if(s<4)return"";let o=e[0],l=e[1];const m=e[2];let k=`M${o[0].toFixed(2)},${o[1].toFixed(2)} Q${l[0].toFixed(2)},${l[1].toFixed(2)} ${Ie(l[0],m[0]).toFixed(2)},${Ie(l[1],m[1]).toFixed(2)} T`;for(let d=2,E=s-1;d<E;d++)o=e[d],l=e[d+1],k+=`${Ie(o[0],l[0]).toFixed(2)},${Ie(o[1],l[1]).toFixed(2)} `;return t&&(k+="Z"),k}const Ke=r.forwardRef(({sessionId:e,color:t,size:s,opacity:o,onStrokeEnd:l,smoothing:m=.75,thinning:k=.5,streamline:d=.65,easing:E=w=>w,startTaper:q=0,startCap:X=!0,endTaper:v=0,endCap:T=!0},S)=>{const w=r.useRef(null),h=r.useRef(null),_=r.useRef(null),[N,K]=r.useState(!1),[H,B]=r.useState([]),[R,J]=r.useState(null),[c,I]=r.useState(null),[b,u]=r.useState(null),[p,U]=r.useState(0),[M,L]=r.useState(new Map),F=r.useRef(!1),Q=r.useRef(new Map),{strokes:x,presence:O,liveStrokes:V,currentUser:a,addStrokeToSession:C,updateUserPresence:A}=We(e),{images:$}=qe(e);Z.useEffect(()=>{console.log("Canvas - Images in session:",$.length,$)},[$]);const{isConnected:Y,connectionMode:oe,remoteStrokes:se,remoteCursors:fe,sendStrokePoint:xe,sendCursorPosition:de}=Be({sessionId:e,userId:a.id?a.id.toString():a.name,enabled:!!a.id,presence:O}),[ie,pe]=r.useState(null);r.useEffect(()=>{x.length>0&&L(i=>{const g=new Map(i);return x.forEach(f=>{for(const[P,y]of g)if(y.points.length===f.points.length&&y.color===f.brushColor&&y.size===f.brushSize){const z=Math.abs(y.points[0].x-f.points[0].x)<1&&Math.abs(y.points[0].y-f.points[0].y)<1,D=y.points.length-1,ee=Math.abs(y.points[D].x-f.points[D].x)<1&&Math.abs(y.points[D].y-f.points[D].y)<1;if(z&&ee){g.delete(P);break}}}),g})},[x]),r.useEffect(()=>{const i=setInterval(()=>{L(g=>{const f=new Map(g);for(const[P]of f)if(f.size>5){f.delete(P);break}return f})},5e3);return()=>clearInterval(i)},[]);const re=(i,g)=>{if(g.points.length===0)return;const f={size:g.size,smoothing:m,thinning:k,streamline:d,easing:E,start:{taper:q,cap:X},end:{taper:v,cap:T},last:!g.isLive},P=Kt(g.points,f),y=on(P);if(y==="")return;i.fillStyle=g.color,i.globalAlpha=g.opacity!==void 0?g.opacity:o;const z=new Path2D(y);i.fill(z),i.globalAlpha=1},we=r.useCallback(()=>{!R||!w.current||(R.clearRect(0,0,w.current.width,w.current.height),x.sort((i,g)=>i.strokeOrder-g.strokeOrder).forEach(i=>{re(R,{points:i.points,color:i.brushColor,size:i.brushSize})}),M.forEach(i=>{re(R,i)}))},[R,x,M,m,k,d,E,q,X,v,T,o,re]),be=r.useCallback(async()=>{if(!(!b||!_.current)){console.log("Redrawing image canvas with",$.length,"images"),console.log("Images details:",$.map(i=>({id:i._id,type:i.type,url:i.url?.substring(0,50)+"...",opacity:i.opacity,x:i.x,y:i.y,width:i.width,height:i.height,scale:i.scale}))),b.clearRect(0,0,_.current.width,_.current.height);for(const i of $){if(!i.url){console.log("Image missing URL:",i._id);continue}console.log("Drawing image:",i._id,"type:",i.type,"at",i.x,i.y,"scale:",i.scale,"opacity:",i.opacity);let g=Q.current.get(i._id);if(!g){console.log("Loading image from URL:",i.url),g=new Image,g.crossOrigin="anonymous";try{await new Promise((f,P)=>{g.onload=()=>{console.log("Image loaded successfully:",i._id),Q.current.set(i._id,g),f()},g.onerror=y=>{console.error("Failed to load image:",i._id,y),P(y)},g.src=i.url})}catch(f){console.error("Error loading image:",f);continue}}b.save(),b.globalAlpha=i.opacity,b.translate(i.x+i.width*i.scale/2,i.y+i.height*i.scale/2),b.rotate(i.rotation*Math.PI/180),b.scale(i.scale,i.scale),b.drawImage(g,-i.width/2,-i.height/2,i.width,i.height),b.restore(),console.log("Image drawn successfully:",i._id)}}},[b,$]);r.useEffect(()=>{const i=w.current,g=h.current,f=_.current;if(!i||!g||!f)return;const P=i.getContext("2d"),y=g.getContext("2d"),z=f.getContext("2d");if(!P||!y||!z)return;const D=i.parentElement;if(D){const{clientWidth:ee,clientHeight:ae}=D;i.width=ee,i.height=ae,g.width=ee,g.height=ae,f.width=ee,f.height=ae}J(P),I(y),u(z)},[]),r.useEffect(()=>{const i=()=>{const g=w.current,f=h.current,P=_.current;if(!g||!f||!P)return;const y=g.parentElement;if(y){const{clientWidth:z,clientHeight:D}=y;g.width=z,g.height=D,f.width=z,f.height=D,P.width=z,P.height=D,be(),we()}};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[we,be]),r.useEffect(()=>{we()},[x,we]),r.useEffect(()=>{be()},[$,be]);const Ce=r.useCallback(()=>{if(!c||!h.current)return;const i=h.current.width,g=h.current.height;Y&&fe.forEach((f,P)=>{const y=f.x*i,z=f.y*g,D=O.find(le=>le.userName===P||le.userId?.toString()===P)?.userColor||"#666666";c.fillStyle=D,c.beginPath(),c.arc(y,z,f.drawing?8:5,0,2*Math.PI),c.fill(),c.strokeStyle=f.drawing?"#000000":"#FFFFFF",c.lineWidth=f.drawing?2:1,c.stroke(),c.fillStyle="white",c.strokeStyle=D,c.lineWidth=3,c.font="bold 11px Arial";const ee=O.find(le=>le.userName===P||le.userId?.toString()===P)?.userName||P.substring(0,8),ae=c.measureText(ee).width;c.strokeText(ee,y-ae/2,z-15),c.fillText(ee,y-ae/2,z-15)})},[c,O,a.name,Y,fe]);r.useEffect(()=>{if(!N)return;const i=()=>{F.current||(F.current=!0,K(g=>(g&&B(f=>{if(f.length>0){const P=crypto.randomUUID(),y={points:f,color:t,size:s,opacity:o,id:P,isPending:!0};L(z=>new Map(z).set(P,y)),C(f,t,s,o),R&&re(R,y)}return l?.(),c&&h.current&&c.clearRect(0,0,h.current.width,h.current.height),[]}),!1)))};return document.addEventListener("pointerup",i),()=>document.removeEventListener("pointerup",i)},[N,t,s,o,C,l,R,c]),r.useEffect(()=>{if(!(!c||!h.current)){if(c.clearRect(0,0,h.current.width,h.current.height),N&&H.length>0&&re(c,{points:H,color:t,size:s,opacity:o,isLive:!0}),Y&&h.current){const i=h.current.width,g=h.current.height;se.forEach(f=>{if(f.points.length>0){const P=f.points.map(y=>({x:y.x*i,y:y.y*g,pressure:y.pressure}));re(c,{points:P,color:f.color,size:f.size,opacity:.8,isLive:!0})}})}Ce()}},[c,H,N,t,s,o,V,a.name,Ce,Y,oe,se]);const he=i=>{const g=h.current,f=g?.getBoundingClientRect();if(!f||!g)return{x:0,y:0};const P=g.width/f.width,y=g.height/f.height;return{x:(i.clientX-f.left)*P,y:(i.clientY-f.top)*y,pressure:i.pressure}},Me=i=>{if(!c||!h.current)return;i.currentTarget.setPointerCapture(i.pointerId),K(!0),F.current=!1,c.clearRect(0,0,h.current.width,h.current.height);const g=he(i);B([g]),A(g.x,g.y,!0,"brush");const f=crypto.randomUUID();if(pe(f),Y&&h.current){const P=g.x/h.current.width,y=g.y/h.current.height;xe(f,P,y,g.pressure||.5)}},Le=i=>{if(!N||!c||!h.current){const D=he(i);if(Y&&h.current){const ee=D.x/h.current.width,ae=D.y/h.current.height;de(ee,ae,!1)}A(D.x,D.y,!1,"brush");return}const g=i.nativeEvent,P=(g.getCoalescedEvents?.()??[g]).map(D=>he({clientX:D.clientX,clientY:D.clientY,pressure:D.pressure,currentTarget:i.currentTarget,target:D.target}));if(P.length===0)return;const y=P[P.length-1];if(Y&&h.current){const D=y.x/h.current.width,ee=y.y/h.current.height;de(D,ee,!0)}A(y.x,y.y,N,"brush");const z=[...H,...P];B(z),Y&&ie&&h.current&&P.forEach(D=>{const ee=D.x/h.current.width,ae=D.y/h.current.height;xe(ie,ee,ae,D.pressure||.5)}),c.clearRect(0,0,h.current.width,h.current.height),re(c,{points:z,color:t,size:s,opacity:o,isLive:!0}),Ce()},Re=i=>{if(!N||!c||!h.current||F.current)return;F.current=!0,i.currentTarget.releasePointerCapture(i.pointerId),K(!1),c.clearRect(0,0,h.current.width,h.current.height);const g=he(i),f=[...H,g];if(f.length>0){const P=crypto.randomUUID(),y={points:f,color:t,size:s,opacity:o,id:P,isPending:!0};L(z=>new Map(z).set(P,y)),C(f,t,s,o),pe(null),R&&re(R,y)}B([]),pe(null),l?.()},Ue=i=>{if(!N||F.current)return;F.current=!0,i.currentTarget.releasePointerCapture(i.pointerId),K(!1),c&&h.current&&c.clearRect(0,0,h.current.width,h.current.height);const g=he(i),f=[...H,g];if(f.length>0){const P=crypto.randomUUID(),y={points:f,color:t,size:s,opacity:o,id:P,isPending:!0};L(z=>new Map(z).set(P,y)),C(f,t,s,o),R&&re(R,y)}B([]),pe(null),l?.()};return r.useImperativeHandle(S,()=>({clear:()=>{R&&w.current&&R.clearRect(0,0,w.current.width,w.current.height),c&&h.current&&c.clearRect(0,0,h.current.width,h.current.height),b&&_.current&&b.clearRect(0,0,_.current.width,_.current.height),L(new Map)},undo:()=>{console.warn("Canvas.undo() is deprecated. Use session-level undo instead.")},getImageData:()=>{if(console.log("[Canvas] getImageData called"),console.log("[Canvas] Main canvas exists:",!!w.current),console.log("[Canvas] Image canvas exists:",!!_.current),console.log("[Canvas] Number of images:",$.length),console.log("[Canvas] Number of strokes:",x.length),console.log("[Canvas] Pending strokes:",M.size),!w.current)return console.log("[Canvas] ERROR: Main canvas ref is null!"),"";console.log("[Canvas] Main canvas dimensions:",w.current.width,"x",w.current.height);const i=document.createElement("canvas");i.width=w.current.width,i.height=w.current.height;const g=i.getContext("2d");if(!g)return console.log("[Canvas] Failed to get temp context"),w.current.toDataURL("image/png");g.fillStyle="white",g.fillRect(0,0,i.width,i.height),g.drawImage(w.current,0,0),console.log("[Canvas] Drew strokes layer"),_.current&&(g.drawImage(_.current,0,0),console.log("[Canvas] Drew image layer (AI images) on top"));const P=g.getImageData(0,0,i.width,i.height).data;let y=!1;for(let D=0;D<P.length;D+=4)if(P[D]!==255||P[D+1]!==255||P[D+2]!==255){y=!0;break}console.log("[Canvas] Canvas has content:",y);let z=i.toDataURL("image/png");if(console.log("[Canvas] Initial data URL length:",z.length),z.length>8e5){console.log("[Canvas] Data URL too large, resizing...");const D=Math.sqrt(8e5/z.length),ee=Math.floor(i.width*D),ae=Math.floor(i.height*D);console.log("[Canvas] Resizing from",i.width,"x",i.height,"to",ee,"x",ae);const le=document.createElement("canvas");le.width=ee,le.height=ae;const j=le.getContext("2d");if(j){j.drawImage(i,0,0,ee,ae);let G=.9;for(z=le.toDataURL("image/jpeg",G);z.length>8e5&&G>.1;)G-=.1,z=le.toDataURL("image/jpeg",G),console.log("[Canvas] Trying quality:",G,"size:",z.length)}}return console.log("[Canvas] Final data URL length:",z.length),console.log("[Canvas] First 100 chars of dataUrl:",z.substring(0,100)),z},getDimensions:()=>({width:w.current?.width||800,height:w.current?.height||600})}),[R,c,b]),n.jsxs(n.Fragment,{children:[n.jsx("canvas",{ref:w,className:"absolute inset-0 w-full h-full border border-gray-300",style:{zIndex:0}}),n.jsx("canvas",{ref:_,className:"absolute inset-0 w-full h-full",style:{zIndex:1}}),n.jsx("canvas",{ref:h,className:"absolute inset-0 w-full h-full",onPointerDown:Me,onPointerMove:Le,onPointerUp:Re,onPointerLeave:Ue,style:{touchAction:"none",zIndex:2}})]})});Ke.displayName="Canvas";const Ee=[{id:"brush",icon:vt,label:"Brush",ariaLabel:"Select brush tool",keyboardShortcut:"B"},{id:"upload",icon:xt,label:"Upload",ariaLabel:"Upload image",keyboardShortcut:"U"},{id:"ai",icon:De,label:"AI",ariaLabel:"AI Generation",keyboardShortcut:"G"},{id:"inpaint",icon:Xe,label:"Inpaint",ariaLabel:"Inpaint tool",keyboardShortcut:"I"}],Te=Z.memo(({value:e,min:t,max:s,onChange:o,icon:l,label:m,color:k})=>{const d=(e-t)/(s-t)*100;return n.jsxs("div",{className:"flex items-center gap-2 mb-3",role:"group","aria-labelledby":`${m.toLowerCase()}-slider-label`,children:[n.jsx(l,{className:"w-4 h-4 text-white/60 flex-shrink-0","aria-hidden":"true"}),n.jsxs("div",{className:"relative flex-1 h-6 flex items-center",children:[n.jsx("div",{className:"h-1 w-full bg-white/20 rounded-full overflow-hidden",role:"presentation",children:n.jsx("div",{className:"h-full transition-all duration-100",style:{width:`${d}%`,backgroundColor:k}})}),n.jsx("div",{className:"absolute top-1/2 -translate-y-1/2 w-3 h-3 rounded-full pointer-events-none",style:{left:`calc(${d}% - 6px)`,backgroundColor:k},role:"presentation"}),n.jsx("input",{type:"range",min:t,max:s,value:e,onChange:E=>o(Number(E.target.value)),className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer","aria-valuemin":t,"aria-valuemax":s,"aria-valuenow":e,"aria-labelledby":`${m.toLowerCase()}-slider-label`}),n.jsxs("span",{id:`${m.toLowerCase()}-slider-label`,className:"sr-only",children:[m," slider"]})]})]})});Te.displayName="Slider";const Qe=Z.memo(({tool:e,isSelected:t,onClick:s})=>n.jsx("button",{onClick:s,className:`w-8 h-8 flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-1 focus-visible:ring-blue-400 ${t?"bg-blue-500 text-white":"bg-white/10 text-white hover:bg-white/20"}`,title:`${e.label}${e.keyboardShortcut?` (${e.keyboardShortcut})`:""}`,"aria-label":e.ariaLabel,"aria-pressed":t,children:n.jsx(e.icon,{className:`w-4 h-4 ${t?"scale-110 transition-transform":""}`})},e.id));Qe.displayName="ToolButton";const je=Z.memo(({icon:e,label:t,onClick:s,isPrimary:o=!1})=>n.jsx("button",{onClick:s,className:`w-8 h-8 flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-1 focus-visible:ring-blue-400 ${o?"bg-blue-500 text-white hover:bg-blue-600":"bg-white/10 text-white hover:bg-white/20"}`,title:t,"aria-label":t,children:n.jsx(e,{className:"w-4 h-4"})}));je.displayName="ActionButton";const Ze=Z.memo(({color:e,onColorChange:t})=>{const s=o=>{t(o.target.value)};return n.jsxs("div",{className:"flex items-center gap-2 mb-3",role:"group","aria-labelledby":"color-mixer-label",children:[n.jsx(St,{className:"w-4 h-4 text-white/60 flex-shrink-0","aria-hidden":"true"}),n.jsxs("div",{className:"flex-1 relative",children:[n.jsx("div",{className:"w-full h-6 border border-white/20 rounded transition-all duration-100 hover:border-blue-400",style:{backgroundColor:e},title:"Click to change color",children:n.jsxs("span",{className:"sr-only",children:["Current color: ",e]})}),n.jsx("input",{type:"color",value:e,onChange:s,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer","aria-label":"Color picker"})]}),n.jsx("span",{id:"color-mixer-label",className:"sr-only",children:"Color mixer"})]})});Ze.displayName="ColorMixer";function ln({color:e,size:t,opacity:s,onColorChange:o,onSizeChange:l,onOpacityChange:m,onUndo:k,onRedo:d,onClear:E,onExport:q,onImageUpload:X,onAIGenerate:v,selectedTool:T,onToolChange:S}){const[w,h]=Z.useState("brush"),_=T||w,[N,K]=Z.useState(!1),[H,B]=Z.useState(!1),[R,J]=Z.useState({x:0,y:0}),[c,I]=Z.useState(!1),[b,u]=Z.useState({x:24,y:200}),[p,U]=Z.useState({x:0,y:0}),M=Z.useRef(null),L=Z.useRef(null);Z.useEffect(()=>{typeof window<"u"&&u({x:24,y:window.innerHeight/2-150})},[]);const F=Z.useCallback(a=>{a.preventDefault(),I(!0);const C="touches"in a?a.touches[0].clientX:a.clientX,A="touches"in a?a.touches[0].clientY:a.clientY;if(M.current){const $=M.current.getBoundingClientRect();U({x:C-$.left,y:A-$.top})}},[]),Q=Z.useCallback(a=>{if(!c)return;const C="touches"in a?a.touches[0].clientX:a.clientX,A="touches"in a?a.touches[0].clientY:a.clientY,$=C-p.x,Y=A-p.y,oe=window.innerWidth-(M.current?.offsetWidth||200),se=window.innerHeight-(M.current?.offsetHeight||300);u({x:Math.max(0,Math.min($,oe)),y:Math.max(0,Math.min(Y,se))})},[c,p]),x=Z.useCallback(()=>{I(!1)},[]);Z.useEffect(()=>{if(c){const a=Y=>Q(Y),C=()=>x(),A=Y=>Q(Y),$=()=>x();return document.addEventListener("mousemove",a),document.addEventListener("mouseup",C),document.addEventListener("touchmove",A,{passive:!1}),document.addEventListener("touchend",$),()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",C),document.removeEventListener("touchmove",A),document.removeEventListener("touchend",$)}}},[c,Q,x]),Z.useEffect(()=>{const a=()=>{const C=window.innerWidth-(M.current?.offsetWidth||200),A=window.innerHeight-(M.current?.offsetHeight||300);u($=>({x:Math.max(0,Math.min($.x,C)),y:Math.max(0,Math.min($.y,A))}))};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);const O=Z.useCallback(a=>{if(a==="upload"&&X){X();return}if(a==="ai"&&v){v();return}S?S(a):h(a)},[S,X,v]);Z.useEffect(()=>{const a=C=>{if(C.target instanceof HTMLInputElement||C.target instanceof HTMLTextAreaElement)return;const A=C.key.toUpperCase(),$=Ee.find(Y=>Y.keyboardShortcut===A);$&&O($.id)};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[O]);const V=Z.useCallback(a=>{a.stopPropagation();const C=a.currentTarget.getBoundingClientRect();J({x:C.right-C.left,y:C.bottom-C.top}),B(!H)},[H]);return Z.useEffect(()=>{const a=C=>{L.current&&!L.current.contains(C.target)&&B(!1)};if(H)return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[H]),n.jsxs("div",{ref:M,className:"fixed z-50 select-none",style:{left:`${b.x}px`,top:`${b.y}px`,transition:c?"none":"transform 0.15s ease-out"},role:"toolbar","aria-label":"wepaint.ai tools",children:[n.jsxs("div",{className:"bg-black/90 backdrop-blur-md border border-white/20 overflow-hidden",style:{width:"180px"},children:[n.jsxs("div",{className:`flex items-center justify-between px-2 py-1.5 border-b border-white/20 ${c?"cursor-grabbing":"cursor-grab"}`,onMouseDown:F,onTouchStart:F,"aria-label":"Drag to move panel",role:"button",children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"text-xs font-medium text-white/80",children:"wepaint.ai"}),n.jsx("button",{onClick:V,onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"p-0.5 hover:bg-white/20 rounded transition-colors","aria-label":"More options",children:n.jsx(ut,{className:"w-3.5 h-3.5 text-white/60"})})]}),n.jsx("button",{onClick:a=>{a.stopPropagation(),K(!N)},onMouseDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),className:"p-1 hover:bg-white/20 transition-colors","aria-expanded":!N,"aria-label":N?"Expand tools panel":"Collapse tools panel",children:n.jsx(at,{className:`w-3.5 h-3.5 text-white/60 transition-transform ${N?"":"rotate-180"}`})})]}),!N&&n.jsxs("div",{className:"p-2",children:[n.jsx("div",{className:"grid grid-cols-4 border-b border-white/20 mb-3",children:Ee.map((a,C)=>n.jsx("div",{className:`${C<Ee.length-1?"border-r border-white/20":""}`,children:n.jsx(Qe,{tool:a,isSelected:_===a.id,onClick:()=>O(a.id)})},a.id))}),n.jsx("div",{className:"border-b border-white/20 mb-3 pb-3",children:n.jsx(Ze,{color:e,onColorChange:o})}),n.jsxs("div",{className:"border-b border-white/20 mb-3 pb-3",children:[n.jsx(Te,{value:t,min:1,max:100,onChange:l,icon:it,label:"Brush Size",color:"hsl(var(--primary))"}),n.jsx(Te,{value:s*100,min:0,max:100,onChange:a=>m(a/100),icon:gt,label:"Opacity",color:"hsl(0, 0%, 50%)"})]}),n.jsxs("div",{className:"grid grid-cols-4",children:[n.jsx("div",{className:"border-r border-white/20",children:n.jsx(je,{icon:Ft,label:"Undo",onClick:k})}),n.jsx("div",{className:"border-r border-white/20",children:n.jsx(je,{icon:jt,label:"Redo",onClick:d})}),n.jsx("div",{className:"border-r border-white/20",children:n.jsx(je,{icon:Ae,label:"Clear Canvas",onClick:E})}),n.jsx("div",{children:n.jsx(je,{icon:It,label:"Export",onClick:q})})]})]})]}),H&&n.jsxs("div",{ref:L,className:"absolute bg-black/90 backdrop-blur-md border border-white/20 rounded-md shadow-xl py-1 min-w-[150px]",style:{left:`${R.x}px`,top:`${R.y}px`},children:[n.jsx("button",{className:"w-full px-3 py-1.5 text-left text-sm text-white hover:bg-white/20 transition-colors",onClick:()=>{B(!1),alert("wepaint.ai - Collaborative painting app")},children:"About"}),n.jsx("button",{className:"w-full px-3 py-1.5 text-left text-sm text-white hover:bg-white/20 transition-colors",onClick:()=>{B(!1),window.open("https://github.com/your-repo","_blank")},children:"GitHub"}),n.jsx("div",{className:"border-t border-white/20 my-1"}),n.jsx("button",{className:"w-full px-3 py-1.5 text-left text-sm text-white hover:bg-white/20 transition-colors",onClick:()=>{B(!1)},children:"Settings"}),n.jsx("button",{className:"w-full px-3 py-1.5 text-left text-sm text-white hover:bg-white/20 transition-colors",onClick:()=>{B(!1)},children:"Keyboard Shortcuts"})]})]})}const cn=({size:e,onSizeChange:t,smoothing:s,onSmoothingChange:o,thinning:l,onThinningChange:m,streamline:k,onStreamlineChange:d,startTaper:E,onStartTaperChange:q,startCap:X,onStartCapChange:v,endTaper:T,onEndTaperChange:S,endCap:w,onEndCapChange:h,isVisible:_,onClose:N})=>{const[K,H]=r.useState({x:50,y:50}),[B,R]=r.useState(!1),J=r.useRef({x:0,y:0}),c=r.useRef(null);r.useEffect(()=>{const u=U=>{if(!B||!c.current)return;const M=U.clientX-J.current.x,L=U.clientY-J.current.y;H(F=>({x:F.x+M,y:F.y+L})),J.current={x:U.clientX,y:U.clientY}},p=()=>{R(!1)};return B&&(document.addEventListener("mousemove",u),document.addEventListener("mouseup",p)),()=>{document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",p)}},[B]);const I=u=>{u.target.closest(".admin-panel-header")&&(R(!0),J.current={x:u.clientX,y:u.clientY})},b="block text-xs font-medium text-gray-700 mb-0.5";return _?n.jsxs("div",{ref:c,className:"absolute bg-white p-4 rounded-lg shadow-xl border border-gray-300 w-64 text-sm",style:{top:`${K.y}px`,left:`${K.x}px`,cursor:B?"grabbing":"default",zIndex:1e3},onMouseDown:I,children:[n.jsxs("div",{className:"admin-panel-header flex justify-between items-center mb-3 pb-2 border-b border-gray-200",style:{cursor:"grab"},children:[n.jsx("h3",{className:"text-base font-semibold",children:"Admin Controls"}),n.jsx("button",{onClick:N,className:"text-gray-500 hover:text-gray-700 text-lg",children:"×"})]}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsxs("label",{htmlFor:"size",className:b,children:["Size: ",e.toFixed(2)]}),n.jsx("input",{type:"range",id:"size",min:"1",max:"100",step:"1",value:e,onChange:u=>t(parseFloat(u.target.value)),className:"w-full"})]}),n.jsxs("div",{children:[n.jsxs("label",{htmlFor:"smoothing",className:b,children:["Smoothing: ",s.toFixed(2)]}),n.jsx("input",{type:"range",id:"smoothing",min:"0",max:"1",step:"0.01",value:s,onChange:u=>o(parseFloat(u.target.value)),className:"w-full"})]}),n.jsxs("div",{children:[n.jsxs("label",{htmlFor:"thinning",className:b,children:["Thinning: ",l.toFixed(2)]}),n.jsx("input",{type:"range",id:"thinning",min:"-1",max:"1",step:"0.01",value:l,onChange:u=>m(parseFloat(u.target.value)),className:"w-full"})]}),n.jsxs("div",{children:[n.jsxs("label",{htmlFor:"streamline",className:b,children:["Streamline: ",k.toFixed(2)]}),n.jsx("input",{type:"range",id:"streamline",min:"0",max:"1",step:"0.01",value:k,onChange:u=>d(parseFloat(u.target.value)),className:"w-full"})]}),n.jsxs("div",{children:[n.jsxs("label",{htmlFor:"startTaper",className:b,children:["Start Taper: ",E.toFixed(2)]}),n.jsx("input",{type:"range",id:"startTaper",min:"0",max:"100",step:"1",value:E,onChange:u=>q(parseFloat(u.target.value)),className:"w-full"})]}),n.jsxs("div",{className:"flex items-center",children:[n.jsx("input",{type:"checkbox",id:"startCap",checked:X,onChange:u=>v(u.target.checked),className:"mr-2"}),n.jsx("label",{htmlFor:"startCap",className:b+" mb-0",children:"Start Cap"})]}),n.jsxs("div",{children:[n.jsxs("label",{htmlFor:"endTaper",className:b,children:["End Taper: ",T.toFixed(2)]}),n.jsx("input",{type:"range",id:"endTaper",min:"0",max:"100",step:"1",value:T,onChange:u=>S(parseFloat(u.target.value)),className:"w-full"})]}),n.jsxs("div",{className:"flex items-center",children:[n.jsx("input",{type:"checkbox",id:"endCap",checked:w,onChange:u=>h(u.target.checked),className:"mr-2"}),n.jsx("label",{htmlFor:"endCap",className:b+" mb-0",children:"End Cap"})]})]})]}):null};function dn({sessionId:e,userCount:t,currentUser:s}){const[o,l]=r.useState(!1),m=async()=>{if(!e)return;const k=`${window.location.origin}?session=${e}`;await navigator.clipboard.writeText(k),l(!0),setTimeout(()=>l(!1),2e3)};return e?n.jsxs("div",{className:"absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 max-w-sm",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[n.jsx("div",{className:"w-4 h-4 rounded-full",style:{backgroundColor:s.color}}),n.jsx("span",{className:"font-medium text-sm",children:s.name})]}),n.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[n.jsx(zt,{className:"w-4 h-4 text-gray-500"}),n.jsxs("span",{className:"text-sm text-gray-600",children:[t," user",t!==1?"s":""," online"]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Lt,{className:"w-4 h-4 text-gray-500"}),n.jsxs("button",{onClick:m,className:"flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700 transition-colors",children:[n.jsx(ct,{className:"w-3 h-3"}),o?"Copied!":"Share session"]})]}),n.jsxs("div",{className:"mt-2 text-xs text-gray-500 font-mono bg-gray-50 p-2 rounded",children:["Session: ",e.slice(-8)]})]}):null}function un({isConnected:e,connectionMode:t,metrics:s,className:o=""}){const l=()=>e?t==="mesh"?"bg-green-500":t==="sfu"?"bg-blue-500":"bg-gray-500":"bg-red-500",m=()=>e?t==="mesh"?"P2P Direct":t==="sfu"?"P2P Relay":"P2P Only":"P2P Required";return n.jsxs("div",{className:`flex items-center gap-2 text-sm ${o}`,children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("div",{className:`w-2 h-2 rounded-full ${l()}`}),n.jsx("span",{className:"text-gray-600",children:m()})]}),s&&e&&n.jsxs("div",{className:"flex items-center gap-3 text-xs text-gray-500",children:[n.jsxs("span",{children:["Peers: ",s.connectedPeers]}),n.jsxs("span",{children:["Latency: ",s.latency,"ms"]}),n.jsxs("span",{children:["Sent: ",s.packetsSent]}),n.jsxs("span",{children:["Recv: ",s.packetsReceived]})]})]})}const hn=5*1024*1024,Ge=["image/png","image/jpeg","image/jpg","image/gif","image/webp"];function gn({sessionId:e,userId:t,onImageUploaded:s,onClose:o,canvasWidth:l=800,canvasHeight:m=600}){const k=r.useRef(null),[d,E]=r.useState(!1),[q,X]=r.useState(null),[v,T]=r.useState(null),[S,w]=r.useState(null),[h,_]=r.useState(!1),N=ne(W.images.generateUploadUrl),K=ne(W.images.uploadImage),H=r.useCallback(async p=>{if(console.log("File selected:",p.name,"Type:",p.type,"Size:",p.size),!Ge.includes(p.type)){X("Please select a valid image file (PNG, JPG, GIF, WebP)");return}if(p.size>hn){X("File size must be less than 5MB");return}X(null),T(p);const U=new FileReader;U.onload=M=>w(M.target?.result),U.readAsDataURL(p)},[]),B=r.useCallback(p=>{const U=p.target.files?.[0];U&&H(U)},[H]),R=r.useCallback(p=>{p.preventDefault(),_(!1);const U=p.dataTransfer.files[0];U&&U.type.startsWith("image/")&&H(U)},[H]),J=r.useCallback(p=>{p.preventDefault(),_(!0)},[]),c=r.useCallback(p=>{p.preventDefault(),_(!1)},[]),I=p=>new Promise((U,M)=>{const L=new Image,F=URL.createObjectURL(p);L.onload=()=>{URL.revokeObjectURL(F),U({width:L.width,height:L.height})},L.onerror=()=>{URL.revokeObjectURL(F),M(new Error("Failed to load image"))},L.src=F}),b=async(p,U,M)=>new Promise((L,F)=>{const Q=new Image,x=URL.createObjectURL(p);Q.onload=async()=>{URL.revokeObjectURL(x);const O=l/U,V=m/M,a=Math.min(O,V,1),C=Math.floor(U*a),A=Math.floor(M*a),$=document.createElement("canvas");$.width=C,$.height=A;const Y=$.getContext("2d");if(!Y){F(new Error("Failed to get canvas context"));return}Y.drawImage(Q,0,0,C,A),$.toBlob(oe=>{oe?L({blob:oe,width:C,height:A}):F(new Error("Failed to create blob"))},p.type,.9)},Q.onerror=()=>{URL.revokeObjectURL(x),F(new Error("Failed to load image for resizing"))},Q.src=x}),u=async()=>{if(!(!v||!e)){E(!0),X(null);try{console.log("Getting image dimensions...");const p=await I(v);console.log("Original image dimensions:",p),console.log("Canvas dimensions:",l,"x",m);let U=v,M=p;if(p.width>l||p.height>m){console.log("Image exceeds canvas bounds, resizing...");const a=await b(v,p.width,p.height);U=a.blob,M={width:a.width,height:a.height},console.log("Resized dimensions:",M)}console.log("Generating upload URL...");const L=await N();console.log("Upload URL generated"),console.log("Uploading to Convex storage...");const F=await fetch(L,{method:"POST",headers:{"Content-Type":v.type},body:U});if(!F.ok)throw console.error("Upload response not OK:",F.status,F.statusText),new Error("Failed to upload file");const{storageId:Q}=await F.json();console.log("File uploaded, storage ID:",Q);const x=Math.max(0,(l-M.width)/2),O=Math.max(0,(m-M.height)/2);console.log("Creating image record in database...");const V=await K({sessionId:e,userId:t,storageId:Q,filename:v.name,mimeType:v.type,width:M.width,height:M.height,x,y:O});console.log("Image record created:",V),s?.(V),o()}catch(p){console.error("Upload error:",p),X("Failed to upload image. Please try again.")}finally{E(!1)}}};return Z.useEffect(()=>{const p=U=>{U.key==="Escape"&&!d&&o()};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[o,d]),n.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50",children:n.jsxs("div",{className:"bg-black/90 backdrop-blur-md border border-white/20 p-6 rounded-lg shadow-lg max-w-md w-full mx-4",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h3",{className:"text-lg font-semibold text-white",children:"Upload Image"}),n.jsx("button",{onClick:o,className:"p-1 hover:bg-white/20 rounded-sm transition-colors text-white/70 hover:text-white","aria-label":"Close",children:n.jsx(Ae,{className:"w-4 h-4"})})]}),n.jsx("input",{ref:k,type:"file",accept:Ge.join(","),onChange:B,className:"hidden"}),v?n.jsxs("div",{className:"space-y-4",children:[S&&n.jsx("div",{className:"relative",children:n.jsx("img",{src:S,alt:"Preview",className:"w-full h-48 object-contain rounded bg-white/10"})}),n.jsxs("div",{className:"space-y-1",children:[n.jsx("p",{className:"text-sm font-medium truncate text-white",children:v.name}),n.jsxs("p",{className:"text-xs text-white/60",children:[(v.size/1024/1024).toFixed(2)," MB"]})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx("button",{onClick:u,disabled:d,className:"flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 transition-colors",children:d?"Uploading...":"Upload"}),n.jsx("button",{onClick:()=>{T(null),w(null),X(null)},disabled:d,className:"px-4 py-2 border border-white/20 text-white rounded hover:bg-white/10 transition-colors",children:"Change"})]})]}):n.jsxs("div",{onClick:()=>k.current?.click(),onDrop:R,onDragOver:J,onDragLeave:c,className:`
              w-full p-8 border-2 border-dashed rounded-lg cursor-pointer
              transition-colors duration-200
              ${h?"border-blue-400 bg-blue-400/10":"border-white/20 hover:border-blue-400/50"}
            `,children:[n.jsx(At,{className:"w-8 h-8 mx-auto mb-3 text-white/60"}),n.jsx("p",{className:"text-sm text-center text-white/70",children:"Click to select or drag and drop"}),n.jsx("p",{className:"text-xs text-center text-white/60 mt-2",children:"PNG, JPG, GIF, WebP • Max 5MB"})]}),q&&n.jsx("div",{className:"mt-4 p-3 bg-red-500/20 border border-red-500/40 rounded",children:n.jsx("p",{className:"text-sm text-red-400",children:q})})]})})}function mn({isOpen:e,onClose:t,sessionId:s,canvasDataUrl:o,canvasWidth:l,canvasHeight:m,onGenerationComplete:k}){const[d,E]=r.useState(""),[q,X]=r.useState(.85),[v,T]=r.useState(!1),[S,w]=r.useState(null),h=tt(W.aiGeneration.generateImage),_=async()=>{if(!d.trim()){w("Please enter a prompt");return}T(!0),w(null);try{console.log("Calling generateImage with:",{sessionId:s,prompt:d.trim(),imageDataLength:o.length});const N=await h({sessionId:s,prompt:d.trim(),imageData:o,weight:q,canvasWidth:l,canvasHeight:m});console.log("AI Generation result:",N),console.log("Result type:",typeof N),console.log("Result keys:",N?Object.keys(N):"null"),N.success&&N.imageUrl?(console.log("Generated image URL:",N.imageUrl),k(N.imageUrl),t()):w(N.error||"Generation failed")}catch(N){w("Failed to generate image. Please try again."),console.error("AI generation error:",N)}finally{T(!1)}};return e?n.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[n.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:t}),n.jsxs("div",{className:"relative bg-black/90 backdrop-blur-md border border-white/20 rounded-lg shadow-xl max-w-md w-full mx-4 p-6",children:[n.jsx("button",{onClick:t,className:"absolute top-4 right-4 text-white/70 hover:text-white transition-colors",disabled:v,children:n.jsx(Ae,{className:"w-5 h-5"})}),n.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[n.jsx(De,{className:"w-5 h-5 text-blue-400"}),n.jsx("h2",{className:"text-lg font-semibold text-white",children:"AI Generation"})]}),n.jsxs("div",{className:"mb-4",children:[n.jsx("p",{className:"text-sm text-white/70 mb-2",children:"Current canvas:"}),n.jsx("div",{className:"relative w-full h-32 bg-white/10 rounded border border-white/20 overflow-hidden",children:n.jsx("img",{src:o,alt:"Canvas preview",className:"w-full h-full object-contain"})})]}),n.jsxs("div",{className:"mb-4",children:[n.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Quick styles:"}),n.jsxs("div",{className:"grid grid-cols-4 gap-2 mb-3",children:[n.jsxs("button",{onClick:()=>E("transform this into a watercolor painting with soft blended colors and fluid brushstrokes"),className:"flex flex-col items-center gap-1 p-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md transition-colors text-white",disabled:v,children:[n.jsx(Xe,{className:"w-6 h-6"}),n.jsx("span",{className:"text-xs",children:"Watercolor"})]}),n.jsxs("button",{onClick:()=>E("transform this into a photorealistic image with natural lighting and detailed textures"),className:"flex flex-col items-center gap-1 p-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md transition-colors text-white",disabled:v,children:[n.jsx(st,{className:"w-6 h-6"}),n.jsx("span",{className:"text-xs",children:"Photo Real"})]}),n.jsxs("button",{onClick:()=>E("transform this into a cartoon style illustration with bold colors and clean lines"),className:"flex flex-col items-center gap-1 p-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md transition-colors text-white",disabled:v,children:[n.jsx(Ut,{className:"w-6 h-6"}),n.jsx("span",{className:"text-xs",children:"Cartoon"})]}),n.jsxs("button",{onClick:()=>E("transform this into pixel art with a retro 8-bit video game aesthetic"),className:"flex flex-col items-center gap-1 p-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md transition-colors text-white",disabled:v,children:[n.jsx(pt,{className:"w-6 h-6"}),n.jsx("span",{className:"text-xs",children:"Pixel Art"})]})]})]}),n.jsxs("div",{className:"mb-4",children:[n.jsx("label",{htmlFor:"prompt",className:"block text-sm font-medium text-white mb-2",children:"Or describe your own transformation:"}),n.jsx("textarea",{id:"prompt",value:d,onChange:N=>E(N.target.value),placeholder:"e.g., 'make it look like a watercolor painting' or 'add a sunset background'",className:"w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none text-white placeholder-white/50",rows:3,disabled:v})]}),n.jsxs("div",{className:"mb-4",children:[n.jsxs("label",{htmlFor:"weight",className:"block text-sm font-medium text-white mb-2",children:["Canvas influence: ",q.toFixed(2)]}),n.jsx("input",{id:"weight",type:"range",min:"0",max:"1",step:"0.05",value:q,onChange:N=>X(parseFloat(N.target.value)),disabled:v,className:"ai-modal-slider"}),n.jsxs("div",{className:"flex justify-between text-xs text-white/60 mt-1",children:[n.jsx("span",{children:"0 (ignore canvas)"}),n.jsx("span",{children:"1 (preserve canvas)"})]})]}),S&&n.jsx("div",{className:"mb-4 p-3 bg-red-500/20 border border-red-500/40 rounded-md",children:n.jsx("p",{className:"text-sm text-red-400",children:S})}),n.jsxs("div",{className:"flex gap-3 justify-end",children:[n.jsx("button",{onClick:t,disabled:v,className:"px-4 py-2 text-sm font-medium text-white bg-white/10 hover:bg-white/20 rounded-md transition-colors disabled:opacity-50",children:"Cancel"}),n.jsx("button",{onClick:_,disabled:v||!d.trim(),className:"px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:v?n.jsxs(n.Fragment,{children:[n.jsx(bt,{className:"w-4 h-4 animate-spin"}),"Generating..."]}):n.jsxs(n.Fragment,{children:[n.jsx(De,{className:"w-4 h-4"}),"Generate"]})})]})]})]}):null}function pn(){return"true"==="true"}function fn(){return!pn()}function xn(){const e=r.useRef(null),[t,s]=r.useState("#000000"),[o,l]=r.useState(20),[m,k]=r.useState(1),[d,E]=r.useState(.35),[q,X]=r.useState(.2),[v,T]=r.useState(.4),[S,w]=r.useState(0),[h,_]=r.useState(!0),[N,K]=r.useState(0),[H,B]=r.useState(!0),R=j=>j,[J,c]=r.useState([]),[I,b]=r.useState(-1),[u,p]=r.useState(null),[U,M]=r.useState(!1),[L,F]=r.useState(!1),[Q,x]=r.useState("brush"),[O,V]=r.useState(1),[a,C]=r.useState(!0),[A,$]=r.useState(!1),Y=fn(),[oe,se]=r.useState(Y),{createNewSession:fe,presence:xe,currentUser:de,clearSession:ie,undoLastStroke:pe,redoLastStroke:re}=We(u),we=ne(W.images.addAIGeneratedImage),be=ne(W.images.updateAIImageTransform),{images:Ce}=qe(u),he=Ce.filter(j=>j.type==="ai-generated"),{isConnected:Me,connectionMode:Le,metrics:Re}=Be({sessionId:u,userId:de.id?de.id.toString():de.name,enabled:!!de.id});r.useEffect(()=>{},[]),r.useEffect(()=>{if(!A&&he.length>0){$(!0);return}const j=async()=>{for(const G of he)try{G.type==="ai-generated"&&await be({imageId:G._id,opacity:a?O:0})}catch(ce){console.error("Failed to update AI image opacity:",ce,G)}};he.length>0&&A&&j()},[a,O,he,be,A]),r.useEffect(()=>{(async()=>{try{const ce=new URLSearchParams(window.location.search).get("session");if(ce)p(ce);else{const $e=await fe("Collaborative Painting",800,600);p($e),window.history.replaceState({},"",`?session=${$e}`)}}catch(G){console.error("Failed to create/join session:",G)}})()},[fe]);const Ue=()=>{const j=e.current?.getImageData();if(j){const G=J.slice(0,I+1);G.push(j),c(G),b(G.length-1)}},i=async()=>{try{await pe()}catch(j){console.error("Failed to undo stroke:",j)}},g=async()=>{try{await re()}catch(j){console.error("Failed to redo stroke:",j)}},f=async()=>{e.current?.clear(),c([]),b(-1);try{await ie()}catch(j){console.error("Failed to clear session:",j)}},P=()=>{const j=e.current?.getImageData();if(j){const G=document.createElement("a");G.download=`wepaintai-${Date.now()}.png`,G.href=j,G.click()}},y=r.useCallback(()=>{se(j=>!j)},[]),z=r.useCallback(()=>{M(!0)},[]),D=r.useCallback(j=>{console.log("Image uploaded:",j),M(!1),x("brush")},[]),ee=r.useCallback(()=>{F(!0)},[]),ae=r.useCallback(async j=>{if(!u)return;console.log("handleAIGenerationComplete called with URL:",j),console.log("URL type:",typeof j),console.log("URL length:",j.length);const G=new Image;G.crossOrigin="anonymous",G.onload=async()=>{try{const ce=e.current?.getDimensions()||{width:800,height:600};await we({sessionId:u,imageUrl:j,width:G.width,height:G.height,canvasWidth:ce.width,canvasHeight:ce.height}),console.log("AI-generated image added to canvas"),F(!1),x("brush")}catch(ce){console.error("Failed to add AI-generated image:",ce)}},G.onerror=ce=>{console.error("Failed to load generated image from URL:",j),console.error("Error event:",ce),F(!1),x("brush")},G.src=j},[u,we]),le=r.useCallback(j=>{x(j),j==="upload"&&z()},[z]);return r.useEffect(()=>{if(!Y)return;const j=G=>{G.ctrlKey&&G.shiftKey&&G.key==="A"&&(G.preventDefault(),y())};return window.addEventListener("keydown",j),()=>{window.removeEventListener("keydown",j)}},[y,Y]),n.jsxs("div",{className:"relative w-full h-full bg-gray-50",children:[he.length>0&&n.jsxs("div",{className:"absolute top-2 right-40 z-50 flex items-center gap-2",children:[n.jsxs("button",{onClick:()=>C(!a),className:"bg-black/90 backdrop-blur-md border border-white/20 hover:bg-black/80 text-white font-bold py-1 px-2 rounded text-xs",title:"Toggle AI image visibility",children:[a?"Hide":"Show"," AI"]}),a&&n.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:O,onChange:j=>V(parseFloat(j.target.value)),className:"ai-opacity-slider",title:`AI image opacity: ${Math.round(O*100)}%`})]}),Y&&n.jsxs("button",{onClick:y,className:"absolute top-2 right-28 z-50 bg-black/90 backdrop-blur-md border border-white/20 hover:bg-black/80 text-white font-bold py-1 px-2 rounded text-xs",title:"Toggle Admin Panel (Ctrl+Shift+A)",children:[oe?"Hide":"Show"," Admin"]}),u?n.jsx(Ke,{ref:e,sessionId:u,color:t,size:o,opacity:m,smoothing:d,thinning:q,streamline:v,easing:R,startTaper:S,startCap:h,endTaper:N,endCap:H,onStrokeEnd:Ue}):n.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),n.jsx("p",{className:"text-gray-600",children:"Creating painting session..."})]})}),Y&&n.jsx(dn,{sessionId:u,userCount:xe.length+1,currentUser:de}),Y&&n.jsx(un,{isConnected:Me,connectionMode:Le,metrics:Re,className:"absolute bottom-2 left-2 z-10"}),!1,n.jsx(ln,{color:t,size:o,opacity:m,onColorChange:s,onSizeChange:l,onOpacityChange:k,onUndo:i,onRedo:g,onClear:f,onExport:P,onImageUpload:z,onAIGenerate:ee,selectedTool:Q,onToolChange:le}),U&&n.jsx(gn,{sessionId:u,userId:de.id,onImageUploaded:D,onClose:()=>{M(!1),x("brush")},canvasWidth:e.current?.getDimensions().width,canvasHeight:e.current?.getDimensions().height}),L&&u&&(()=>{const j=e.current?.getImageData()||"";console.log("[PaintingView] Canvas ref exists:",!!e.current),console.log("[PaintingView] Canvas data for AI generation:",j.substring(0,100)+"..."),console.log("[PaintingView] Canvas data length:",j.length),console.log("[PaintingView] Canvas data is empty:",j===""||j.length===0),(!j||j.length===0)&&(console.error("[PaintingView] ERROR: Canvas data is empty!"),setTimeout(()=>{const ce=e.current?.getImageData()||"";console.log("[PaintingView] Retry canvas data length:",ce.length)},100));const G=e.current?.getDimensions()||{width:800,height:600};return n.jsx(mn,{isOpen:L,onClose:()=>{F(!1),x("brush")},sessionId:u,canvasDataUrl:j,canvasWidth:G.width,canvasHeight:G.height,onGenerationComplete:ae})})(),Y&&n.jsx(cn,{isVisible:oe,onClose:y,size:o,onSizeChange:l,smoothing:d,onSmoothingChange:E,thinning:q,onThinningChange:X,streamline:v,onStreamlineChange:T,startTaper:S,onStartTaperChange:w,startCap:h,onStartCapChange:_,endTaper:N,onEndTaperChange:K,endCap:H,onEndCapChange:B})]})}const bn=function(){return n.jsx(xn,{})};export{bn as component};
