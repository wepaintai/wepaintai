import{a as Ae,r as o,u as fe,b as se,c as _e,j as r,R as K}from"./client-YlfALujF.js";function Ce(e,t,n,s=c=>c){return e*s(.5-t*(.5-n))}function ze(e){return[-e[0],-e[1]]}function ne(e,t){return[e[0]+t[0],e[1]+t[1]]}function ee(e,t){return[e[0]-t[0],e[1]-t[1]]}function te(e,t){return[e[0]*t,e[1]*t]}function Ve(e,t){return[e[0]/t,e[1]/t]}function pe(e){return[e[1],-e[0]]}function ke(e,t){return e[0]*t[0]+e[1]*t[1]}function He(e,t){return e[0]===t[0]&&e[1]===t[1]}function Oe(e){return Math.hypot(e[0],e[1])}function Xe(e){return e[0]*e[0]+e[1]*e[1]}function Se(e,t){return Xe(ee(e,t))}function Me(e){return Ve(e,Oe(e))}function Ye(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function me(e,t,n){let s=Math.sin(n),c=Math.cos(n),f=e[0]-t[0],b=e[1]-t[1],d=f*c-b*s,j=f*s+b*c;return[d+t[0],j+t[1]]}function be(e,t,n){return ne(e,te(ee(t,e),n))}function Pe(e,t,n){return ne(e,te(t,n))}var{min:he,PI:Be}=Math,je=.275,ge=Be+1e-4;function Ke(e,t={}){let{size:n=16,smoothing:s=.5,thinning:c=.5,simulatePressure:f=!0,easing:b=y=>y,start:d={},end:j={},last:O=!1}=t,{cap:T=!0,easing:F=y=>y*(2-y)}=d,{cap:z=!0,easing:E=y=>--y*y*y+1}=j;if(e.length===0||n<=0)return[];let x=e[e.length-1].runningLength,h=d.taper===!1?0:d.taper===!0?Math.max(n,x):d.taper,R=j.taper===!1?0:j.taper===!0?Math.max(n,x):j.taper,V=Math.pow(n*s,2),A=[],k=[],u=e.slice(0,10).reduce((y,N)=>{let U=N.pressure;if(f){let _=he(1,N.distance/n),G=he(1,1-_);U=he(1,y+(G-y)*(_*je))}return(y+U)/2},e[0].pressure),v=Ce(n,c,e[e.length-1].pressure,b),a,L=e[0].vector,l=e[0].point,C=l,p=l,S=C,m=!1;for(let y=0;y<e.length;y++){let{pressure:N}=e[y],{point:U,vector:_,distance:G,runningLength:J}=e[y];if(y<e.length-1&&x-J<3)continue;if(c){if(f){let W=he(1,G/n),ae=he(1,1-W);N=he(1,u+(ae-u)*(W*je))}v=Ce(n,c,N,b)}else v=n/2;a===void 0&&(a=v);let ce=J<h?F(J/h):1,le=x-J<R?E((x-J)/R):1;v=Math.max(.01,v*Math.min(ce,le));let ie=(y<e.length-1?e[y+1]:e[y]).vector,re=y<e.length-1?ke(_,ie):1,oe=ke(_,L)<0&&!m,D=re!==null&&re<0;if(oe||D){let W=te(pe(L),v);for(let ae=1/13,de=0;de<=1;de+=ae)p=me(ee(U,W),U,ge*de),A.push(p),S=me(ne(U,W),U,ge*-de),k.push(S);l=p,C=S,D&&(m=!0);continue}if(m=!1,y===e.length-1){let W=te(pe(_),v);A.push(ee(U,W)),k.push(ne(U,W));continue}let H=te(pe(be(ie,_,re)),v);p=ee(U,H),(y<=1||Se(l,p)>V)&&(A.push(p),l=p),S=ne(U,H),(y<=1||Se(C,S)>V)&&(k.push(S),C=S),u=N,L=_}let P=e[0].point.slice(0,2),I=e.length>1?e[e.length-1].point.slice(0,2):ne(e[0].point,[1,1]),Y=[],Z=[];if(e.length===1){if(!(h||R)||O){let y=Pe(P,Me(pe(ee(P,I))),-(a||v)),N=[];for(let U=1/13,_=U;_<=1;_+=U)N.push(me(y,P,ge*2*_));return N}}else{if(!(h||R&&e.length===1))if(T)for(let N=1/13,U=N;U<=1;U+=N){let _=me(k[0],P,ge*U);Y.push(_)}else{let N=ee(A[0],k[0]),U=te(N,.5),_=te(N,.51);Y.push(ee(P,U),ee(P,_),ne(P,_),ne(P,U))}let y=pe(ze(e[e.length-1].vector));if(R||h&&e.length===1)Z.push(I);else if(z){let N=Pe(I,y,v);for(let U=1/29,_=U;_<1;_+=U)Z.push(me(N,I,ge*3*_))}else Z.push(ne(I,te(y,v)),ne(I,te(y,v*.99)),ee(I,te(y,v*.99)),ee(I,te(y,v)))}return A.concat(Z,k.reverse(),Y)}function We(e,t={}){var n;let{streamline:s=.5,size:c=16,last:f=!1}=t;if(e.length===0)return[];let b=.15+(1-s)*.85,d=Array.isArray(e[0])?e:e.map(({x:E,y:x,pressure:h=.5})=>[E,x,h]);if(d.length===2){let E=d[1];d=d.slice(0,-1);for(let x=1;x<5;x++)d.push(be(d[0],E,x/4))}d.length===1&&(d=[...d,[...ne(d[0],[1,1]),...d[0].slice(2)]]);let j=[{point:[d[0][0],d[0][1]],pressure:d[0][2]>=0?d[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],O=!1,T=0,F=j[0],z=d.length-1;for(let E=1;E<d.length;E++){let x=f&&E===z?d[E].slice(0,2):be(F.point,d[E],b);if(He(F.point,x))continue;let h=Ye(x,F.point);if(T+=h,E<z&&!O){if(T<c)continue;O=!0}F={point:x,pressure:d[E][2]>=0?d[E][2]:.5,vector:Me(ee(F.point,x)),distance:h,runningLength:T},j.push(F)}return j[0].vector=((n=j[1])==null?void 0:n.vector)||[0,0],j}function qe(e,t={}){return Ke(We(e,t),t)}const X=Ae;function Ee(e){const[t]=o.useState(()=>({id:crypto.randomUUID(),name:`User ${Math.floor(Math.random()*1e3)}`,color:`hsl(${Math.floor(Math.random()*360)}, 70%, 50%)`})),n=fe(X.paintingSessions.getSession,e?{sessionId:e}:"skip"),s=fe(X.strokes.getSessionStrokes,e?{sessionId:e}:"skip"),c=fe(X.presence.getSessionPresence,e?{sessionId:e}:"skip"),f=fe(X.liveStrokes.getLiveStrokes,e?{sessionId:e}:"skip"),b=se(X.paintingSessions.createSession),d=se(X.strokes.addStroke),j=se(X.strokes.clearSession),O=se(X.presence.updatePresence),T=se(X.presence.leaveSession),F=se(X.liveStrokes.updateLiveStroke),z=se(X.liveStrokes.clearLiveStroke),E=se(X.liveStrokes.clearSessionLiveStrokes),x=se(X.viewerAcks.upsertViewerState),h=se(X.viewerAcks.removeViewerState),R=fe(X.viewerAcks.getViewerState,e?{sessionId:e,viewerId:t.id}:"skip"),V=o.useRef(0);o.useEffect(()=>{R?.lastAckedStrokeOrder&&(V.current=R.lastAckedStrokeOrder)},[R]),o.useEffect(()=>{if(s&&s.length>0&&e){const m=s.reduce((P,I)=>Math.max(P,I.strokeOrder),0);m>V.current&&(V.current=m,x({sessionId:e,viewerId:t.id,lastAckedStrokeOrder:m}))}},[s,e,t.id,x]);const A=o.useCallback(async(m,P=800,I=600)=>await b({name:m,canvasWidth:P,canvasHeight:I,isPublic:!0}),[b]),k=o.useCallback(async(m,P,I,Y=1)=>{if(e)return await d({sessionId:e,userColor:t.color,points:m,brushColor:P,brushSize:I,opacity:Y})},[e,d,t.color]),u=o.useCallback(async(m,P,I,Y)=>{if(e)return await O({sessionId:e,userColor:t.color,userName:t.name,cursorX:m,cursorY:P,isDrawing:I,currentTool:Y})},[e,O,t]),v=o.useCallback(async()=>{e&&await Promise.all([j({sessionId:e}),E({sessionId:e})])},[e,j,E]),a=o.useRef(null),L=o.useRef(null),l=o.useRef(0),C=o.useCallback((m,P,I,Y=1)=>{if(!e)return;const Z=Date.now(),y=Z-l.current;if(L.current={points:m,brushColor:P,brushSize:I,opacity:Y},m.length===1||y>=16){l.current=Z,F({sessionId:e,userColor:t.color,userName:t.name,points:m,brushColor:P,brushSize:I,opacity:Y}),L.current=null,a.current&&(clearTimeout(a.current),a.current=null);return}a.current&&clearTimeout(a.current),a.current=setTimeout(()=>{const N=L.current;N&&(l.current=Date.now(),F({sessionId:e,userColor:t.color,userName:t.name,points:N.points,brushColor:N.brushColor,brushSize:N.brushSize,opacity:N.opacity}),L.current=null),a.current=null},16)},[e,F,t]),p=o.useCallback(async()=>{if(e)return await z({sessionId:e})},[e,z]);o.useEffect(()=>{const m=e,P=t.id;return()=>{m&&(T({sessionId:m}),h({sessionId:m,viewerId:P})),a.current&&clearTimeout(a.current)}},[e,T,h,t.id]);const S=o.useMemo(()=>s||[],[s]);return{session:n,strokes:S,presence:c||[],liveStrokes:f||[],currentUser:t,createNewSession:A,addStrokeToSession:k,updateUserPresence:u,clearSession:v,updateLiveStrokeForUser:C,clearLiveStrokeForUser:p,isLoading:n===void 0}}const Ze={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}],dataChannelOptions:{ordered:!1,maxRetransmits:0,protocol:"paint-preview"},maxPeersForMesh:4,sfuUrl:void 0,turnUrl:void 0,turnUsername:void 0,turnCredential:void 0};function Qe(){const e={...Ze};if(typeof window<"u"){const t=window.__ENV__||{};t.VITE_SFU_URL&&(e.sfuUrl=t.VITE_SFU_URL),t.VITE_TURN_URL&&(e.turnUrl=t.VITE_TURN_URL,e.turnUsername=t.VITE_TURN_USERNAME,e.turnCredential=t.VITE_TURN_CREDENTIAL,e.iceServers.push({urls:e.turnUrl,username:e.turnUsername,credential:e.turnCredential}))}return e}function Ge(e){const t=new ArrayBuffer(22),n=new DataView(t);n.setUint8(0,e.t.charCodeAt(0)),n.setUint8(1,e.t.charCodeAt(1));const s=e.id.substring(0,8);for(let c=0;c<8;c++)n.setUint8(2+c,s.charCodeAt(c)||0);return n.setFloat32(10,e.x,!0),n.setFloat32(14,e.y,!0),n.setFloat32(18,e.p,!0),t}function Je(e){if(e.byteLength!==22)return console.error("Invalid packet size:",e.byteLength),null;const t=new DataView(e),n=String.fromCharCode(t.getUint8(0),t.getUint8(1));if(n!=="pt")return console.error("Invalid packet type:",n),null;let s="";for(let d=0;d<8;d++)s+=String.fromCharCode(t.getUint8(2+d));const c=t.getFloat32(10,!0),f=t.getFloat32(14,!0),b=t.getFloat32(18,!0);return{t:"pt",id:s,x:c,y:f,p:b}}class et{config;peers=new Map;mode="mesh";convexClient;sessionId;peerId;roomKey;pollingInterval=null;metrics={latency:0,packetsSent:0,packetsReceived:0,bytesTransferred:0,connectedPeers:0};onPacketReceived;onPeerConnected;onPeerDisconnected;onModeChanged;constructor(t){this.config=Qe(),this.convexClient=t.convexClient,this.sessionId=t.sessionId,this.peerId=t.peerId,this.roomKey=t.roomKey,this.onPacketReceived=t.onPacketReceived,this.onPeerConnected=t.onPeerConnected,this.onPeerDisconnected=t.onPeerDisconnected,this.onModeChanged=t.onModeChanged}async init(){try{const{peers:t,mode:n}=await this.convexClient.mutation(X.webrtc.joinP2PSession,{sessionId:this.sessionId,peerId:this.peerId,roomKey:this.roomKey});this.mode=n,this.onModeChanged?.(n);for(const s of t)await this.connectToPeer(s);this.startSignalPolling()}catch(t){console.error("Failed to initialize P2P:",t),this.mode="fallback",this.onModeChanged?.("fallback")}}async connectToPeer(t){if(this.peers.has(t))return;const n=new RTCPeerConnection({iceServers:this.config.iceServers}),s={peerId:t,connection:n,dataChannel:null,isConnected:!1};this.peers.set(t,s),n.onicecandidate=async b=>{b.candidate&&await this.sendSignal(t,"ice-candidate",b.candidate)};const c=n.createDataChannel("paint-preview",this.config.dataChannelOptions);this.setupDataChannel(c,s);const f=await n.createOffer();await n.setLocalDescription(f),await this.sendSignal(t,"offer",f)}setupDataChannel(t,n){n.dataChannel=t,t.onopen=()=>{n.isConnected=!0,this.metrics.connectedPeers++,this.onPeerConnected?.(n.peerId)},t.onclose=()=>{n.isConnected=!1,this.metrics.connectedPeers--,this.onPeerDisconnected?.(n.peerId)},t.onmessage=s=>{this.handleDataChannelMessage(n.peerId,s.data)},t.onerror=s=>{console.error(`Data channel error with peer ${n.peerId}:`,s)}}handleDataChannelMessage(t,n){if(n instanceof ArrayBuffer){const s=Je(n);s&&(this.metrics.packetsReceived++,this.metrics.bytesTransferred+=n.byteLength,this.onPacketReceived?.(t,s))}}async sendSignal(t,n,s){await this.convexClient.mutation(X.webrtc.sendSignal,{sessionId:this.sessionId,fromPeerId:this.peerId,toPeerId:t,type:n,data:s})}startSignalPolling(){this.pollingInterval=setInterval(async()=>{try{const t=await this.convexClient.query(X.webrtc.getSignals,{sessionId:this.sessionId,peerId:this.peerId});if(t.length>0){for(const s of t)await this.handleSignal(s);const n=t.map(s=>s.id);await this.convexClient.mutation(X.webrtc.deleteSignals,{signalIds:n})}}catch(t){console.error("Signal polling error:",t)}},1e3)}async handleSignal(t){let n=this.peers.get(t.fromPeerId);if(t.type==="offer"){if(!n){const c=new RTCPeerConnection({iceServers:this.config.iceServers});n={peerId:t.fromPeerId,connection:c,dataChannel:null,isConnected:!1},this.peers.set(t.fromPeerId,n),c.onicecandidate=async f=>{f.candidate&&await this.sendSignal(t.fromPeerId,"ice-candidate",f.candidate)},c.ondatachannel=f=>{this.setupDataChannel(f.channel,n)}}await n.connection.setRemoteDescription(t.data);const s=await n.connection.createAnswer();await n.connection.setLocalDescription(s),await this.sendSignal(t.fromPeerId,"answer",s)}else t.type==="answer"&&n?await n.connection.setRemoteDescription(t.data):t.type==="ice-candidate"&&n&&await n.connection.addIceCandidate(t.data)}sendPacket(t){const n=Ge(t);for(const s of this.peers.values())if(s.isConnected&&s.dataChannel?.readyState==="open")try{s.dataChannel.send(n),this.metrics.packetsSent++,this.metrics.bytesTransferred+=n.byteLength}catch(c){console.error(`Failed to send packet to peer ${s.peerId}:`,c)}}getMetrics(){return{...this.metrics}}async destroy(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null);for(const t of this.peers.values())t.dataChannel&&t.dataChannel.close(),t.connection.close();this.peers.clear();try{await this.convexClient.mutation(X.webrtc.leaveP2PSession,{sessionId:this.sessionId,peerId:this.peerId})}catch(t){console.error("Error leaving P2P session:",t)}}}function Re({sessionId:e,userId:t,enabled:n=!0}){const s=_e(),c=o.useRef(null),[f,b]=o.useState(!1),[d,j]=o.useState("fallback"),[O,T]=o.useState(new Map),[F,z]=o.useState(null),E=o.useRef(null),x=o.useCallback((k,u)=>{T(v=>{const a=new Map(v),L=`${k}:${u.id}`,l=a.get(L);return l?(l.points.push({x:u.x,y:u.y,pressure:u.p}),l.lastUpdate=Date.now()):a.set(L,{peerId:k,strokeId:u.id,points:[{x:u.x,y:u.y,pressure:u.p}],color:"#000000",size:5,lastUpdate:Date.now()}),a})},[]),h=o.useCallback(k=>{console.log(`Peer connected: ${k}`),b(!0)},[]),R=o.useCallback(k=>{console.log(`Peer disconnected: ${k}`),T(u=>{const v=new Map(u);for(const[a]of v)a.startsWith(`${k}:`)&&v.delete(a);return v})},[]);o.useEffect(()=>{if(!n||!e)return;const k=`session-${e}`,u=new et({sessionId:e,peerId:t,roomKey:k,convexClient:s,onPacketReceived:x,onPeerConnected:h,onPeerDisconnected:R,onModeChanged:j});return c.current=u,u.init().catch(v=>{console.error("Failed to initialize P2P:",v),j("fallback")}),E.current=setInterval(()=>{c.current&&z(c.current.getMetrics())},1e3),()=>{E.current&&clearInterval(E.current),u.destroy(),c.current=null,b(!1),T(new Map)}},[n,e,t,s,x,h,R]),o.useEffect(()=>{const k=setInterval(()=>{const u=Date.now();T(v=>{const a=new Map(v);let L=!1;for(const[l,C]of a)u-C.lastUpdate>5e3&&(a.delete(l),L=!0);return L?a:v})},1e3);return()=>clearInterval(k)},[]);const V=o.useCallback((k,u,v,a)=>{if(!c.current||!f)return;const L={t:"pt",id:k.substring(0,8),x:u,y:v,p:a};c.current.sendPacket(L)},[f]),A=o.useCallback((k,u)=>{T(v=>{const a=new Map(v);return a.delete(`${k}:${u}`),a})},[]);return{isConnected:f,connectionMode:d,remoteStrokes:O,sendStrokePoint:V,clearRemoteStroke:A,metrics:F}}const ye=(e,t)=>(e+t)/2;function tt(e,t=!0){const n=e.length;if(n<4)return"";let s=e[0],c=e[1];const f=e[2];let b=`M${s[0].toFixed(2)},${s[1].toFixed(2)} Q${c[0].toFixed(2)},${c[1].toFixed(2)} ${ye(c[0],f[0]).toFixed(2)},${ye(c[1],f[1]).toFixed(2)} T`;for(let d=2,j=n-1;d<j;d++)s=e[d],c=e[d+1],b+=`${ye(s[0],c[0]).toFixed(2)},${ye(s[1],c[1]).toFixed(2)} `;return t&&(b+="Z"),b}const Le=o.forwardRef(({sessionId:e,color:t,size:n,opacity:s,onStrokeEnd:c,smoothing:f=.75,thinning:b=.5,streamline:d=.65,easing:j=x=>x,startTaper:O=0,startCap:T=!0,endTaper:F=0,endCap:z=!0},E)=>{const x=o.useRef(null),h=o.useRef(null),[R,V]=o.useState(!1),[A,k]=o.useState([]),[u,v]=o.useState(null),[a,L]=o.useState(null),[l,C]=o.useState(0),[p,S]=o.useState(new Map),m=o.useRef(!1),{strokes:P,presence:I,liveStrokes:Y,currentUser:Z,addStrokeToSession:y,updateUserPresence:N,updateLiveStrokeForUser:U,clearLiveStrokeForUser:_}=Ee(e),{isConnected:G,connectionMode:J,remoteStrokes:ce,sendStrokePoint:le}=Re({sessionId:e,userId:Z.id,enabled:!0}),[ie,re]=o.useState(null);o.useEffect(()=>{P.length>0&&S(i=>{const g=new Map(i);return P.forEach(w=>{for(const[$,M]of g)if(M.points.length===w.points.length&&M.color===w.brushColor&&M.size===w.brushSize){const q=Math.abs(M.points[0].x-w.points[0].x)<1&&Math.abs(M.points[0].y-w.points[0].y)<1,B=M.points.length-1,ue=Math.abs(M.points[B].x-w.points[B].x)<1&&Math.abs(M.points[B].y-w.points[B].y)<1;if(q&&ue){g.delete($);break}}}),g})},[P]),o.useEffect(()=>{const i=setInterval(()=>{S(g=>{const w=new Map(g);for(const[$]of w)if(w.size>5){w.delete($);break}return w})},5e3);return()=>clearInterval(i)},[]),o.useEffect(()=>{const i=x.current,g=h.current;if(!i||!g)return;const w=i.getContext("2d"),$=g.getContext("2d");if(!w||!$)return;const M=()=>{const q=i.parentElement;if(q){const{clientWidth:B,clientHeight:ue}=q;i.width=B,i.height=ue,g.width=B,g.height=ue,oe()}};return M(),v(w),L($),window.addEventListener("resize",M),()=>window.removeEventListener("resize",M)},[]),o.useEffect(()=>{oe()},[P]);const oe=o.useCallback(()=>{!u||!x.current||(u.clearRect(0,0,x.current.width,x.current.height),P.sort((i,g)=>i.strokeOrder-g.strokeOrder).forEach(i=>{D(u,{points:i.points,color:i.brushColor,size:i.brushSize})}),p.forEach(i=>{D(u,i)}))},[u,P,p,f,b,d,j,O,T,F,z,s]),D=(i,g)=>{if(g.points.length===0)return;const w={size:g.size,smoothing:f,thinning:b,streamline:d,easing:j,start:{taper:O,cap:T},end:{taper:F,cap:z},last:!g.isLive},$=qe(g.points,w),M=tt($);if(M==="")return;i.fillStyle=g.color,i.globalAlpha=g.opacity!==void 0?g.opacity:s;const q=new Path2D(M);i.fill(q),i.globalAlpha=1},H=o.useCallback(()=>{!a||!h.current||I.forEach(i=>{if(i.userName===Z.name)return;a.fillStyle=i.userColor,a.beginPath(),a.arc(i.cursorX,i.cursorY,5,0,2*Math.PI),a.fill(),a.fillStyle="white",a.strokeStyle=i.userColor,a.lineWidth=2,a.font="12px Arial";const g=a.measureText(i.userName).width;a.strokeText(i.userName,i.cursorX-g/2,i.cursorY-10),a.fillText(i.userName,i.cursorX-g/2,i.cursorY-10)})},[a,I,Z.name]);o.useEffect(()=>{if(!R)return;const i=()=>{m.current||(m.current=!0,V(g=>(g&&k(w=>{if(w.length>0){const $=crypto.randomUUID(),M={points:w,color:t,size:n,opacity:s,id:$,isPending:!0};S(q=>new Map(q).set($,M)),y(w,t,n,s),u&&D(u,M)}return c?.(),a&&h.current&&a.clearRect(0,0,h.current.width,h.current.height),[]}),!1)))};return document.addEventListener("pointerup",i),()=>document.removeEventListener("pointerup",i)},[R,t,n,s,y,c,u,a]),o.useEffect(()=>{!a||!h.current||(a.clearRect(0,0,h.current.width,h.current.height),R&&A.length>0&&D(a,{points:A,color:t,size:n,opacity:s,isLive:!0}),G&&ce.forEach(i=>{i.points.length>0&&D(a,{points:i.points,color:i.color,size:i.size,opacity:.8,isLive:!0})}),(!G||J==="fallback")&&Y.forEach(i=>{i.userName!==Z.name&&D(a,{points:i.points,color:i.brushColor,size:i.brushSize,opacity:i.opacity,isLive:!0})}),H())},[a,A,R,t,n,s,Y,Z.name,H,G,J,ce]);const W=i=>{const g=h.current,w=g?.getBoundingClientRect();if(!w||!g)return{x:0,y:0};const $=g.width/w.width,M=g.height/w.height;return{x:(i.clientX-w.left)*$,y:(i.clientY-w.top)*M,pressure:i.pressure}},ae=i=>{if(!a||!h.current)return;i.currentTarget.setPointerCapture(i.pointerId),V(!0),m.current=!1,a.clearRect(0,0,h.current.width,h.current.height);const g=W(i);k([g]),N(g.x,g.y,!0,"brush");const w=crypto.randomUUID();if(re(w),G&&h.current){const $=g.x/h.current.width,M=g.y/h.current.height;le(w,$,M,g.pressure||.5)}},de=i=>{if(!R||!a||!h.current){const B=W(i);N(B.x,B.y,!1,"brush");return}const g=i.nativeEvent,$=(g.getCoalescedEvents?.()??[g]).map(B=>W({clientX:B.clientX,clientY:B.clientY,pressure:B.pressure,currentTarget:i.currentTarget,target:B.target}));if($.length===0)return;const M=$[$.length-1];N(M.x,M.y,R,"brush");const q=[...A,...$];k(q),G&&ie&&h.current&&$.forEach(B=>{const ue=B.x/h.current.width,Fe=B.y/h.current.height;le(ie,ue,Fe,B.pressure||.5)}),(!G||J==="fallback")&&U(q,t,n,s),a.clearRect(0,0,h.current.width,h.current.height),D(a,{points:q,color:t,size:n,opacity:s,isLive:!0}),H()},$e=i=>{if(!R||!a||!h.current||m.current)return;m.current=!0,i.currentTarget.releasePointerCapture(i.pointerId),V(!1),a.clearRect(0,0,h.current.width,h.current.height);const g=W(i);N(g.x,g.y,!1,"brush");const w=[...A,g];if(w.length>0){const $=crypto.randomUUID(),M={points:w,color:t,size:n,opacity:s,id:$,isPending:!0};S(q=>new Map(q).set($,M)),y(w,t,n,s),(!G||J==="fallback")&&_(),re(null),u&&D(u,M)}k([]),re(null),c?.()},Te=i=>{if(!R||m.current)return;m.current=!0,i.currentTarget.releasePointerCapture(i.pointerId),V(!1),a&&h.current&&a.clearRect(0,0,h.current.width,h.current.height);const g=W(i);N(g.x,g.y,!1,"brush");const w=[...A,g];if(w.length>0){const $=crypto.randomUUID(),M={points:w,color:t,size:n,opacity:s,id:$,isPending:!0};S(q=>new Map(q).set($,M)),y(w,t,n,s),u&&D(u,M)}k([]),re(null),c?.()};return o.useImperativeHandle(E,()=>({clear:()=>{u&&x.current&&u.clearRect(0,0,x.current.width,x.current.height),a&&h.current&&a.clearRect(0,0,h.current.width,h.current.height),S(new Map)},undo:()=>{},getImageData:()=>x.current?.toDataURL("image/png")}),[u,a]),r.jsxs(r.Fragment,{children:[r.jsx("canvas",{ref:x,className:"absolute inset-0 w-full h-full border border-gray-300",style:{zIndex:0}}),r.jsx("canvas",{ref:h,className:"absolute inset-0 w-full h-full",onPointerDown:ae,onPointerMove:de,onPointerUp:$e,onPointerLeave:Te,style:{touchAction:"none",zIndex:1}})]})});Le.displayName="Canvas";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),rt=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(t,n,s)=>s?s.toUpperCase():n.toLowerCase()),Ne=e=>{const t=rt(e);return t.charAt(0).toUpperCase()+t.slice(1)},Ie=(...e)=>e.filter((t,n,s)=>!!t&&t.trim()!==""&&s.indexOf(t)===n).join(" ").trim(),st=e=>{for(const t in e)if(t.startsWith("aria-")||t==="role"||t==="title")return!0};/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var ot={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const at=o.forwardRef(({color:e="currentColor",size:t=24,strokeWidth:n=2,absoluteStrokeWidth:s,className:c="",children:f,iconNode:b,...d},j)=>o.createElement("svg",{ref:j,...ot,width:t,height:t,stroke:e,strokeWidth:s?Number(n)*24/Number(t):n,className:Ie("lucide",c),...!f&&!st(d)&&{"aria-hidden":"true"},...d},[...b.map(([O,T])=>o.createElement(O,T)),...Array.isArray(f)?f:[f]]));/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=(e,t)=>{const n=o.forwardRef(({className:s,...c},f)=>o.createElement(at,{ref:f,iconNode:t,className:Ie(`lucide-${nt(Ne(e))}`,`lucide-${e}`,s),...c}));return n.displayName=Ne(e),n};/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],ct=Q("chevron-up",it);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],dt=Q("circle",lt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],ht=Q("copy",ut);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],pt=Q("eye",ft);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]],gt=Q("folder-open",mt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xt=[["path",{d:"m14.622 17.897-10.68-2.913",key:"vj2p1u"}],["path",{d:"M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z",key:"18tc5c"}],["path",{d:"M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15",key:"ytzfxy"}]],yt=Q("paintbrush",xt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=[["path",{d:"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z",key:"e79jfc"}],["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}]],bt=Q("palette",vt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=[["path",{d:"m12 9-8.414 8.414A2 2 0 0 0 3 18.828v1.344a2 2 0 0 1-.586 1.414A2 2 0 0 1 3.828 21h1.344a2 2 0 0 0 1.414-.586L15 12",key:"1y3wsu"}],["path",{d:"m18 9 .4.4a1 1 0 1 1-3 3l-3.8-3.8a1 1 0 1 1 3-3l.4.4 3.4-3.4a1 1 0 1 1 3 3z",key:"110lr1"}],["path",{d:"m2 22 .414-.414",key:"jhxm08"}]],Ct=Q("pipette",wt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=[["path",{d:"m15 14 5-5-5-5",key:"12vg1m"}],["path",{d:"M20 9H9.5A5.5 5.5 0 0 0 4 14.5A5.5 5.5 0 0 0 9.5 20H13",key:"6uklza"}]],St=Q("redo-2",kt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],jt=Q("rotate-ccw",Pt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],Mt=Q("save",Nt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],Rt=Q("share-2",Et);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],It=Q("undo-2",Lt);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],Dt=Q("users",Ut);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Tt=Q("x",$t),ve=[{id:"brush",icon:yt,label:"Brush",ariaLabel:"Select brush tool",keyboardShortcut:"B"},{id:"rotate",icon:jt,label:"Rotate",ariaLabel:"Rotate canvas",keyboardShortcut:"R"},{id:"folder",icon:gt,label:"Open",ariaLabel:"Open file",keyboardShortcut:"O"},{id:"inpaint",icon:bt,label:"Inpaint",ariaLabel:"Inpaint tool",keyboardShortcut:"I"}],we=K.memo(({value:e,min:t,max:n,onChange:s,icon:c,label:f,color:b})=>{const d=(e-t)/(n-t)*100;return r.jsxs("div",{className:"flex items-center gap-2 mb-3",role:"group","aria-labelledby":`${f.toLowerCase()}-slider-label`,children:[r.jsx(c,{className:"w-4 h-4 text-muted-foreground flex-shrink-0","aria-hidden":"true"}),r.jsxs("div",{className:"relative flex-1 h-6 flex items-center",children:[r.jsx("div",{className:"h-1 w-full bg-secondary rounded-full overflow-hidden",role:"presentation",children:r.jsx("div",{className:"h-full transition-all duration-100",style:{width:`${d}%`,backgroundColor:b}})}),r.jsx("div",{className:"absolute top-1/2 -translate-y-1/2 w-3 h-3 rounded-full pointer-events-none",style:{left:`calc(${d}% - 6px)`,backgroundColor:b},role:"presentation"}),r.jsx("input",{type:"range",min:t,max:n,value:e,onChange:j=>s(Number(j.target.value)),className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer","aria-valuemin":t,"aria-valuemax":n,"aria-valuenow":e,"aria-labelledby":`${f.toLowerCase()}-slider-label`}),r.jsxs("span",{id:`${f.toLowerCase()}-slider-label`,className:"sr-only",children:[f," slider"]})]})]})});we.displayName="Slider";const Ue=K.memo(({tool:e,isSelected:t,onClick:n})=>r.jsx("button",{onClick:n,className:`w-8 h-8 flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-1 focus-visible:ring-primary ${t?"bg-gray-200 text-gray-900":"bg-secondary text-secondary-foreground hover:bg-secondary/80"}`,title:`${e.label}${e.keyboardShortcut?` (${e.keyboardShortcut})`:""}`,"aria-label":e.ariaLabel,"aria-pressed":t,children:r.jsx(e.icon,{className:`w-4 h-4 ${t?"scale-110 transition-transform":""}`})},e.id));Ue.displayName="ToolButton";const xe=K.memo(({icon:e,label:t,onClick:n,isPrimary:s=!1})=>r.jsx("button",{onClick:n,className:`w-8 h-8 flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-1 focus-visible:ring-primary ${s?"bg-primary text-primary-foreground hover:bg-primary/90":"bg-secondary text-secondary-foreground hover:bg-secondary/80"}`,title:t,"aria-label":t,children:r.jsx(e,{className:"w-4 h-4"})}));xe.displayName="ActionButton";const De=K.memo(({color:e,onColorChange:t})=>{const n=K.useRef(null),s=()=>{n.current?.click()},c=f=>{t(f.target.value)};return r.jsxs("div",{className:"flex items-center gap-2 mb-3",role:"group","aria-labelledby":"color-mixer-label",children:[r.jsx(Ct,{className:"w-4 h-4 text-muted-foreground flex-shrink-0","aria-hidden":"true"}),r.jsx("button",{onClick:s,className:"flex-1 h-6 border border-border rounded transition-all duration-100 hover:border-primary focus:outline-none focus-visible:ring-1 focus-visible:ring-primary",style:{backgroundColor:e},title:"Click to change color","aria-label":"Current brush color, click to change",children:r.jsxs("span",{className:"sr-only",children:["Current color: ",e]})}),r.jsx("input",{ref:n,type:"color",value:e,onChange:c,className:"sr-only","aria-label":"Color picker"}),r.jsx("span",{id:"color-mixer-label",className:"sr-only",children:"Color mixer"})]})});De.displayName="ColorMixer";function Ft({color:e,size:t,opacity:n,onColorChange:s,onSizeChange:c,onOpacityChange:f,onUndo:b,onRedo:d,onClear:j,onExport:O}){const[T,F]=K.useState("brush"),[z,E]=K.useState(!1),[x,h]=K.useState(!1),[R,V]=K.useState({x:24,y:200}),[A,k]=K.useState({x:0,y:0}),u=K.useRef(null);K.useEffect(()=>{typeof window<"u"&&V({x:24,y:window.innerHeight/2-150})},[]);const v=K.useCallback(l=>{l.preventDefault(),h(!0);const C="touches"in l?l.touches[0].clientX:l.clientX,p="touches"in l?l.touches[0].clientY:l.clientY;if(u.current){const S=u.current.getBoundingClientRect();k({x:C-S.left,y:p-S.top})}},[]),a=K.useCallback(l=>{if(!x)return;const C="touches"in l?l.touches[0].clientX:l.clientX,p="touches"in l?l.touches[0].clientY:l.clientY,S=C-A.x,m=p-A.y,P=window.innerWidth-(u.current?.offsetWidth||200),I=window.innerHeight-(u.current?.offsetHeight||300);V({x:Math.max(0,Math.min(S,P)),y:Math.max(0,Math.min(m,I))})},[x,A]),L=K.useCallback(()=>{h(!1)},[]);return K.useEffect(()=>{if(x){const l=m=>a(m),C=()=>L(),p=m=>a(m),S=()=>L();return document.addEventListener("mousemove",l),document.addEventListener("mouseup",C),document.addEventListener("touchmove",p,{passive:!1}),document.addEventListener("touchend",S),()=>{document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",C),document.removeEventListener("touchmove",p),document.removeEventListener("touchend",S)}}},[x,a,L]),K.useEffect(()=>{const l=()=>{const C=window.innerWidth-(u.current?.offsetWidth||200),p=window.innerHeight-(u.current?.offsetHeight||300);V(S=>({x:Math.max(0,Math.min(S.x,C)),y:Math.max(0,Math.min(S.y,p))}))};return window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)},[]),K.useEffect(()=>{const l=C=>{if(C.target instanceof HTMLInputElement||C.target instanceof HTMLTextAreaElement)return;const p=C.key.toUpperCase(),S=ve.find(m=>m.keyboardShortcut===p);S&&F(S.id)};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[]),r.jsx("div",{ref:u,className:"fixed z-50 select-none",style:{left:`${R.x}px`,top:`${R.y}px`,transition:x?"none":"transform 0.15s ease-out"},role:"toolbar","aria-label":"ipaint.ai tools",children:r.jsxs("div",{className:"bg-background/95 backdrop-blur-sm border border-border overflow-hidden",style:{width:"180px"},children:[r.jsxs("div",{className:`flex items-center justify-between px-2 py-1.5 border-b border-border ${x?"cursor-grabbing":"cursor-grab"}`,onMouseDown:v,onTouchStart:v,"aria-label":"Drag to move panel",role:"button",children:[r.jsx("div",{className:"flex items-center",children:r.jsx("span",{className:"text-xs font-medium text-foreground/80",children:"ipaint.ai"})}),r.jsx("button",{onClick:l=>{l.stopPropagation(),E(!z)},onMouseDown:l=>l.stopPropagation(),onTouchStart:l=>l.stopPropagation(),className:"p-1 hover:bg-secondary/80 transition-colors","aria-expanded":!z,"aria-label":z?"Expand tools panel":"Collapse tools panel",children:r.jsx(ct,{className:`w-3.5 h-3.5 text-muted-foreground transition-transform ${z?"":"rotate-180"}`})})]}),!z&&r.jsxs("div",{className:"p-2",children:[r.jsx("div",{className:"grid grid-cols-4 border-b border-border mb-3",children:ve.map((l,C)=>r.jsx("div",{className:`${C<ve.length-1?"border-r border-border":""}`,children:r.jsx(Ue,{tool:l,isSelected:T===l.id,onClick:()=>F(l.id)})},l.id))}),r.jsx("div",{className:"border-b border-border mb-3 pb-3",children:r.jsx(De,{color:e,onColorChange:s})}),r.jsxs("div",{className:"border-b border-border mb-3 pb-3",children:[r.jsx(we,{value:t,min:1,max:100,onChange:c,icon:dt,label:"Brush Size",color:"hsl(var(--primary))"}),r.jsx(we,{value:n*100,min:0,max:100,onChange:l=>f(l/100),icon:pt,label:"Opacity",color:"hsl(0, 0%, 50%)"})]}),r.jsxs("div",{className:"grid grid-cols-4",children:[r.jsx("div",{className:"border-r border-border",children:r.jsx(xe,{icon:It,label:"Undo",onClick:b})}),r.jsx("div",{className:"border-r border-border",children:r.jsx(xe,{icon:St,label:"Redo",onClick:d})}),r.jsx("div",{className:"border-r border-border",children:r.jsx(xe,{icon:Tt,label:"Clear Canvas",onClick:j})}),r.jsx("div",{children:r.jsx(xe,{icon:Mt,label:"Export",onClick:O,isPrimary:!0})})]})]})]})})}const At=({size:e,onSizeChange:t,smoothing:n,onSmoothingChange:s,thinning:c,onThinningChange:f,streamline:b,onStreamlineChange:d,startTaper:j,onStartTaperChange:O,startCap:T,onStartCapChange:F,endTaper:z,onEndTaperChange:E,endCap:x,onEndCapChange:h,isVisible:R,onClose:V})=>{const[A,k]=o.useState({x:50,y:50}),[u,v]=o.useState(!1),a=o.useRef({x:0,y:0}),L=o.useRef(null);o.useEffect(()=>{const p=m=>{if(!u||!L.current)return;const P=m.clientX-a.current.x,I=m.clientY-a.current.y;k(Y=>({x:Y.x+P,y:Y.y+I})),a.current={x:m.clientX,y:m.clientY}},S=()=>{v(!1)};return u&&(document.addEventListener("mousemove",p),document.addEventListener("mouseup",S)),()=>{document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",S)}},[u]);const l=p=>{p.target.closest(".admin-panel-header")&&(v(!0),a.current={x:p.clientX,y:p.clientY})},C="block text-xs font-medium text-gray-700 mb-0.5";return R?r.jsxs("div",{ref:L,className:"absolute bg-white p-4 rounded-lg shadow-xl border border-gray-300 w-64 text-sm",style:{top:`${A.y}px`,left:`${A.x}px`,cursor:u?"grabbing":"default",zIndex:1e3},onMouseDown:l,children:[r.jsxs("div",{className:"admin-panel-header flex justify-between items-center mb-3 pb-2 border-b border-gray-200",style:{cursor:"grab"},children:[r.jsx("h3",{className:"text-base font-semibold",children:"Admin Controls"}),r.jsx("button",{onClick:V,className:"text-gray-500 hover:text-gray-700 text-lg",children:"×"})]}),r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"size",className:C,children:["Size: ",e.toFixed(2)]}),r.jsx("input",{type:"range",id:"size",min:"1",max:"100",step:"1",value:e,onChange:p=>t(parseFloat(p.target.value)),className:"w-full"})]}),r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"smoothing",className:C,children:["Smoothing: ",n.toFixed(2)]}),r.jsx("input",{type:"range",id:"smoothing",min:"0",max:"1",step:"0.01",value:n,onChange:p=>s(parseFloat(p.target.value)),className:"w-full"})]}),r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"thinning",className:C,children:["Thinning: ",c.toFixed(2)]}),r.jsx("input",{type:"range",id:"thinning",min:"-1",max:"1",step:"0.01",value:c,onChange:p=>f(parseFloat(p.target.value)),className:"w-full"})]}),r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"streamline",className:C,children:["Streamline: ",b.toFixed(2)]}),r.jsx("input",{type:"range",id:"streamline",min:"0",max:"1",step:"0.01",value:b,onChange:p=>d(parseFloat(p.target.value)),className:"w-full"})]}),r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"startTaper",className:C,children:["Start Taper: ",j.toFixed(2)]}),r.jsx("input",{type:"range",id:"startTaper",min:"0",max:"100",step:"1",value:j,onChange:p=>O(parseFloat(p.target.value)),className:"w-full"})]}),r.jsxs("div",{className:"flex items-center",children:[r.jsx("input",{type:"checkbox",id:"startCap",checked:T,onChange:p=>F(p.target.checked),className:"mr-2"}),r.jsx("label",{htmlFor:"startCap",className:C+" mb-0",children:"Start Cap"})]}),r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"endTaper",className:C,children:["End Taper: ",z.toFixed(2)]}),r.jsx("input",{type:"range",id:"endTaper",min:"0",max:"100",step:"1",value:z,onChange:p=>E(parseFloat(p.target.value)),className:"w-full"})]}),r.jsxs("div",{className:"flex items-center",children:[r.jsx("input",{type:"checkbox",id:"endCap",checked:x,onChange:p=>h(p.target.checked),className:"mr-2"}),r.jsx("label",{htmlFor:"endCap",className:C+" mb-0",children:"End Cap"})]})]})]}):null};function _t({sessionId:e,userCount:t,currentUser:n}){const[s,c]=o.useState(!1),f=async()=>{if(!e)return;const b=`${window.location.origin}?session=${e}`;await navigator.clipboard.writeText(b),c(!0),setTimeout(()=>c(!1),2e3)};return e?r.jsxs("div",{className:"absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 max-w-sm",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[r.jsx("div",{className:"w-4 h-4 rounded-full",style:{backgroundColor:n.color}}),r.jsx("span",{className:"font-medium text-sm",children:n.name})]}),r.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[r.jsx(Dt,{className:"w-4 h-4 text-gray-500"}),r.jsxs("span",{className:"text-sm text-gray-600",children:[t," user",t!==1?"s":""," online"]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Rt,{className:"w-4 h-4 text-gray-500"}),r.jsxs("button",{onClick:f,className:"flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700 transition-colors",children:[r.jsx(ht,{className:"w-3 h-3"}),s?"Copied!":"Share session"]})]}),r.jsxs("div",{className:"mt-2 text-xs text-gray-500 font-mono bg-gray-50 p-2 rounded",children:["Session: ",e.slice(-8)]})]}):null}function zt({isConnected:e,connectionMode:t,metrics:n,className:s=""}){const c=()=>e?t==="mesh"?"bg-green-500":t==="sfu"?"bg-blue-500":"bg-yellow-500":"bg-gray-500",f=()=>e?t==="mesh"?"P2P Direct":t==="sfu"?"P2P Relay":"Fallback Mode":"Disconnected";return r.jsxs("div",{className:`flex items-center gap-2 text-sm ${s}`,children:[r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("div",{className:`w-2 h-2 rounded-full ${c()}`}),r.jsx("span",{className:"text-gray-600",children:f()})]}),n&&e&&r.jsxs("div",{className:"flex items-center gap-3 text-xs text-gray-500",children:[r.jsxs("span",{children:["Peers: ",n.connectedPeers]}),r.jsxs("span",{children:["Latency: ",n.latency,"ms"]}),r.jsxs("span",{children:["Sent: ",n.packetsSent]}),r.jsxs("span",{children:["Recv: ",n.packetsReceived]})]})]})}function Vt(){return"true"==="true"}function Ht(){return!Vt()}function Ot(){const e=o.useRef(null),[t,n]=o.useState("#000000"),[s,c]=o.useState(20),[f,b]=o.useState(1),[d,j]=o.useState(.35),[O,T]=o.useState(.2),[F,z]=o.useState(.4),[E,x]=o.useState(0),[h,R]=o.useState(!0),[V,A]=o.useState(0),[k,u]=o.useState(!0),v=D=>D,[a,L]=o.useState([]),[l,C]=o.useState(-1),[p,S]=o.useState(null),m=Ht(),[P,I]=o.useState(m),{createNewSession:Y,presence:Z,currentUser:y,clearSession:N}=Ee(p),{isConnected:U,connectionMode:_,metrics:G}=Re({sessionId:p,userId:y.id,enabled:!0});o.useEffect(()=>{(async()=>{try{const W=new URLSearchParams(window.location.search).get("session");if(W)S(W);else{const ae=await Y("Collaborative Painting",800,600);S(ae),window.history.replaceState({},"",`?session=${ae}`)}}catch(H){console.error("Failed to create/join session:",H)}})()},[Y]);const J=()=>{const D=e.current?.getImageData();if(D){const H=a.slice(0,l+1);H.push(D),L(H),C(H.length-1)}},ce=()=>{l>0?C(l-1):e.current?.undo()},le=()=>{l<a.length-1&&C(l+1)},ie=async()=>{e.current?.clear(),L([]),C(-1);try{await N()}catch(D){console.error("Failed to clear session:",D)}},re=()=>{const D=e.current?.getImageData();if(D){const H=document.createElement("a");H.download=`ipaintai-${Date.now()}.png`,H.href=D,H.click()}},oe=o.useCallback(()=>{I(D=>!D)},[]);return o.useEffect(()=>{if(!m)return;const D=H=>{H.ctrlKey&&H.shiftKey&&H.key==="A"&&(H.preventDefault(),oe())};return window.addEventListener("keydown",D),()=>{window.removeEventListener("keydown",D)}},[oe,m]),r.jsxs("div",{className:"relative w-full h-full bg-gray-50",children:[m&&r.jsxs("button",{onClick:oe,className:"absolute top-2 right-28 z-50 bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs",title:"Toggle Admin Panel (Ctrl+Shift+A)",children:[P?"Hide":"Show"," Admin"]}),p?r.jsx(Le,{ref:e,sessionId:p,color:t,size:s,opacity:f,smoothing:d,thinning:O,streamline:F,easing:v,startTaper:E,startCap:h,endTaper:V,endCap:k,onStrokeEnd:J}):r.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:"Creating painting session..."})]})}),r.jsx(_t,{sessionId:p,userCount:Z.length+1,currentUser:y}),r.jsx(zt,{isConnected:U,connectionMode:_,metrics:G,className:"absolute bottom-2 left-2 z-10"}),r.jsx(Ft,{color:t,size:s,opacity:f,onColorChange:n,onSizeChange:c,onOpacityChange:b,onUndo:ce,onRedo:le,onClear:ie,onExport:re}),m&&r.jsx(At,{isVisible:P,onClose:oe,size:s,onSizeChange:c,smoothing:d,onSmoothingChange:j,thinning:O,onThinningChange:T,streamline:F,onStreamlineChange:z,startTaper:E,onStartTaperChange:x,startCap:h,onStartCapChange:R,endTaper:V,onEndTaperChange:A,endCap:k,onEndCapChange:u})]})}const Yt=function(){return r.jsx(Ot,{})};export{Yt as component};
