import{jsxs as h,Fragment as Pe,jsx as a}from"react/jsx-runtime";import O,{useState as C,useRef as Q,useEffect as K,useCallback as j,useMemo as Ne,forwardRef as Me,useImperativeHandle as Ee}from"react";import{getStroke as Re}from"perfect-freehand";import{useQuery as se,useMutation as G,useConvex as Ie}from"convex/react";import{anyApi as Ue}from"convex/server";import{ChevronUp as De,Paintbrush as Le,RotateCcw as Te,FolderOpen as Fe,Palette as $e,Circle as Ae,Eye as ze,Undo2 as Oe,Redo2 as Xe,X as Ve,Save as Ye,Pipette as _e,Users as He,Share2 as Be,Copy as Ke}from"lucide-react";const U=Ue;function ge(t){const[e]=C(()=>({id:crypto.randomUUID(),name:`User ${Math.floor(Math.random()*1e3)}`,color:`hsl(${Math.floor(Math.random()*360)}, 70%, 50%)`})),n=se(U.paintingSessions.getSession,t?{sessionId:t}:"skip"),r=se(U.strokes.getSessionStrokes,t?{sessionId:t}:"skip"),l=se(U.presence.getSessionPresence,t?{sessionId:t}:"skip"),p=se(U.liveStrokes.getLiveStrokes,t?{sessionId:t}:"skip"),y=G(U.paintingSessions.createSession),P=G(U.strokes.addStroke),D=G(U.strokes.clearSession),B=G(U.presence.updatePresence),X=G(U.presence.leaveSession),V=G(U.liveStrokes.updateLiveStroke),z=G(U.liveStrokes.clearLiveStroke),_=G(U.liveStrokes.clearSessionLiveStrokes),x=G(U.viewerAcks.upsertViewerState),u=G(U.viewerAcks.removeViewerState),I=se(U.viewerAcks.getViewerState,t?{sessionId:t,viewerId:e.id}:"skip"),L=Q(0);K(()=>{I?.lastAckedStrokeOrder&&(L.current=I.lastAckedStrokeOrder)},[I]),K(()=>{if(r&&r.length>0&&t){const f=r.reduce((M,F)=>Math.max(M,F.strokeOrder),0);f>L.current&&(L.current=f,x({sessionId:t,viewerId:e.id,lastAckedStrokeOrder:f}))}},[r,t,e.id,x]);const T=j(async(f,M=800,F=600)=>await y({name:f,canvasWidth:M,canvasHeight:F,isPublic:!0}),[y]),w=j(async(f,M,F,H=1)=>{if(t)return await P({sessionId:t,userColor:e.color,points:f,brushColor:M,brushSize:F,opacity:H})},[t,P,e.color]),c=j(async(f,M,F,H)=>{if(t)return await B({sessionId:t,userColor:e.color,userName:e.name,cursorX:f,cursorY:M,isDrawing:F,currentTool:H})},[t,B,e]),N=j(async()=>{t&&await Promise.all([D({sessionId:t}),_({sessionId:t})])},[t,D,_]),o=Q(null),R=Q(null),i=Q(0),v=j((f,M,F,H=1)=>{if(!t)return;const q=Date.now(),Z=q-i.current;if(R.current={points:f,brushColor:M,brushSize:F,opacity:H},f.length===1||Z>=16){i.current=q,V({sessionId:t,userColor:e.color,userName:e.name,points:f,brushColor:M,brushSize:F,opacity:H}),R.current=null,o.current&&(clearTimeout(o.current),o.current=null);return}o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{const W=R.current;W&&(i.current=Date.now(),V({sessionId:t,userColor:e.color,userName:e.name,points:W.points,brushColor:W.brushColor,brushSize:W.brushSize,opacity:W.opacity}),R.current=null),o.current=null},16)},[t,V,e]),m=j(async()=>{if(t)return await z({sessionId:t})},[t,z]);K(()=>{const f=t,M=e.id;return()=>{f&&(X({sessionId:f}),u({sessionId:f,viewerId:M})),o.current&&clearTimeout(o.current)}},[t,X,u,e.id]);const S=Ne(()=>r||[],[r]);return{session:n,strokes:S,presence:l||[],liveStrokes:p||[],currentUser:e,createNewSession:T,addStrokeToSession:w,updateUserPresence:c,clearSession:N,updateLiveStrokeForUser:v,clearLiveStrokeForUser:m,isLoading:n===void 0}}const je={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}],dataChannelOptions:{ordered:!1,maxRetransmits:0,protocol:"paint-preview"},maxPeersForMesh:4,sfuUrl:void 0,turnUrl:void 0,turnUsername:void 0,turnCredential:void 0};function We(){const t={...je};if(typeof window<"u"){const e=window.__ENV__||{};e.VITE_SFU_URL&&(t.sfuUrl=e.VITE_SFU_URL),e.VITE_TURN_URL&&(t.turnUrl=e.VITE_TURN_URL,t.turnUsername=e.VITE_TURN_USERNAME,t.turnCredential=e.VITE_TURN_CREDENTIAL,t.iceServers.push({urls:t.turnUrl,username:t.turnUsername,credential:t.turnCredential}))}return t}function Qe(t){const e=new ArrayBuffer(22),n=new DataView(e);n.setUint8(0,t.t.charCodeAt(0)),n.setUint8(1,t.t.charCodeAt(1));const r=t.id.substring(0,8);for(let l=0;l<8;l++)n.setUint8(2+l,r.charCodeAt(l)||0);return n.setFloat32(10,t.x,!0),n.setFloat32(14,t.y,!0),n.setFloat32(18,t.p,!0),e}function qe(t){if(t.byteLength!==22)return console.error("Invalid packet size:",t.byteLength),null;const e=new DataView(t),n=String.fromCharCode(e.getUint8(0),e.getUint8(1));if(n!=="pt")return console.error("Invalid packet type:",n),null;let r="";for(let P=0;P<8;P++)r+=String.fromCharCode(e.getUint8(2+P));const l=e.getFloat32(10,!0),p=e.getFloat32(14,!0),y=e.getFloat32(18,!0);return{t:"pt",id:r,x:l,y:p,p:y}}class Ge{config;peers=new Map;mode="mesh";convexClient;sessionId;peerId;roomKey;pollingInterval=null;metrics={latency:0,packetsSent:0,packetsReceived:0,bytesTransferred:0,connectedPeers:0};onPacketReceived;onPeerConnected;onPeerDisconnected;onModeChanged;constructor(e){this.config=We(),this.convexClient=e.convexClient,this.sessionId=e.sessionId,this.peerId=e.peerId,this.roomKey=e.roomKey,this.onPacketReceived=e.onPacketReceived,this.onPeerConnected=e.onPeerConnected,this.onPeerDisconnected=e.onPeerDisconnected,this.onModeChanged=e.onModeChanged}async init(){try{const{peers:e,mode:n}=await this.convexClient.mutation(U.webrtc.joinP2PSession,{sessionId:this.sessionId,peerId:this.peerId,roomKey:this.roomKey});this.mode=n,this.onModeChanged?.(n);for(const r of e)await this.connectToPeer(r);this.startSignalPolling()}catch(e){console.error("Failed to initialize P2P:",e),this.mode="fallback",this.onModeChanged?.("fallback")}}async connectToPeer(e){if(this.peers.has(e))return;const n=new RTCPeerConnection({iceServers:this.config.iceServers}),r={peerId:e,connection:n,dataChannel:null,isConnected:!1};this.peers.set(e,r),n.onicecandidate=async y=>{y.candidate&&await this.sendSignal(e,"ice-candidate",y.candidate)};const l=n.createDataChannel("paint-preview",this.config.dataChannelOptions);this.setupDataChannel(l,r);const p=await n.createOffer();await n.setLocalDescription(p),await this.sendSignal(e,"offer",p)}setupDataChannel(e,n){n.dataChannel=e,e.onopen=()=>{n.isConnected=!0,this.metrics.connectedPeers++,this.onPeerConnected?.(n.peerId)},e.onclose=()=>{n.isConnected=!1,this.metrics.connectedPeers--,this.onPeerDisconnected?.(n.peerId)},e.onmessage=r=>{this.handleDataChannelMessage(n.peerId,r.data)},e.onerror=r=>{console.error(`Data channel error with peer ${n.peerId}:`,r)}}handleDataChannelMessage(e,n){if(n instanceof ArrayBuffer){const r=qe(n);r&&(this.metrics.packetsReceived++,this.metrics.bytesTransferred+=n.byteLength,this.onPacketReceived?.(e,r))}}async sendSignal(e,n,r){await this.convexClient.mutation(U.webrtc.sendSignal,{sessionId:this.sessionId,fromPeerId:this.peerId,toPeerId:e,type:n,data:r})}startSignalPolling(){this.pollingInterval=setInterval(async()=>{try{const e=await this.convexClient.query(U.webrtc.getSignals,{sessionId:this.sessionId,peerId:this.peerId});if(e.length>0){for(const r of e)await this.handleSignal(r);const n=e.map(r=>r.id);await this.convexClient.mutation(U.webrtc.deleteSignals,{signalIds:n})}}catch(e){console.error("Signal polling error:",e)}},1e3)}async handleSignal(e){let n=this.peers.get(e.fromPeerId);if(e.type==="offer"){if(!n){const l=new RTCPeerConnection({iceServers:this.config.iceServers});n={peerId:e.fromPeerId,connection:l,dataChannel:null,isConnected:!1},this.peers.set(e.fromPeerId,n),l.onicecandidate=async p=>{p.candidate&&await this.sendSignal(e.fromPeerId,"ice-candidate",p.candidate)},l.ondatachannel=p=>{this.setupDataChannel(p.channel,n)}}await n.connection.setRemoteDescription(e.data);const r=await n.connection.createAnswer();await n.connection.setLocalDescription(r),await this.sendSignal(e.fromPeerId,"answer",r)}else e.type==="answer"&&n?await n.connection.setRemoteDescription(e.data):e.type==="ice-candidate"&&n&&await n.connection.addIceCandidate(e.data)}sendPacket(e){const n=Qe(e);for(const r of this.peers.values())if(r.isConnected&&r.dataChannel?.readyState==="open")try{r.dataChannel.send(n),this.metrics.packetsSent++,this.metrics.bytesTransferred+=n.byteLength}catch(l){console.error(`Failed to send packet to peer ${r.peerId}:`,l)}}getMetrics(){return{...this.metrics}}async destroy(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null);for(const e of this.peers.values())e.dataChannel&&e.dataChannel.close(),e.connection.close();this.peers.clear();try{await this.convexClient.mutation(U.webrtc.leaveP2PSession,{sessionId:this.sessionId,peerId:this.peerId})}catch(e){console.error("Error leaving P2P session:",e)}}}function ve({sessionId:t,userId:e,enabled:n=!0}){const r=Ie(),l=Q(null),[p,y]=C(!1),[P,D]=C("fallback"),[B,X]=C(new Map),[V,z]=C(null),_=Q(null),x=j((w,c)=>{X(N=>{const o=new Map(N),R=`${w}:${c.id}`,i=o.get(R);return i?(i.points.push({x:c.x,y:c.y,pressure:c.p}),i.lastUpdate=Date.now()):o.set(R,{peerId:w,strokeId:c.id,points:[{x:c.x,y:c.y,pressure:c.p}],color:"#000000",size:5,lastUpdate:Date.now()}),o})},[]),u=j(w=>{console.log(`Peer connected: ${w}`),y(!0)},[]),I=j(w=>{console.log(`Peer disconnected: ${w}`),X(c=>{const N=new Map(c);for(const[o]of N)o.startsWith(`${w}:`)&&N.delete(o);return N})},[]);K(()=>{if(!n||!t)return;const w=`session-${t}`,c=new Ge({sessionId:t,peerId:e,roomKey:w,convexClient:r,onPacketReceived:x,onPeerConnected:u,onPeerDisconnected:I,onModeChanged:D});return l.current=c,c.init().catch(N=>{console.error("Failed to initialize P2P:",N),D("fallback")}),_.current=setInterval(()=>{l.current&&z(l.current.getMetrics())},1e3),()=>{_.current&&clearInterval(_.current),c.destroy(),l.current=null,y(!1),X(new Map)}},[n,t,e,r,x,u,I]),K(()=>{const w=setInterval(()=>{const c=Date.now();X(N=>{const o=new Map(N);let R=!1;for(const[i,v]of o)c-v.lastUpdate>5e3&&(o.delete(i),R=!0);return R?o:N})},1e3);return()=>clearInterval(w)},[]);const L=j((w,c,N,o)=>{if(!l.current||!p)return;const R={t:"pt",id:w.substring(0,8),x:c,y:N,p:o};l.current.sendPacket(R)},[p]),T=j((w,c)=>{X(N=>{const o=new Map(N);return o.delete(`${w}:${c}`),o})},[]);return{isConnected:p,connectionMode:P,remoteStrokes:B,sendStrokePoint:L,clearRemoteStroke:T,metrics:V}}const ue=(t,e)=>(t+e)/2;function Ze(t,e=!0){const n=t.length;if(n<4)return"";let r=t[0],l=t[1];const p=t[2];let y=`M${r[0].toFixed(2)},${r[1].toFixed(2)} Q${l[0].toFixed(2)},${l[1].toFixed(2)} ${ue(l[0],p[0]).toFixed(2)},${ue(l[1],p[1]).toFixed(2)} T`;for(let P=2,D=n-1;P<D;P++)r=t[P],l=t[P+1],y+=`${ue(r[0],l[0]).toFixed(2)},${ue(r[1],l[1]).toFixed(2)} `;return e&&(y+="Z"),y}const be=Me(({sessionId:t,color:e,size:n,opacity:r,onStrokeEnd:l,smoothing:p=.75,thinning:y=.5,streamline:P=.65,easing:D=x=>x,startTaper:B=0,startCap:X=!0,endTaper:V=0,endCap:z=!0},_)=>{const x=Q(null),u=Q(null),[I,L]=C(!1),[T,w]=C([]),[c,N]=C(null),[o,R]=C(null),[i,v]=C(0),[m,S]=C(new Map),f=Q(!1),{strokes:M,presence:F,liveStrokes:H,currentUser:q,addStrokeToSession:Z,updateUserPresence:W,updateLiveStrokeForUser:he,clearLiveStrokeForUser:me}=ge(t),{isConnected:J,connectionMode:ne,remoteStrokes:ie,sendStrokePoint:ce}=ve({sessionId:t,userId:q.id,enabled:!0}),[le,re]=C(null);K(()=>{M.length>0&&S(s=>{const d=new Map(s);return M.forEach(g=>{for(const[k,b]of d)if(b.points.length===g.points.length&&b.color===g.brushColor&&b.size===g.brushSize){const Y=Math.abs(b.points[0].x-g.points[0].x)<1&&Math.abs(b.points[0].y-g.points[0].y)<1,A=b.points.length-1,oe=Math.abs(b.points[A].x-g.points[A].x)<1&&Math.abs(b.points[A].y-g.points[A].y)<1;if(Y&&oe){d.delete(k);break}}}),d})},[M]),K(()=>{const s=setInterval(()=>{S(d=>{const g=new Map(d);for(const[k]of g)if(g.size>5){g.delete(k);break}return g})},5e3);return()=>clearInterval(s)},[]),K(()=>{const s=x.current,d=u.current;if(!s||!d)return;const g=s.getContext("2d"),k=d.getContext("2d");if(!g||!k)return;const b=()=>{const Y=s.parentElement;if(Y){const{clientWidth:A,clientHeight:oe}=Y;s.width=A,s.height=oe,d.width=A,d.height=oe,te()}};return b(),N(g),R(k),window.addEventListener("resize",b),()=>window.removeEventListener("resize",b)},[]),K(()=>{te()},[M]);const te=j(()=>{!c||!x.current||(c.clearRect(0,0,x.current.width,x.current.height),M.sort((s,d)=>s.strokeOrder-d.strokeOrder).forEach(s=>{E(c,{points:s.points,color:s.brushColor,size:s.brushSize})}),m.forEach(s=>{E(c,s)}))},[c,M,m,p,y,P,D,B,X,V,z,r]),E=(s,d)=>{if(d.points.length===0)return;const g={size:d.size,smoothing:p,thinning:y,streamline:P,easing:D,start:{taper:B,cap:X},end:{taper:V,cap:z},last:!d.isLive},k=Re(d.points,g),b=Ze(k);if(b==="")return;s.fillStyle=d.color,s.globalAlpha=d.opacity!==void 0?d.opacity:r;const Y=new Path2D(b);s.fill(Y),s.globalAlpha=1},$=j(()=>{!o||!u.current||F.forEach(s=>{if(s.userName===q.name)return;o.fillStyle=s.userColor,o.beginPath(),o.arc(s.cursorX,s.cursorY,5,0,2*Math.PI),o.fill(),o.fillStyle="white",o.strokeStyle=s.userColor,o.lineWidth=2,o.font="12px Arial";const d=o.measureText(s.userName).width;o.strokeText(s.userName,s.cursorX-d/2,s.cursorY-10),o.fillText(s.userName,s.cursorX-d/2,s.cursorY-10)})},[o,F,q.name]);K(()=>{if(!I)return;const s=()=>{f.current||(f.current=!0,L(d=>(d&&w(g=>{if(g.length>0){const k=crypto.randomUUID(),b={points:g,color:e,size:n,opacity:r,id:k,isPending:!0};S(Y=>new Map(Y).set(k,b)),Z(g,e,n,r),c&&E(c,b)}return l?.(),o&&u.current&&o.clearRect(0,0,u.current.width,u.current.height),[]}),!1)))};return document.addEventListener("pointerup",s),()=>document.removeEventListener("pointerup",s)},[I,e,n,r,Z,l,c,o]),K(()=>{!o||!u.current||(o.clearRect(0,0,u.current.width,u.current.height),I&&T.length>0&&E(o,{points:T,color:e,size:n,opacity:r,isLive:!0}),J&&ie.forEach(s=>{s.points.length>0&&E(o,{points:s.points,color:s.color,size:s.size,opacity:.8,isLive:!0})}),(!J||ne==="fallback")&&H.forEach(s=>{s.userName!==q.name&&E(o,{points:s.points,color:s.brushColor,size:s.brushSize,opacity:s.opacity,isLive:!0})}),$())},[o,T,I,e,n,r,H,q.name,$,J,ne,ie]);const ee=s=>{const d=u.current,g=d?.getBoundingClientRect();if(!g||!d)return{x:0,y:0};const k=d.width/g.width,b=d.height/g.height;return{x:(s.clientX-g.left)*k,y:(s.clientY-g.top)*b,pressure:s.pressure}},de=s=>{if(!o||!u.current)return;s.currentTarget.setPointerCapture(s.pointerId),L(!0),f.current=!1,o.clearRect(0,0,u.current.width,u.current.height);const d=ee(s);w([d]),W(d.x,d.y,!0,"brush");const g=crypto.randomUUID();if(re(g),J&&u.current){const k=d.x/u.current.width,b=d.y/u.current.height;ce(g,k,b,d.pressure||.5)}},Ce=s=>{if(!I||!o||!u.current){const A=ee(s);W(A.x,A.y,!1,"brush");return}const d=s.nativeEvent,k=(d.getCoalescedEvents?.()??[d]).map(A=>ee({clientX:A.clientX,clientY:A.clientY,pressure:A.pressure,currentTarget:s.currentTarget,target:A.target}));if(k.length===0)return;const b=k[k.length-1];W(b.x,b.y,I,"brush");const Y=[...T,...k];w(Y),J&&le&&u.current&&k.forEach(A=>{const oe=A.x/u.current.width,ke=A.y/u.current.height;ce(le,oe,ke,A.pressure||.5)}),(!J||ne==="fallback")&&he(Y,e,n,r),o.clearRect(0,0,u.current.width,u.current.height),E(o,{points:Y,color:e,size:n,opacity:r,isLive:!0}),$()},xe=s=>{if(!I||!o||!u.current||f.current)return;f.current=!0,s.currentTarget.releasePointerCapture(s.pointerId),L(!1),o.clearRect(0,0,u.current.width,u.current.height);const d=ee(s);W(d.x,d.y,!1,"brush");const g=[...T,d];if(g.length>0){const k=crypto.randomUUID(),b={points:g,color:e,size:n,opacity:r,id:k,isPending:!0};S(Y=>new Map(Y).set(k,b)),Z(g,e,n,r),(!J||ne==="fallback")&&me(),re(null),c&&E(c,b)}w([]),re(null),l?.()},Se=s=>{if(!I||f.current)return;f.current=!0,s.currentTarget.releasePointerCapture(s.pointerId),L(!1),o&&u.current&&o.clearRect(0,0,u.current.width,u.current.height);const d=ee(s);W(d.x,d.y,!1,"brush");const g=[...T,d];if(g.length>0){const k=crypto.randomUUID(),b={points:g,color:e,size:n,opacity:r,id:k,isPending:!0};S(Y=>new Map(Y).set(k,b)),Z(g,e,n,r),c&&E(c,b)}w([]),re(null),l?.()};return Ee(_,()=>({clear:()=>{c&&x.current&&c.clearRect(0,0,x.current.width,x.current.height),o&&u.current&&o.clearRect(0,0,u.current.width,u.current.height),S(new Map)},undo:()=>{},getImageData:()=>x.current?.toDataURL("image/png")}),[c,o]),h(Pe,{children:[a("canvas",{ref:x,className:"absolute inset-0 w-full h-full border border-gray-300",style:{zIndex:0}}),a("canvas",{ref:u,className:"absolute inset-0 w-full h-full",onPointerDown:de,onPointerMove:Ce,onPointerUp:xe,onPointerLeave:Se,style:{touchAction:"none",zIndex:1}})]})});be.displayName="Canvas";const fe=[{id:"brush",icon:Le,label:"Brush",ariaLabel:"Select brush tool",keyboardShortcut:"B"},{id:"rotate",icon:Te,label:"Rotate",ariaLabel:"Rotate canvas",keyboardShortcut:"R"},{id:"folder",icon:Fe,label:"Open",ariaLabel:"Open file",keyboardShortcut:"O"},{id:"inpaint",icon:$e,label:"Inpaint",ariaLabel:"Inpaint tool",keyboardShortcut:"I"}],pe=O.memo(({value:t,min:e,max:n,onChange:r,icon:l,label:p,color:y})=>{const P=(t-e)/(n-e)*100;return h("div",{className:"flex items-center gap-2 mb-3",role:"group","aria-labelledby":`${p.toLowerCase()}-slider-label`,children:[a(l,{className:"w-4 h-4 text-muted-foreground flex-shrink-0","aria-hidden":"true"}),h("div",{className:"relative flex-1 h-6 flex items-center",children:[a("div",{className:"h-1 w-full bg-secondary rounded-full overflow-hidden",role:"presentation",children:a("div",{className:"h-full transition-all duration-100",style:{width:`${P}%`,backgroundColor:y}})}),a("div",{className:"absolute top-1/2 -translate-y-1/2 w-3 h-3 rounded-full pointer-events-none",style:{left:`calc(${P}% - 6px)`,backgroundColor:y},role:"presentation"}),a("input",{type:"range",min:e,max:n,value:t,onChange:D=>r(Number(D.target.value)),className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer","aria-valuemin":e,"aria-valuemax":n,"aria-valuenow":t,"aria-labelledby":`${p.toLowerCase()}-slider-label`}),h("span",{id:`${p.toLowerCase()}-slider-label`,className:"sr-only",children:[p," slider"]})]})]})});pe.displayName="Slider";const we=O.memo(({tool:t,isSelected:e,onClick:n})=>a("button",{onClick:n,className:`w-8 h-8 flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-1 focus-visible:ring-primary ${e?"bg-gray-200 text-gray-900":"bg-secondary text-secondary-foreground hover:bg-secondary/80"}`,title:`${t.label}${t.keyboardShortcut?` (${t.keyboardShortcut})`:""}`,"aria-label":t.ariaLabel,"aria-pressed":e,children:a(t.icon,{className:`w-4 h-4 ${e?"scale-110 transition-transform":""}`})},t.id));we.displayName="ToolButton";const ae=O.memo(({icon:t,label:e,onClick:n,isPrimary:r=!1})=>a("button",{onClick:n,className:`w-8 h-8 flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-1 focus-visible:ring-primary ${r?"bg-primary text-primary-foreground hover:bg-primary/90":"bg-secondary text-secondary-foreground hover:bg-secondary/80"}`,title:e,"aria-label":e,children:a(t,{className:"w-4 h-4"})}));ae.displayName="ActionButton";const ye=O.memo(({color:t,onColorChange:e})=>{const n=O.useRef(null);return h("div",{className:"flex items-center gap-2 mb-3",role:"group","aria-labelledby":"color-mixer-label",children:[a(_e,{className:"w-4 h-4 text-muted-foreground flex-shrink-0","aria-hidden":"true"}),a("button",{onClick:()=>{n.current?.click()},className:"flex-1 h-6 border border-border rounded transition-all duration-100 hover:border-primary focus:outline-none focus-visible:ring-1 focus-visible:ring-primary",style:{backgroundColor:t},title:"Click to change color","aria-label":"Current brush color, click to change",children:h("span",{className:"sr-only",children:["Current color: ",t]})}),a("input",{ref:n,type:"color",value:t,onChange:p=>{e(p.target.value)},className:"sr-only","aria-label":"Color picker"}),a("span",{id:"color-mixer-label",className:"sr-only",children:"Color mixer"})]})});ye.displayName="ColorMixer";function Je({color:t,size:e,opacity:n,onColorChange:r,onSizeChange:l,onOpacityChange:p,onUndo:y,onRedo:P,onClear:D,onExport:B}){const[X,V]=O.useState("brush"),[z,_]=O.useState(!1),[x,u]=O.useState(!1),[I,L]=O.useState({x:24,y:200}),[T,w]=O.useState({x:0,y:0}),c=O.useRef(null);O.useEffect(()=>{typeof window<"u"&&L({x:24,y:window.innerHeight/2-150})},[]);const N=O.useCallback(i=>{i.preventDefault(),u(!0);const v="touches"in i?i.touches[0].clientX:i.clientX,m="touches"in i?i.touches[0].clientY:i.clientY;if(c.current){const S=c.current.getBoundingClientRect();w({x:v-S.left,y:m-S.top})}},[]),o=O.useCallback(i=>{if(!x)return;const v="touches"in i?i.touches[0].clientX:i.clientX,m="touches"in i?i.touches[0].clientY:i.clientY,S=v-T.x,f=m-T.y,M=window.innerWidth-(c.current?.offsetWidth||200),F=window.innerHeight-(c.current?.offsetHeight||300);L({x:Math.max(0,Math.min(S,M)),y:Math.max(0,Math.min(f,F))})},[x,T]),R=O.useCallback(()=>{u(!1)},[]);return O.useEffect(()=>{if(x){const i=f=>o(f),v=()=>R(),m=f=>o(f),S=()=>R();return document.addEventListener("mousemove",i),document.addEventListener("mouseup",v),document.addEventListener("touchmove",m,{passive:!1}),document.addEventListener("touchend",S),()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",v),document.removeEventListener("touchmove",m),document.removeEventListener("touchend",S)}}},[x,o,R]),O.useEffect(()=>{const i=()=>{const v=window.innerWidth-(c.current?.offsetWidth||200),m=window.innerHeight-(c.current?.offsetHeight||300);L(S=>({x:Math.max(0,Math.min(S.x,v)),y:Math.max(0,Math.min(S.y,m))}))};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),O.useEffect(()=>{const i=v=>{if(v.target instanceof HTMLInputElement||v.target instanceof HTMLTextAreaElement)return;const m=v.key.toUpperCase(),S=fe.find(f=>f.keyboardShortcut===m);S&&V(S.id)};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[]),a("div",{ref:c,className:"fixed z-50 select-none",style:{left:`${I.x}px`,top:`${I.y}px`,transition:x?"none":"transform 0.15s ease-out"},role:"toolbar","aria-label":"ipaint.ai tools",children:h("div",{className:"bg-background/95 backdrop-blur-sm border border-border overflow-hidden",style:{width:"180px"},children:[h("div",{className:`flex items-center justify-between px-2 py-1.5 border-b border-border ${x?"cursor-grabbing":"cursor-grab"}`,onMouseDown:N,onTouchStart:N,"aria-label":"Drag to move panel",role:"button",children:[a("div",{className:"flex items-center",children:a("span",{className:"text-xs font-medium text-foreground/80",children:"ipaint.ai"})}),a("button",{onClick:i=>{i.stopPropagation(),_(!z)},onMouseDown:i=>i.stopPropagation(),onTouchStart:i=>i.stopPropagation(),className:"p-1 hover:bg-secondary/80 transition-colors","aria-expanded":!z,"aria-label":z?"Expand tools panel":"Collapse tools panel",children:a(De,{className:`w-3.5 h-3.5 text-muted-foreground transition-transform ${z?"":"rotate-180"}`})})]}),!z&&h("div",{className:"p-2",children:[a("div",{className:"grid grid-cols-4 border-b border-border mb-3",children:fe.map((i,v)=>a("div",{className:`${v<fe.length-1?"border-r border-border":""}`,children:a(we,{tool:i,isSelected:X===i.id,onClick:()=>V(i.id)})},i.id))}),a("div",{className:"border-b border-border mb-3 pb-3",children:a(ye,{color:t,onColorChange:r})}),h("div",{className:"border-b border-border mb-3 pb-3",children:[a(pe,{value:e,min:1,max:100,onChange:l,icon:Ae,label:"Brush Size",color:"hsl(var(--primary))"}),a(pe,{value:n*100,min:0,max:100,onChange:i=>p(i/100),icon:ze,label:"Opacity",color:"hsl(0, 0%, 50%)"})]}),h("div",{className:"grid grid-cols-4",children:[a("div",{className:"border-r border-border",children:a(ae,{icon:Oe,label:"Undo",onClick:y})}),a("div",{className:"border-r border-border",children:a(ae,{icon:Xe,label:"Redo",onClick:P})}),a("div",{className:"border-r border-border",children:a(ae,{icon:Ve,label:"Clear Canvas",onClick:D})}),a("div",{children:a(ae,{icon:Ye,label:"Export",onClick:B,isPrimary:!0})})]})]})]})})}const et=({size:t,onSizeChange:e,smoothing:n,onSmoothingChange:r,thinning:l,onThinningChange:p,streamline:y,onStreamlineChange:P,startTaper:D,onStartTaperChange:B,startCap:X,onStartCapChange:V,endTaper:z,onEndTaperChange:_,endCap:x,onEndCapChange:u,isVisible:I,onClose:L})=>{const[T,w]=C({x:50,y:50}),[c,N]=C(!1),o=Q({x:0,y:0}),R=Q(null);K(()=>{const m=f=>{if(!c||!R.current)return;const M=f.clientX-o.current.x,F=f.clientY-o.current.y;w(H=>({x:H.x+M,y:H.y+F})),o.current={x:f.clientX,y:f.clientY}},S=()=>{N(!1)};return c&&(document.addEventListener("mousemove",m),document.addEventListener("mouseup",S)),()=>{document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",S)}},[c]);const i=m=>{m.target.closest(".admin-panel-header")&&(N(!0),o.current={x:m.clientX,y:m.clientY})},v="block text-xs font-medium text-gray-700 mb-0.5";return I?h("div",{ref:R,className:"absolute bg-white p-4 rounded-lg shadow-xl border border-gray-300 w-64 text-sm",style:{top:`${T.y}px`,left:`${T.x}px`,cursor:c?"grabbing":"default",zIndex:1e3},onMouseDown:i,children:[h("div",{className:"admin-panel-header flex justify-between items-center mb-3 pb-2 border-b border-gray-200",style:{cursor:"grab"},children:[a("h3",{className:"text-base font-semibold",children:"Admin Controls"}),a("button",{onClick:L,className:"text-gray-500 hover:text-gray-700 text-lg",children:"Ã—"})]}),h("div",{className:"space-y-3",children:[h("div",{children:[h("label",{htmlFor:"size",className:v,children:["Size: ",t.toFixed(2)]}),a("input",{type:"range",id:"size",min:"1",max:"100",step:"1",value:t,onChange:m=>e(parseFloat(m.target.value)),className:"w-full"})]}),h("div",{children:[h("label",{htmlFor:"smoothing",className:v,children:["Smoothing: ",n.toFixed(2)]}),a("input",{type:"range",id:"smoothing",min:"0",max:"1",step:"0.01",value:n,onChange:m=>r(parseFloat(m.target.value)),className:"w-full"})]}),h("div",{children:[h("label",{htmlFor:"thinning",className:v,children:["Thinning: ",l.toFixed(2)]}),a("input",{type:"range",id:"thinning",min:"-1",max:"1",step:"0.01",value:l,onChange:m=>p(parseFloat(m.target.value)),className:"w-full"})]}),h("div",{children:[h("label",{htmlFor:"streamline",className:v,children:["Streamline: ",y.toFixed(2)]}),a("input",{type:"range",id:"streamline",min:"0",max:"1",step:"0.01",value:y,onChange:m=>P(parseFloat(m.target.value)),className:"w-full"})]}),h("div",{children:[h("label",{htmlFor:"startTaper",className:v,children:["Start Taper: ",D.toFixed(2)]}),a("input",{type:"range",id:"startTaper",min:"0",max:"100",step:"1",value:D,onChange:m=>B(parseFloat(m.target.value)),className:"w-full"})]}),h("div",{className:"flex items-center",children:[a("input",{type:"checkbox",id:"startCap",checked:X,onChange:m=>V(m.target.checked),className:"mr-2"}),a("label",{htmlFor:"startCap",className:v+" mb-0",children:"Start Cap"})]}),h("div",{children:[h("label",{htmlFor:"endTaper",className:v,children:["End Taper: ",z.toFixed(2)]}),a("input",{type:"range",id:"endTaper",min:"0",max:"100",step:"1",value:z,onChange:m=>_(parseFloat(m.target.value)),className:"w-full"})]}),h("div",{className:"flex items-center",children:[a("input",{type:"checkbox",id:"endCap",checked:x,onChange:m=>u(m.target.checked),className:"mr-2"}),a("label",{htmlFor:"endCap",className:v+" mb-0",children:"End Cap"})]})]})]}):null};function tt({sessionId:t,userCount:e,currentUser:n}){const[r,l]=C(!1),p=async()=>{if(!t)return;const y=`${window.location.origin}?session=${t}`;await navigator.clipboard.writeText(y),l(!0),setTimeout(()=>l(!1),2e3)};return t?h("div",{className:"absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 max-w-sm",children:[h("div",{className:"flex items-center gap-2 mb-3",children:[a("div",{className:"w-4 h-4 rounded-full",style:{backgroundColor:n.color}}),a("span",{className:"font-medium text-sm",children:n.name})]}),h("div",{className:"flex items-center gap-2 mb-2",children:[a(He,{className:"w-4 h-4 text-gray-500"}),h("span",{className:"text-sm text-gray-600",children:[e," user",e!==1?"s":""," online"]})]}),h("div",{className:"flex items-center gap-2",children:[a(Be,{className:"w-4 h-4 text-gray-500"}),h("button",{onClick:p,className:"flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700 transition-colors",children:[a(Ke,{className:"w-3 h-3"}),r?"Copied!":"Share session"]})]}),h("div",{className:"mt-2 text-xs text-gray-500 font-mono bg-gray-50 p-2 rounded",children:["Session: ",t.slice(-8)]})]}):null}function nt({isConnected:t,connectionMode:e,metrics:n,className:r=""}){const l=()=>t?e==="mesh"?"bg-green-500":e==="sfu"?"bg-blue-500":"bg-yellow-500":"bg-gray-500",p=()=>t?e==="mesh"?"P2P Direct":e==="sfu"?"P2P Relay":"Fallback Mode":"Disconnected";return h("div",{className:`flex items-center gap-2 text-sm ${r}`,children:[h("div",{className:"flex items-center gap-1",children:[a("div",{className:`w-2 h-2 rounded-full ${l()}`}),a("span",{className:"text-gray-600",children:p()})]}),n&&t&&h("div",{className:"flex items-center gap-3 text-xs text-gray-500",children:[h("span",{children:["Peers: ",n.connectedPeers]}),h("span",{children:["Latency: ",n.latency,"ms"]}),h("span",{children:["Sent: ",n.packetsSent]}),h("span",{children:["Recv: ",n.packetsReceived]})]})]})}function rt(){return"true"==="true"}function ot(){return!rt()}function st(){const t=Q(null),[e,n]=C("#000000"),[r,l]=C(20),[p,y]=C(1),[P,D]=C(.35),[B,X]=C(.2),[V,z]=C(.4),[_,x]=C(0),[u,I]=C(!0),[L,T]=C(0),[w,c]=C(!0),N=E=>E,[o,R]=C([]),[i,v]=C(-1),[m,S]=C(null),f=ot(),[M,F]=C(f),{createNewSession:H,presence:q,currentUser:Z,clearSession:W}=ge(m),{isConnected:he,connectionMode:me,metrics:J}=ve({sessionId:m,userId:Z.id,enabled:!0});K(()=>{(async()=>{try{const ee=new URLSearchParams(window.location.search).get("session");if(ee)S(ee);else{const de=await H("Collaborative Painting",800,600);S(de),window.history.replaceState({},"",`?session=${de}`)}}catch($){console.error("Failed to create/join session:",$)}})()},[H]);const ne=()=>{const E=t.current?.getImageData();if(E){const $=o.slice(0,i+1);$.push(E),R($),v($.length-1)}},ie=()=>{i>0?v(i-1):t.current?.undo()},ce=()=>{i<o.length-1&&v(i+1)},le=async()=>{t.current?.clear(),R([]),v(-1);try{await W()}catch(E){console.error("Failed to clear session:",E)}},re=()=>{const E=t.current?.getImageData();if(E){const $=document.createElement("a");$.download=`ipaintai-${Date.now()}.png`,$.href=E,$.click()}},te=j(()=>{F(E=>!E)},[]);return K(()=>{if(!f)return;const E=$=>{$.ctrlKey&&$.shiftKey&&$.key==="A"&&($.preventDefault(),te())};return window.addEventListener("keydown",E),()=>{window.removeEventListener("keydown",E)}},[te,f]),h("div",{className:"relative w-full h-full bg-gray-50",children:[f&&h("button",{onClick:te,className:"absolute top-2 right-28 z-50 bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs",title:"Toggle Admin Panel (Ctrl+Shift+A)",children:[M?"Hide":"Show"," Admin"]}),m?a(be,{ref:t,sessionId:m,color:e,size:r,opacity:p,smoothing:P,thinning:B,streamline:V,easing:N,startTaper:_,startCap:u,endTaper:L,endCap:w,onStrokeEnd:ne}):a("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:h("div",{className:"text-center",children:[a("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),a("p",{className:"text-gray-600",children:"Creating painting session..."})]})}),a(tt,{sessionId:m,userCount:q.length+1,currentUser:Z}),a(nt,{isConnected:he,connectionMode:me,metrics:J,className:"absolute bottom-2 left-2 z-10"}),a(Je,{color:e,size:r,opacity:p,onColorChange:n,onSizeChange:l,onOpacityChange:y,onUndo:ie,onRedo:ce,onClear:le,onExport:re}),f&&a(et,{isVisible:M,onClose:te,size:r,onSizeChange:l,smoothing:P,onSmoothingChange:D,thinning:B,onThinningChange:X,streamline:V,onStreamlineChange:z,startTaper:_,onStartTaperChange:x,startCap:u,onStartCapChange:I,endTaper:L,onEndTaperChange:T,endCap:w,onEndCapChange:c})]})}const ht=function(){return a(st,{})};export{ht as component};
