import{jsxs as l,Fragment as Re,jsx as r}from"react/jsx-runtime";import K,{useState as C,useRef as ae,useEffect as ne,useCallback as A,useMemo as je,forwardRef as Xe,useImperativeHandle as He}from"react";import{getStroke as Ye}from"perfect-freehand";import{useMutation as Z,useQuery as we,useConvex as Be,useAction as We}from"convex/react";import{anyApi as Ke}from"convex/server";import{MoreVertical as qe,ChevronUp as Qe,Paintbrush as Je,ImagePlus as Ze,Sparkles as Me,Palette as Ae,Circle as et,Eye as tt,Undo2 as nt,Redo2 as rt,X as Ee,Save as ot,Pipette as at,Users as st,Share2 as it,Copy as lt,Upload as ct,Camera as dt,Smile as ut,Grid3X3 as ht,Loader2 as gt}from"lucide-react";const G=Ke;class mt{logs=[];enabled=!1;enable(){this.enabled=!0,console.log("%cðŸ” P2P Logger Enabled","color: blue; font-weight: bold"),console.log("Monitoring P2P vs Convex activity..."),window.__p2pLogger=this}disable(){this.enabled=!1}logP2P(t,e){if(!this.enabled)return;const a={timestamp:Date.now(),type:"p2p",action:t,details:e};this.logs.push(a),console.log(`%c[P2P] ${t}`,"color: green",e||"")}logConvex(t,e){if(!this.enabled)return;const a={timestamp:Date.now(),type:"convex",action:t,details:e};this.logs.push(a),t.includes("updateLiveStroke")?console.warn(`%câš ï¸ [CONVEX] ${t} - P2P should handle this!`,"color: red",e||""):console.log(`%c[CONVEX] ${t}`,"color: orange",e||"")}getStats(){const t=this.logs.filter(c=>c.type==="p2p").length,e=this.logs.filter(c=>c.type==="convex").length,a=this.logs.filter(c=>c.type==="convex"&&c.action.includes("updateLiveStroke")).length;return console.log("%cðŸ“Š P2P vs Convex Stats","color: blue; font-weight: bold"),console.log(`P2P Messages: ${t}`),console.log(`Convex Calls: ${e}`),console.log(`Live Stroke via Convex: ${a} ${a>0?"âŒ (should be 0)":"âœ…"}`),{p2pCount:t,convexCount:e,liveStrokeCount:a}}clear(){this.logs=[],console.log("Logger cleared")}getLogs(){return this.logs}}const ye=new mt;function ze(n){const t=Z(G.users.createAnonymousUser),[e,a]=C({id:null,name:`User ${Math.floor(Math.random()*1e3)}`,color:`hsl(${Math.floor(Math.random()*360)}, 70%, 50%)`}),[c,g]=C(!1),S=we(G.paintingSessions.getSession,n?{sessionId:n}:"skip"),y=we(G.strokes.getSessionStrokes,n?{sessionId:n}:"skip"),X=we(G.presence.getSessionPresence,n?{sessionId:n}:"skip"),q=we(G.liveStrokes.getLiveStrokes,n?{sessionId:n}:"skip"),Y=Z(G.paintingSessions.createSession),P=Z(G.strokes.addStroke),z=Z(G.strokes.clearSession),$=Z(G.strokes.removeLastStroke),N=Z(G.strokes.restoreLastDeletedStroke),m=Z(G.presence.updatePresence),V=Z(G.presence.leaveSession),k=Z(G.liveStrokes.updateLiveStroke),ee=Z(G.liveStrokes.clearLiveStroke),H=Z(G.liveStrokes.clearSessionLiveStrokes),B=Z(G.viewerAcks.upsertViewerState),_=Z(G.viewerAcks.removeViewerState),re=we(G.viewerAcks.getViewerState,n&&e.id?{sessionId:n,viewerId:e.id}:"skip"),i=ae(0);ne(()=>{!c&&!e.id&&(console.log("ðŸ†• Creating anonymous user:",e.name),g(!0),t({name:e.name}).then(s=>{console.log("âœ… User created with ID:",s),a(b=>({...b,id:s})),g(!1)}).catch(s=>{console.error("âŒ Failed to create anonymous user:",s),g(!1)}))},[t,e.name,e.id,c]),ne(()=>{re?.lastAckedStrokeOrder&&(i.current=re.lastAckedStrokeOrder)},[re]),ne(()=>{if(y&&y.length>0&&n&&e.id){const s=y.reduce((b,O)=>Math.max(b,O.strokeOrder),0);s>i.current&&(i.current=s,B({sessionId:n,viewerId:e.id,lastAckedStrokeOrder:s}))}},[y,n,e.id,B]);const U=A(async(s,b=800,O=600)=>await Y({name:s,canvasWidth:b,canvasHeight:O,isPublic:!0}),[Y]),w=A(async(s,b,O,E=1)=>{if(!(!n||!e.id))return await P({sessionId:n,userId:e.id,userColor:e.color,points:s,brushColor:b,brushSize:O,opacity:E})},[n,P,e]),u=A(async(s,b,O,E)=>{if(!n||!e.id){console.log("âš ï¸ Skipping presence update - no session or user ID");return}return await m({sessionId:n,userId:e.id,userColor:e.color,userName:e.name,cursorX:s,cursorY:b,isDrawing:O,currentTool:E})},[n,m,e]),p=A(async()=>{n&&await Promise.all([z({sessionId:n}),H({sessionId:n})])},[n,z,H]),L=A(async()=>n?await $({sessionId:n}):!1,[n,$]),M=A(async()=>n?await N({sessionId:n}):!1,[n,N]),D=ae(null),F=ae(null),J=ae(0),W=A((s,b,O,E=1)=>{if(!n||!e.id)return;const j=Date.now(),de=j-J.current;if(F.current={points:s,brushColor:b,brushSize:O,opacity:E},s.length===1||de>=16){J.current=j,ye.logConvex("updateLiveStroke",{pointCount:s.length}),k({sessionId:n,userId:e.id,userColor:e.color,userName:e.name,points:s,brushColor:b,brushSize:O,opacity:E}),F.current=null,D.current&&(clearTimeout(D.current),D.current=null);return}D.current&&clearTimeout(D.current),D.current=setTimeout(()=>{const se=F.current;se&&(J.current=Date.now(),ye.logConvex("updateLiveStroke (throttled)",{pointCount:se.points.length}),k({sessionId:n,userId:e.id,userColor:e.color,userName:e.name,points:se.points,brushColor:se.brushColor,brushSize:se.brushSize,opacity:se.opacity}),F.current=null),D.current=null},16)},[n,k,e]),te=A(async()=>{if(!(!n||!e.id))return await ee({sessionId:n,userId:e.id})},[n,e.id,ee]);ne(()=>{const s=n,b=e.id;return e.name,()=>{s&&b&&(V({sessionId:s,userId:b}),_({sessionId:s,viewerId:b})),D.current&&clearTimeout(D.current)}},[n,V,_,e.id,e.name]);const ce=je(()=>y||[],[y]);return{session:S,strokes:ce,presence:X||[],liveStrokes:q||[],currentUser:e,createNewSession:U,addStrokeToSession:w,updateUserPresence:u,clearSession:p,undoLastStroke:L,redoLastStroke:M,updateLiveStrokeForUser:W,clearLiveStrokeForUser:te,isLoading:S===void 0||c||!e.id}}const pt={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}],dataChannelOptions:{ordered:!1,maxRetransmits:0,protocol:"paint-preview"},maxPeersForMesh:4,sfuUrl:void 0,turnUrl:void 0,turnUsername:void 0,turnCredential:void 0};function ft(){const n={...pt};if(typeof window<"u"){const t=window.__ENV__||{};t.VITE_SFU_URL&&(n.sfuUrl=t.VITE_SFU_URL),t.VITE_TURN_URL&&(n.turnUrl=t.VITE_TURN_URL,n.turnUsername=t.VITE_TURN_USERNAME,n.turnCredential=t.VITE_TURN_CREDENTIAL,n.iceServers.push({urls:n.turnUrl,username:n.turnUsername,credential:n.turnCredential}))}return n}function wt(n){const t=new ArrayBuffer(22),e=new DataView(t);e.setUint8(0,n.t.charCodeAt(0)),e.setUint8(1,n.t.charCodeAt(1));const a=n.id.substring(0,8);for(let c=0;c<8;c++)e.setUint8(2+c,a.charCodeAt(c)||0);return e.setFloat32(10,n.x,!0),e.setFloat32(14,n.y,!0),e.setFloat32(18,n.p,!0),t}function bt(n){if(n.byteLength!==22)return console.error("Invalid packet size:",n.byteLength),null;const t=new DataView(n),e=String.fromCharCode(t.getUint8(0),t.getUint8(1));if(e!=="pt")return console.error("Invalid packet type:",e),null;let a="";for(let y=0;y<8;y++)a+=String.fromCharCode(t.getUint8(2+y));const c=t.getFloat32(10,!0),g=t.getFloat32(14,!0),S=t.getFloat32(18,!0);return{t:"pt",id:a,x:c,y:g,p:S}}function vt(n){const t=new ArrayBuffer(11),e=new DataView(t);return e.setUint8(0,n.t.charCodeAt(0)),e.setUint8(1,n.t.charCodeAt(1)),e.setFloat32(2,n.x,!0),e.setFloat32(6,n.y,!0),e.setUint8(10,n.drawing?1:0),t}function xt(n){if(n.byteLength!==11)return null;const t=new DataView(n);return String.fromCharCode(t.getUint8(0),t.getUint8(1))!=="cu"?null:{t:"cu",x:t.getFloat32(2,!0),y:t.getFloat32(6,!0),drawing:t.getUint8(10)===1}}function yt(n){return n.byteLength===22?bt(n):n.byteLength===11?xt(n):null}class Ct{config;peers=new Map;mode="mesh";convexClient;sessionId;peerId;roomKey;pollingInterval=null;metrics={latency:0,packetsSent:0,packetsReceived:0,bytesTransferred:0,connectedPeers:0};onPacketReceived;onPeerConnected;onPeerDisconnected;onModeChanged;constructor(t){this.config=ft(),this.convexClient=t.convexClient,this.sessionId=t.sessionId,this.peerId=t.peerId,this.roomKey=t.roomKey,this.onPacketReceived=t.onPacketReceived,this.onPeerConnected=t.onPeerConnected,this.onPeerDisconnected=t.onPeerDisconnected,this.onModeChanged=t.onModeChanged,console.log("P2PManager created with peerId:",this.peerId)}async init(){try{console.log("ðŸš€ P2P: Initializing...",{sessionId:this.sessionId,peerId:this.peerId});const{peers:t,mode:e}=await this.convexClient.mutation(G.webrtc.joinP2PSession,{sessionId:this.sessionId,peerId:this.peerId,roomKey:this.roomKey});console.log("ðŸ” P2P: Found peers:",t.length,"Mode:",e),this.mode=e,this.onModeChanged?.(e);for(const a of t)console.log("ðŸ¤ P2P: Connecting to peer:",a),await this.connectToPeer(a);this.startSignalPolling(),console.log("âœ… P2P: Initialization complete")}catch(t){throw console.error("âŒ P2P: Failed to initialize:",t),t}}async connectToPeer(t){if(this.peers.has(t))return;const e=new RTCPeerConnection({iceServers:this.config.iceServers}),a={peerId:t,connection:e,dataChannel:null,isConnected:!1};this.peers.set(t,a),e.onicecandidate=async S=>{S.candidate&&await this.sendSignal(t,"ice-candidate",{candidate:S.candidate.candidate,sdpMid:S.candidate.sdpMid,sdpMLineIndex:S.candidate.sdpMLineIndex,usernameFragment:S.candidate.usernameFragment})};const c=e.createDataChannel("paint-preview",this.config.dataChannelOptions);this.setupDataChannel(c,a);const g=await e.createOffer();await e.setLocalDescription(g),await this.sendSignal(t,"offer",{type:g.type,sdp:g.sdp})}setupDataChannel(t,e){e.dataChannel=t,t.onopen=()=>{console.log("âœ… P2P: Data channel opened with peer:",e.peerId),e.isConnected=!0,this.metrics.connectedPeers++,this.onPeerConnected?.(e.peerId),ye.logP2P("peerConnected",{peerId:e.peerId})},t.onclose=()=>{e.isConnected=!1,this.metrics.connectedPeers--,this.onPeerDisconnected?.(e.peerId)},t.onmessage=a=>{this.handleDataChannelMessage(e.peerId,a.data)},t.onerror=a=>{console.error(`Data channel error with peer ${e.peerId}:`,a)}}handleDataChannelMessage(t,e){if(e instanceof ArrayBuffer){const a=yt(e);a?(this.metrics.packetsReceived++,this.metrics.bytesTransferred+=e.byteLength,a.t==="pt"?(console.log("ðŸ“¥ P2P: Received stroke packet",{from:t,strokeId:a.id,x:a.x,y:a.y,pressure:a.p}),ye.logP2P("receivePacket",{from:t,strokeId:a.id})):a.t,this.onPacketReceived?.(t,a)):console.error("âŒ P2P: Failed to decode packet from",t)}}async sendSignal(t,e,a){await this.convexClient.mutation(G.webrtc.sendSignal,{sessionId:this.sessionId,fromPeerId:this.peerId,toPeerId:t,type:e,data:a})}startSignalPolling(){this.pollingInterval=setInterval(async()=>{try{const t=await this.convexClient.query(G.webrtc.getSignals,{sessionId:this.sessionId,peerId:this.peerId});if(t.length>0){console.log(`ðŸ“¨ P2P: Received ${t.length} signals`);for(const a of t)await this.handleSignal(a);const e=t.map(a=>a.id);await this.convexClient.mutation(G.webrtc.deleteSignals,{signalIds:e})}}catch(t){console.error("Signal polling error:",t)}},1e3)}async handleSignal(t){let e=this.peers.get(t.fromPeerId);if(t.type==="offer"){if(!e){const c=new RTCPeerConnection({iceServers:this.config.iceServers});e={peerId:t.fromPeerId,connection:c,dataChannel:null,isConnected:!1},this.peers.set(t.fromPeerId,e),c.onicecandidate=async g=>{g.candidate&&await this.sendSignal(t.fromPeerId,"ice-candidate",{candidate:g.candidate.candidate,sdpMid:g.candidate.sdpMid,sdpMLineIndex:g.candidate.sdpMLineIndex,usernameFragment:g.candidate.usernameFragment})},c.ondatachannel=g=>{this.setupDataChannel(g.channel,e)}}await e.connection.setRemoteDescription(new RTCSessionDescription(t.data));const a=await e.connection.createAnswer();await e.connection.setLocalDescription(a),await this.sendSignal(t.fromPeerId,"answer",{type:a.type,sdp:a.sdp})}else if(t.type==="answer"&&e)await e.connection.setRemoteDescription(new RTCSessionDescription(t.data));else if(t.type==="ice-candidate"&&e){const a=new RTCIceCandidate(t.data);await e.connection.addIceCandidate(a)}}sendPacket(t){const e=wt(t);let a=0;for(const c of this.peers.values())if(c.isConnected&&c.dataChannel?.readyState==="open")try{c.dataChannel.send(e),this.metrics.packetsSent++,this.metrics.bytesTransferred+=e.byteLength,a++}catch(g){console.error(`Failed to send packet to peer ${c.peerId}:`,g)}a>0&&ye.logP2P("sendPacket",{strokeId:t.id,peers:a})}sendCursorPacket(t){const e=vt(t);for(const a of this.peers.values())if(a.isConnected&&a.dataChannel?.readyState==="open")try{a.dataChannel.send(e)}catch{}}getMetrics(){return{...this.metrics}}async destroy(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null);for(const t of this.peers.values())t.dataChannel&&t.dataChannel.close(),t.connection.close();this.peers.clear();try{await this.convexClient.mutation(G.webrtc.leaveP2PSession,{sessionId:this.sessionId,peerId:this.peerId})}catch(t){console.error("Error leaving P2P session:",t)}}}function $e({sessionId:n,userId:t,enabled:e=!0,presence:a=[]}){const c=Be(),g=ae(null),[S,y]=C(!1),[X,q]=C("fallback"),[Y,P]=C(new Map),[z,$]=C(new Map),[N,m]=C(null),V=ae(null),k=A((i,U)=>{if(U.t==="cu"){$(w=>{const u=new Map(w);return u.set(i,{x:U.x,y:U.y,drawing:U.drawing}),u});return}console.log("ðŸŽ¨ P2P: Processing remote stroke",{peerId:i,strokeId:U.id}),P(w=>{const u=new Map(w),p=`${i}:${U.id}`,L=u.get(p);if(L)L.points.push({x:U.x,y:U.y,pressure:U.p}),L.lastUpdate=Date.now(),console.log("ðŸ”„ P2P: Updated stroke",p,"points:",L.points.length);else{const M={peerId:i,strokeId:U.id,points:[{x:U.x,y:U.y,pressure:U.p}],color:a.find(D=>D.userName===i)?.userColor||"#FF0000",size:20,lastUpdate:Date.now()};u.set(p,M),console.log("âœ¨ P2P: Created new stroke",p)}return console.log("ðŸ“‹ P2P: Total remote strokes:",u.size),u})},[]),ee=A(i=>{console.log(`Peer connected: ${i}`),y(!0)},[]),H=A(i=>{console.log(`Peer disconnected: ${i}`),P(U=>{const w=new Map(U);for(const[u]of w)u.startsWith(`${i}:`)&&w.delete(u);return w})},[]);ne(()=>{if(console.log("ðŸ” P2P Hook - Enabled:",e,"SessionId:",n,"UserId:",t),!e||!n||!t){console.log("âš ï¸ P2P Hook - Skipping initialization:",{enabled:e,hasSession:!!n,hasUserId:!!t});return}const i=`session-${n}`,U=new Ct({sessionId:n,peerId:t,roomKey:i,convexClient:c,onPacketReceived:k,onPeerConnected:ee,onPeerDisconnected:H,onModeChanged:q});return g.current=U,U.init().catch(w=>{console.error("Failed to initialize P2P:",w),y(!1)}),V.current=setInterval(()=>{g.current&&m(g.current.getMetrics())},1e3),()=>{V.current&&clearInterval(V.current),U.destroy(),g.current=null,y(!1),P(new Map),$(new Map)}},[e,n,t,c,k,ee,H]),ne(()=>{const i=setInterval(()=>{const U=Date.now();P(w=>{const u=new Map(w);let p=!1;for(const[L,M]of u)U-M.lastUpdate>5e3&&(u.delete(L),p=!0);return p?u:w})},1e3);return()=>clearInterval(i)},[]);const B=A((i,U,w,u)=>{if(!g.current||!S)return;const p={t:"pt",id:i.substring(0,8),x:U,y:w,p:u};g.current.sendPacket(p)},[S]),_=A((i,U,w)=>{if(!g.current||!S)return;const u={t:"cu",x:i,y:U,drawing:w};g.current.sendCursorPacket(u)},[S]),re=A((i,U)=>{P(w=>{const u=new Map(w);return u.delete(`${i}:${U}`),u})},[]);return{isConnected:S,connectionMode:X,remoteStrokes:Y,remoteCursors:z,sendStrokePoint:B,sendCursorPosition:_,clearRemoteStroke:re,metrics:N}}function Oe(n){const t=we(G.images.getSessionImages,n?{sessionId:n}:"skip"),e=Z(G.images.updateImageTransform),a=Z(G.images.updateImageLayerOrder),c=Z(G.images.deleteImage),g=A(async(z,$,N)=>{await e({imageId:z,x:$,y:N})},[e]),S=A(async(z,$)=>{await e({imageId:z,scale:$})},[e]),y=A(async(z,$)=>{await e({imageId:z,rotation:$})},[e]),X=A(async(z,$)=>{await e({imageId:z,opacity:$})},[e]),q=A(async(z,$)=>{await e({imageId:z,...$})},[e]),Y=A(async(z,$)=>{await a({imageId:z,newLayerOrder:$})},[a]),P=A(async z=>{await c({imageId:z})},[c]);return{images:t||[],isLoading:t===void 0,moveImage:g,scaleImage:S,rotateImage:y,setImageOpacity:X,updateImageTransform:q,changeLayerOrder:Y,deleteImage:P}}const ke=(n,t)=>(n+t)/2;function Pt(n,t=!0){const e=n.length;if(e<4)return"";let a=n[0],c=n[1];const g=n[2];let S=`M${a[0].toFixed(2)},${a[1].toFixed(2)} Q${c[0].toFixed(2)},${c[1].toFixed(2)} ${ke(c[0],g[0]).toFixed(2)},${ke(c[1],g[1]).toFixed(2)} T`;for(let y=2,X=e-1;y<X;y++)a=n[y],c=n[y+1],S+=`${ke(a[0],c[0]).toFixed(2)},${ke(a[1],c[1]).toFixed(2)} `;return t&&(S+="Z"),S}const Ge=Xe(({sessionId:n,color:t,size:e,opacity:a,onStrokeEnd:c,smoothing:g=.75,thinning:S=.5,streamline:y=.65,easing:X=N=>N,startTaper:q=0,startCap:Y=!0,endTaper:P=0,endCap:z=!0},$)=>{const N=ae(null),m=ae(null),V=ae(null),[k,ee]=C(!1),[H,B]=C([]),[_,re]=C(null),[i,U]=C(null),[w,u]=C(null),[p,L]=C(0),[M,D]=C(new Map),F=ae(!1),J=ae(new Map),{strokes:W,presence:te,liveStrokes:ce,currentUser:s,addStrokeToSession:b,updateUserPresence:O}=ze(n),{images:E}=Oe(n);K.useEffect(()=>{console.log("Canvas - Images in session:",E.length,E)},[E]);const{isConnected:j,connectionMode:de,remoteStrokes:se,remoteCursors:be,sendStrokePoint:Ce,sendCursorPosition:ge}=$e({sessionId:n,userId:s.id?s.id.toString():s.name,enabled:!!s.id,presence:te}),[Pe,fe]=C(null);ne(()=>{W.length>0&&D(o=>{const d=new Map(o);return W.forEach(h=>{for(const[v,f]of d)if(f.points.length===h.points.length&&f.color===h.brushColor&&f.size===h.brushSize){const R=Math.abs(f.points[0].x-h.points[0].x)<1&&Math.abs(f.points[0].y-h.points[0].y)<1,I=f.points.length-1,Q=Math.abs(f.points[I].x-h.points[I].x)<1&&Math.abs(f.points[I].y-h.points[I].y)<1;if(R&&Q){d.delete(v);break}}}),d})},[W]),ne(()=>{const o=setInterval(()=>{D(d=>{const h=new Map(d);for(const[v]of h)if(h.size>5){h.delete(v);break}return h})},5e3);return()=>clearInterval(o)},[]);const ue=(o,d)=>{if(d.points.length===0)return;const h={size:d.size,smoothing:g,thinning:S,streamline:y,easing:X,start:{taper:q,cap:Y},end:{taper:P,cap:z},last:!d.isLive},v=Ye(d.points,h),f=Pt(v);if(f==="")return;o.fillStyle=d.color,o.globalAlpha=d.opacity!==void 0?d.opacity:a;const R=new Path2D(f);o.fill(R),o.globalAlpha=1},me=A(()=>{!_||!N.current||(_.clearRect(0,0,N.current.width,N.current.height),W.sort((o,d)=>o.strokeOrder-d.strokeOrder).forEach(o=>{ue(_,{points:o.points,color:o.brushColor,size:o.brushSize})}),M.forEach(o=>{ue(_,o)}))},[_,W,M,g,S,y,X,q,Y,P,z,a,ue]),pe=A(async()=>{if(!(!w||!V.current)){console.log("Redrawing image canvas with",E.length,"images"),console.log("Images details:",E.map(o=>({id:o._id,type:o.type,url:o.url?.substring(0,50)+"...",opacity:o.opacity,x:o.x,y:o.y,width:o.width,height:o.height,scale:o.scale}))),w.clearRect(0,0,V.current.width,V.current.height);for(const o of E){if(!o.url){console.log("Image missing URL:",o._id);continue}console.log("Drawing image:",o._id,"type:",o.type,"at",o.x,o.y,"scale:",o.scale,"opacity:",o.opacity);let d=J.current.get(o._id);if(!d){console.log("Loading image from URL:",o.url),d=new Image,d.crossOrigin="anonymous";try{await new Promise((h,v)=>{d.onload=()=>{console.log("Image loaded successfully:",o._id),J.current.set(o._id,d),h()},d.onerror=f=>{console.error("Failed to load image:",o._id,f),v(f)},d.src=o.url})}catch(h){console.error("Error loading image:",h);continue}}w.save(),w.globalAlpha=o.opacity,w.translate(o.x+o.width*o.scale/2,o.y+o.height*o.scale/2),w.rotate(o.rotation*Math.PI/180),w.scale(o.scale,o.scale),w.drawImage(d,-o.width/2,-o.height/2,o.width,o.height),w.restore(),console.log("Image drawn successfully:",o._id)}}},[w,E]);ne(()=>{const o=N.current,d=m.current,h=V.current;if(!o||!d||!h)return;const v=o.getContext("2d"),f=d.getContext("2d"),R=h.getContext("2d");if(!v||!f||!R)return;const I=o.parentElement;if(I){const{clientWidth:Q,clientHeight:oe}=I;o.width=Q,o.height=oe,d.width=Q,d.height=oe,h.width=Q,h.height=oe}re(v),U(f),u(R)},[]),ne(()=>{const o=()=>{const d=N.current,h=m.current,v=V.current;if(!d||!h||!v)return;const f=d.parentElement;if(f){const{clientWidth:R,clientHeight:I}=f;d.width=R,d.height=I,h.width=R,h.height=I,v.width=R,v.height=I,pe(),me()}};return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[me,pe]),ne(()=>{me()},[W,me]),ne(()=>{pe()},[E,pe]);const ve=A(()=>{if(!i||!m.current)return;const o=m.current.width,d=m.current.height;j&&be.forEach((h,v)=>{const f=h.x*o,R=h.y*d,I=te.find(ie=>ie.userName===v||ie.userId?.toString()===v)?.userColor||"#666666";i.fillStyle=I,i.beginPath(),i.arc(f,R,h.drawing?8:5,0,2*Math.PI),i.fill(),i.strokeStyle=h.drawing?"#000000":"#FFFFFF",i.lineWidth=h.drawing?2:1,i.stroke(),i.fillStyle="white",i.strokeStyle=I,i.lineWidth=3,i.font="bold 11px Arial";const Q=te.find(ie=>ie.userName===v||ie.userId?.toString()===v)?.userName||v.substring(0,8),oe=i.measureText(Q).width;i.strokeText(Q,f-oe/2,R-15),i.fillText(Q,f-oe/2,R-15)})},[i,te,s.name,j,be]);ne(()=>{if(!k)return;const o=()=>{F.current||(F.current=!0,ee(d=>(d&&B(h=>{if(h.length>0){const v=crypto.randomUUID(),f={points:h,color:t,size:e,opacity:a,id:v,isPending:!0};D(R=>new Map(R).set(v,f)),b(h,t,e,a),_&&ue(_,f)}return c?.(),i&&m.current&&i.clearRect(0,0,m.current.width,m.current.height),[]}),!1)))};return document.addEventListener("pointerup",o),()=>document.removeEventListener("pointerup",o)},[k,t,e,a,b,c,_,i]),ne(()=>{if(!(!i||!m.current)){if(i.clearRect(0,0,m.current.width,m.current.height),k&&H.length>0&&ue(i,{points:H,color:t,size:e,opacity:a,isLive:!0}),j&&m.current){const o=m.current.width,d=m.current.height;se.forEach(h=>{if(h.points.length>0){const v=h.points.map(f=>({x:f.x*o,y:f.y*d,pressure:f.pressure}));ue(i,{points:v,color:h.color,size:h.size,opacity:.8,isLive:!0})}})}ve()}},[i,H,k,t,e,a,ce,s.name,ve,j,de,se]);const he=o=>{const d=m.current,h=d?.getBoundingClientRect();if(!h||!d)return{x:0,y:0};const v=d.width/h.width,f=d.height/h.height;return{x:(o.clientX-h.left)*v,y:(o.clientY-h.top)*f,pressure:o.pressure}},Se=o=>{if(!i||!m.current)return;o.currentTarget.setPointerCapture(o.pointerId),ee(!0),F.current=!1,i.clearRect(0,0,m.current.width,m.current.height);const d=he(o);B([d]),O(d.x,d.y,!0,"brush");const h=crypto.randomUUID();if(fe(h),j&&m.current){const v=d.x/m.current.width,f=d.y/m.current.height;Ce(h,v,f,d.pressure||.5)}},Ne=o=>{if(!k||!i||!m.current){const I=he(o);if(j&&m.current){const Q=I.x/m.current.width,oe=I.y/m.current.height;ge(Q,oe,!1)}O(I.x,I.y,!1,"brush");return}const d=o.nativeEvent,v=(d.getCoalescedEvents?.()??[d]).map(I=>he({clientX:I.clientX,clientY:I.clientY,pressure:I.pressure,currentTarget:o.currentTarget,target:I.target}));if(v.length===0)return;const f=v[v.length-1];if(j&&m.current){const I=f.x/m.current.width,Q=f.y/m.current.height;ge(I,Q,!0)}O(f.x,f.y,k,"brush");const R=[...H,...v];B(R),j&&Pe&&m.current&&v.forEach(I=>{const Q=I.x/m.current.width,oe=I.y/m.current.height;Ce(Pe,Q,oe,I.pressure||.5)}),i.clearRect(0,0,m.current.width,m.current.height),ue(i,{points:R,color:t,size:e,opacity:a,isLive:!0}),ve()},Ie=o=>{if(!k||!i||!m.current||F.current)return;F.current=!0,o.currentTarget.releasePointerCapture(o.pointerId),ee(!1),i.clearRect(0,0,m.current.width,m.current.height);const d=he(o),h=[...H,d];if(h.length>0){const v=crypto.randomUUID(),f={points:h,color:t,size:e,opacity:a,id:v,isPending:!0};D(R=>new Map(R).set(v,f)),b(h,t,e,a),fe(null),_&&ue(_,f)}B([]),fe(null),c?.()},Ue=o=>{if(!k||F.current)return;F.current=!0,o.currentTarget.releasePointerCapture(o.pointerId),ee(!1),i&&m.current&&i.clearRect(0,0,m.current.width,m.current.height);const d=he(o),h=[...H,d];if(h.length>0){const v=crypto.randomUUID(),f={points:h,color:t,size:e,opacity:a,id:v,isPending:!0};D(R=>new Map(R).set(v,f)),b(h,t,e,a),_&&ue(_,f)}B([]),fe(null),c?.()};return He($,()=>({clear:()=>{_&&N.current&&_.clearRect(0,0,N.current.width,N.current.height),i&&m.current&&i.clearRect(0,0,m.current.width,m.current.height),w&&V.current&&w.clearRect(0,0,V.current.width,V.current.height),D(new Map)},undo:()=>{console.warn("Canvas.undo() is deprecated. Use session-level undo instead.")},getImageData:()=>{if(console.log("[Canvas] getImageData called"),console.log("[Canvas] Main canvas exists:",!!N.current),console.log("[Canvas] Image canvas exists:",!!V.current),console.log("[Canvas] Number of images:",E.length),console.log("[Canvas] Number of strokes:",W.length),console.log("[Canvas] Pending strokes:",M.size),!N.current)return console.log("[Canvas] ERROR: Main canvas ref is null!"),"";console.log("[Canvas] Main canvas dimensions:",N.current.width,"x",N.current.height);const o=document.createElement("canvas");o.width=N.current.width,o.height=N.current.height;const d=o.getContext("2d");if(!d)return console.log("[Canvas] Failed to get temp context"),N.current.toDataURL("image/png");d.fillStyle="white",d.fillRect(0,0,o.width,o.height),d.drawImage(N.current,0,0),console.log("[Canvas] Drew strokes layer"),V.current&&(d.drawImage(V.current,0,0),console.log("[Canvas] Drew image layer (AI images) on top"));const v=d.getImageData(0,0,o.width,o.height).data;let f=!1;for(let I=0;I<v.length;I+=4)if(v[I]!==255||v[I+1]!==255||v[I+2]!==255){f=!0;break}console.log("[Canvas] Canvas has content:",f);let R=o.toDataURL("image/png");if(console.log("[Canvas] Initial data URL length:",R.length),R.length>8e5){console.log("[Canvas] Data URL too large, resizing...");const I=Math.sqrt(8e5/R.length),Q=Math.floor(o.width*I),oe=Math.floor(o.height*I);console.log("[Canvas] Resizing from",o.width,"x",o.height,"to",Q,"x",oe);const ie=document.createElement("canvas");ie.width=Q,ie.height=oe;const x=ie.getContext("2d");if(x){x.drawImage(o,0,0,Q,oe);let T=.9;for(R=ie.toDataURL("image/jpeg",T);R.length>8e5&&T>.1;)T-=.1,R=ie.toDataURL("image/jpeg",T),console.log("[Canvas] Trying quality:",T,"size:",R.length)}}return console.log("[Canvas] Final data URL length:",R.length),console.log("[Canvas] First 100 chars of dataUrl:",R.substring(0,100)),R},getDimensions:()=>({width:N.current?.width||800,height:N.current?.height||600})}),[_,i,w]),l(Re,{children:[r("canvas",{ref:N,className:"absolute inset-0 w-full h-full border border-gray-300",style:{zIndex:0}}),r("canvas",{ref:V,className:"absolute inset-0 w-full h-full",style:{zIndex:1}}),r("canvas",{ref:m,className:"absolute inset-0 w-full h-full",onPointerDown:Se,onPointerMove:Ne,onPointerUp:Ie,onPointerLeave:Ue,style:{touchAction:"none",zIndex:2}})]})});Ge.displayName="Canvas";const Le=[{id:"brush",icon:Je,label:"Brush",ariaLabel:"Select brush tool",keyboardShortcut:"B"},{id:"upload",icon:Ze,label:"Upload",ariaLabel:"Upload image",keyboardShortcut:"U"},{id:"ai",icon:Me,label:"AI",ariaLabel:"AI Generation",keyboardShortcut:"G"},{id:"inpaint",icon:Ae,label:"Inpaint",ariaLabel:"Inpaint tool",keyboardShortcut:"I"}],De=K.memo(({value:n,min:t,max:e,onChange:a,icon:c,label:g,color:S})=>{const y=(n-t)/(e-t)*100;return l("div",{className:"flex items-center gap-2 mb-3",role:"group","aria-labelledby":`${g.toLowerCase()}-slider-label`,children:[r(c,{className:"w-4 h-4 text-white/60 flex-shrink-0","aria-hidden":"true"}),l("div",{className:"relative flex-1 h-6 flex items-center",children:[r("div",{className:"h-1 w-full bg-white/20 rounded-full overflow-hidden",role:"presentation",children:r("div",{className:"h-full transition-all duration-100",style:{width:`${y}%`,backgroundColor:S}})}),r("div",{className:"absolute top-1/2 -translate-y-1/2 w-3 h-3 rounded-full pointer-events-none",style:{left:`calc(${y}% - 6px)`,backgroundColor:S},role:"presentation"}),r("input",{type:"range",min:t,max:e,value:n,onChange:X=>a(Number(X.target.value)),className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer","aria-valuemin":t,"aria-valuemax":e,"aria-valuenow":n,"aria-labelledby":`${g.toLowerCase()}-slider-label`}),l("span",{id:`${g.toLowerCase()}-slider-label`,className:"sr-only",children:[g," slider"]})]})]})});De.displayName="Slider";const Ve=K.memo(({tool:n,isSelected:t,onClick:e})=>r("button",{onClick:e,className:`w-8 h-8 flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-1 focus-visible:ring-blue-400 ${t?"bg-blue-500 text-white":"bg-white/10 text-white hover:bg-white/20"}`,title:`${n.label}${n.keyboardShortcut?` (${n.keyboardShortcut})`:""}`,"aria-label":n.ariaLabel,"aria-pressed":t,children:r(n.icon,{className:`w-4 h-4 ${t?"scale-110 transition-transform":""}`})},n.id));Ve.displayName="ToolButton";const xe=K.memo(({icon:n,label:t,onClick:e,isPrimary:a=!1})=>r("button",{onClick:e,className:`w-8 h-8 flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-1 focus-visible:ring-blue-400 ${a?"bg-blue-500 text-white hover:bg-blue-600":"bg-white/10 text-white hover:bg-white/20"}`,title:t,"aria-label":t,children:r(n,{className:"w-4 h-4"})}));xe.displayName="ActionButton";const _e=K.memo(({color:n,onColorChange:t})=>l("div",{className:"flex items-center gap-2 mb-3",role:"group","aria-labelledby":"color-mixer-label",children:[r(at,{className:"w-4 h-4 text-white/60 flex-shrink-0","aria-hidden":"true"}),l("div",{className:"flex-1 relative",children:[r("div",{className:"w-full h-6 border border-white/20 rounded transition-all duration-100 hover:border-blue-400",style:{backgroundColor:n},title:"Click to change color",children:l("span",{className:"sr-only",children:["Current color: ",n]})}),r("input",{type:"color",value:n,onChange:a=>{t(a.target.value)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer","aria-label":"Color picker"})]}),r("span",{id:"color-mixer-label",className:"sr-only",children:"Color mixer"})]}));_e.displayName="ColorMixer";function kt({color:n,size:t,opacity:e,onColorChange:a,onSizeChange:c,onOpacityChange:g,onUndo:S,onRedo:y,onClear:X,onExport:q,onImageUpload:Y,onAIGenerate:P,selectedTool:z,onToolChange:$}){const[N,m]=K.useState("brush"),V=z||N,[k,ee]=K.useState(!1),[H,B]=K.useState(!1),[_,re]=K.useState({x:0,y:0}),[i,U]=K.useState(!1),[w,u]=K.useState({x:24,y:200}),[p,L]=K.useState({x:0,y:0}),M=K.useRef(null),D=K.useRef(null);K.useEffect(()=>{typeof window<"u"&&u({x:24,y:window.innerHeight/2-150})},[]);const F=K.useCallback(s=>{s.preventDefault(),U(!0);const b="touches"in s?s.touches[0].clientX:s.clientX,O="touches"in s?s.touches[0].clientY:s.clientY;if(M.current){const E=M.current.getBoundingClientRect();L({x:b-E.left,y:O-E.top})}},[]),J=K.useCallback(s=>{if(!i)return;const b="touches"in s?s.touches[0].clientX:s.clientX,O="touches"in s?s.touches[0].clientY:s.clientY,E=b-p.x,j=O-p.y,de=window.innerWidth-(M.current?.offsetWidth||200),se=window.innerHeight-(M.current?.offsetHeight||300);u({x:Math.max(0,Math.min(E,de)),y:Math.max(0,Math.min(j,se))})},[i,p]),W=K.useCallback(()=>{U(!1)},[]);K.useEffect(()=>{if(i){const s=j=>J(j),b=()=>W(),O=j=>J(j),E=()=>W();return document.addEventListener("mousemove",s),document.addEventListener("mouseup",b),document.addEventListener("touchmove",O,{passive:!1}),document.addEventListener("touchend",E),()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",b),document.removeEventListener("touchmove",O),document.removeEventListener("touchend",E)}}},[i,J,W]),K.useEffect(()=>{const s=()=>{const b=window.innerWidth-(M.current?.offsetWidth||200),O=window.innerHeight-(M.current?.offsetHeight||300);u(E=>({x:Math.max(0,Math.min(E.x,b)),y:Math.max(0,Math.min(E.y,O))}))};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]);const te=K.useCallback(s=>{if(s==="upload"&&Y){Y();return}if(s==="ai"&&P){P();return}$?$(s):m(s)},[$,Y,P]);K.useEffect(()=>{const s=b=>{if(b.target instanceof HTMLInputElement||b.target instanceof HTMLTextAreaElement)return;const O=b.key.toUpperCase(),E=Le.find(j=>j.keyboardShortcut===O);E&&te(E.id)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[te]);const ce=K.useCallback(s=>{s.stopPropagation();const b=s.currentTarget.getBoundingClientRect();re({x:b.right-b.left,y:b.bottom-b.top}),B(!H)},[H]);return K.useEffect(()=>{const s=b=>{D.current&&!D.current.contains(b.target)&&B(!1)};if(H)return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[H]),l("div",{ref:M,className:"fixed z-50 select-none",style:{left:`${w.x}px`,top:`${w.y}px`,transition:i?"none":"transform 0.15s ease-out"},role:"toolbar","aria-label":"wepaint.ai tools",children:[l("div",{className:"bg-black/90 backdrop-blur-md border border-white/20 overflow-hidden",style:{width:"180px"},children:[l("div",{className:`flex items-center justify-between px-2 py-1.5 border-b border-white/20 ${i?"cursor-grabbing":"cursor-grab"}`,onMouseDown:F,onTouchStart:F,"aria-label":"Drag to move panel",role:"button",children:[l("div",{className:"flex items-center gap-1",children:[r("span",{className:"text-xs font-medium text-white/80",children:"wepaint.ai"}),r("button",{onClick:ce,onMouseDown:s=>s.stopPropagation(),onTouchStart:s=>s.stopPropagation(),className:"p-0.5 hover:bg-white/20 rounded transition-colors","aria-label":"More options",children:r(qe,{className:"w-3.5 h-3.5 text-white/60"})})]}),r("button",{onClick:s=>{s.stopPropagation(),ee(!k)},onMouseDown:s=>s.stopPropagation(),onTouchStart:s=>s.stopPropagation(),className:"p-1 hover:bg-white/20 transition-colors","aria-expanded":!k,"aria-label":k?"Expand tools panel":"Collapse tools panel",children:r(Qe,{className:`w-3.5 h-3.5 text-white/60 transition-transform ${k?"":"rotate-180"}`})})]}),!k&&l("div",{className:"p-2",children:[r("div",{className:"grid grid-cols-4 border-b border-white/20 mb-3",children:Le.map((s,b)=>r("div",{className:`${b<Le.length-1?"border-r border-white/20":""}`,children:r(Ve,{tool:s,isSelected:V===s.id,onClick:()=>te(s.id)})},s.id))}),r("div",{className:"border-b border-white/20 mb-3 pb-3",children:r(_e,{color:n,onColorChange:a})}),l("div",{className:"border-b border-white/20 mb-3 pb-3",children:[r(De,{value:t,min:1,max:100,onChange:c,icon:et,label:"Brush Size",color:"hsl(var(--primary))"}),r(De,{value:e*100,min:0,max:100,onChange:s=>g(s/100),icon:tt,label:"Opacity",color:"hsl(0, 0%, 50%)"})]}),l("div",{className:"grid grid-cols-4",children:[r("div",{className:"border-r border-white/20",children:r(xe,{icon:nt,label:"Undo",onClick:S})}),r("div",{className:"border-r border-white/20",children:r(xe,{icon:rt,label:"Redo",onClick:y})}),r("div",{className:"border-r border-white/20",children:r(xe,{icon:Ee,label:"Clear Canvas",onClick:X})}),r("div",{children:r(xe,{icon:ot,label:"Export",onClick:q})})]})]})]}),H&&l("div",{ref:D,className:"absolute bg-black/90 backdrop-blur-md border border-white/20 rounded-md shadow-xl py-1 min-w-[150px]",style:{left:`${_.x}px`,top:`${_.y}px`},children:[r("button",{className:"w-full px-3 py-1.5 text-left text-sm text-white hover:bg-white/20 transition-colors",onClick:()=>{B(!1),alert("wepaint.ai - Collaborative painting app")},children:"About"}),r("button",{className:"w-full px-3 py-1.5 text-left text-sm text-white hover:bg-white/20 transition-colors",onClick:()=>{B(!1),window.open("https://github.com/your-repo","_blank")},children:"GitHub"}),r("div",{className:"border-t border-white/20 my-1"}),r("button",{className:"w-full px-3 py-1.5 text-left text-sm text-white hover:bg-white/20 transition-colors",onClick:()=>{B(!1)},children:"Settings"}),r("button",{className:"w-full px-3 py-1.5 text-left text-sm text-white hover:bg-white/20 transition-colors",onClick:()=>{B(!1)},children:"Keyboard Shortcuts"})]})]})}const St=({size:n,onSizeChange:t,smoothing:e,onSmoothingChange:a,thinning:c,onThinningChange:g,streamline:S,onStreamlineChange:y,startTaper:X,onStartTaperChange:q,startCap:Y,onStartCapChange:P,endTaper:z,onEndTaperChange:$,endCap:N,onEndCapChange:m,isVisible:V,onClose:k})=>{const[ee,H]=C({x:50,y:50}),[B,_]=C(!1),re=ae({x:0,y:0}),i=ae(null);ne(()=>{const u=L=>{if(!B||!i.current)return;const M=L.clientX-re.current.x,D=L.clientY-re.current.y;H(F=>({x:F.x+M,y:F.y+D})),re.current={x:L.clientX,y:L.clientY}},p=()=>{_(!1)};return B&&(document.addEventListener("mousemove",u),document.addEventListener("mouseup",p)),()=>{document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",p)}},[B]);const U=u=>{u.target.closest(".admin-panel-header")&&(_(!0),re.current={x:u.clientX,y:u.clientY})},w="block text-xs font-medium text-gray-700 mb-0.5";return V?l("div",{ref:i,className:"absolute bg-white p-4 rounded-lg shadow-xl border border-gray-300 w-64 text-sm",style:{top:`${ee.y}px`,left:`${ee.x}px`,cursor:B?"grabbing":"default",zIndex:1e3},onMouseDown:U,children:[l("div",{className:"admin-panel-header flex justify-between items-center mb-3 pb-2 border-b border-gray-200",style:{cursor:"grab"},children:[r("h3",{className:"text-base font-semibold",children:"Admin Controls"}),r("button",{onClick:k,className:"text-gray-500 hover:text-gray-700 text-lg",children:"Ã—"})]}),l("div",{className:"space-y-3",children:[l("div",{children:[l("label",{htmlFor:"size",className:w,children:["Size: ",n.toFixed(2)]}),r("input",{type:"range",id:"size",min:"1",max:"100",step:"1",value:n,onChange:u=>t(parseFloat(u.target.value)),className:"w-full"})]}),l("div",{children:[l("label",{htmlFor:"smoothing",className:w,children:["Smoothing: ",e.toFixed(2)]}),r("input",{type:"range",id:"smoothing",min:"0",max:"1",step:"0.01",value:e,onChange:u=>a(parseFloat(u.target.value)),className:"w-full"})]}),l("div",{children:[l("label",{htmlFor:"thinning",className:w,children:["Thinning: ",c.toFixed(2)]}),r("input",{type:"range",id:"thinning",min:"-1",max:"1",step:"0.01",value:c,onChange:u=>g(parseFloat(u.target.value)),className:"w-full"})]}),l("div",{children:[l("label",{htmlFor:"streamline",className:w,children:["Streamline: ",S.toFixed(2)]}),r("input",{type:"range",id:"streamline",min:"0",max:"1",step:"0.01",value:S,onChange:u=>y(parseFloat(u.target.value)),className:"w-full"})]}),l("div",{children:[l("label",{htmlFor:"startTaper",className:w,children:["Start Taper: ",X.toFixed(2)]}),r("input",{type:"range",id:"startTaper",min:"0",max:"100",step:"1",value:X,onChange:u=>q(parseFloat(u.target.value)),className:"w-full"})]}),l("div",{className:"flex items-center",children:[r("input",{type:"checkbox",id:"startCap",checked:Y,onChange:u=>P(u.target.checked),className:"mr-2"}),r("label",{htmlFor:"startCap",className:w+" mb-0",children:"Start Cap"})]}),l("div",{children:[l("label",{htmlFor:"endTaper",className:w,children:["End Taper: ",z.toFixed(2)]}),r("input",{type:"range",id:"endTaper",min:"0",max:"100",step:"1",value:z,onChange:u=>$(parseFloat(u.target.value)),className:"w-full"})]}),l("div",{className:"flex items-center",children:[r("input",{type:"checkbox",id:"endCap",checked:N,onChange:u=>m(u.target.checked),className:"mr-2"}),r("label",{htmlFor:"endCap",className:w+" mb-0",children:"End Cap"})]})]})]}):null};function Nt({sessionId:n,userCount:t,currentUser:e}){const[a,c]=C(!1),g=async()=>{if(!n)return;const S=`${window.location.origin}?session=${n}`;await navigator.clipboard.writeText(S),c(!0),setTimeout(()=>c(!1),2e3)};return n?l("div",{className:"absolute top-4 left-4 bg-white rounded-lg shadow-lg p-4 max-w-sm",children:[l("div",{className:"flex items-center gap-2 mb-3",children:[r("div",{className:"w-4 h-4 rounded-full",style:{backgroundColor:e.color}}),r("span",{className:"font-medium text-sm",children:e.name})]}),l("div",{className:"flex items-center gap-2 mb-2",children:[r(st,{className:"w-4 h-4 text-gray-500"}),l("span",{className:"text-sm text-gray-600",children:[t," user",t!==1?"s":""," online"]})]}),l("div",{className:"flex items-center gap-2",children:[r(it,{className:"w-4 h-4 text-gray-500"}),l("button",{onClick:g,className:"flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700 transition-colors",children:[r(lt,{className:"w-3 h-3"}),a?"Copied!":"Share session"]})]}),l("div",{className:"mt-2 text-xs text-gray-500 font-mono bg-gray-50 p-2 rounded",children:["Session: ",n.slice(-8)]})]}):null}function It({isConnected:n,connectionMode:t,metrics:e,className:a=""}){const c=()=>n?t==="mesh"?"bg-green-500":t==="sfu"?"bg-blue-500":"bg-gray-500":"bg-red-500",g=()=>n?t==="mesh"?"P2P Direct":t==="sfu"?"P2P Relay":"P2P Only":"P2P Required";return l("div",{className:`flex items-center gap-2 text-sm ${a}`,children:[l("div",{className:"flex items-center gap-1",children:[r("div",{className:`w-2 h-2 rounded-full ${c()}`}),r("span",{className:"text-gray-600",children:g()})]}),e&&n&&l("div",{className:"flex items-center gap-3 text-xs text-gray-500",children:[l("span",{children:["Peers: ",e.connectedPeers]}),l("span",{children:["Latency: ",e.latency,"ms"]}),l("span",{children:["Sent: ",e.packetsSent]}),l("span",{children:["Recv: ",e.packetsReceived]})]})]})}const Ut=5*1024*1024,Te=["image/png","image/jpeg","image/jpg","image/gif","image/webp"];function Lt({sessionId:n,userId:t,onImageUploaded:e,onClose:a,canvasWidth:c=800,canvasHeight:g=600}){const S=ae(null),[y,X]=C(!1),[q,Y]=C(null),[P,z]=C(null),[$,N]=C(null),[m,V]=C(!1),k=Z(G.images.generateUploadUrl),ee=Z(G.images.uploadImage),H=A(async p=>{if(console.log("File selected:",p.name,"Type:",p.type,"Size:",p.size),!Te.includes(p.type)){Y("Please select a valid image file (PNG, JPG, GIF, WebP)");return}if(p.size>Ut){Y("File size must be less than 5MB");return}Y(null),z(p);const L=new FileReader;L.onload=M=>N(M.target?.result),L.readAsDataURL(p)},[]),B=A(p=>{const L=p.target.files?.[0];L&&H(L)},[H]),_=A(p=>{p.preventDefault(),V(!1);const L=p.dataTransfer.files[0];L&&L.type.startsWith("image/")&&H(L)},[H]),re=A(p=>{p.preventDefault(),V(!0)},[]),i=A(p=>{p.preventDefault(),V(!1)},[]),U=p=>new Promise((L,M)=>{const D=new Image,F=URL.createObjectURL(p);D.onload=()=>{URL.revokeObjectURL(F),L({width:D.width,height:D.height})},D.onerror=()=>{URL.revokeObjectURL(F),M(new Error("Failed to load image"))},D.src=F}),w=async(p,L,M)=>new Promise((D,F)=>{const J=new Image,W=URL.createObjectURL(p);J.onload=async()=>{URL.revokeObjectURL(W);const te=c/L,ce=g/M,s=Math.min(te,ce,1),b=Math.floor(L*s),O=Math.floor(M*s),E=document.createElement("canvas");E.width=b,E.height=O;const j=E.getContext("2d");if(!j){F(new Error("Failed to get canvas context"));return}j.drawImage(J,0,0,b,O),E.toBlob(de=>{de?D({blob:de,width:b,height:O}):F(new Error("Failed to create blob"))},p.type,.9)},J.onerror=()=>{URL.revokeObjectURL(W),F(new Error("Failed to load image for resizing"))},J.src=W}),u=async()=>{if(!(!P||!n)){X(!0),Y(null);try{console.log("Getting image dimensions...");const p=await U(P);console.log("Original image dimensions:",p),console.log("Canvas dimensions:",c,"x",g);let L=P,M=p;if(p.width>c||p.height>g){console.log("Image exceeds canvas bounds, resizing...");const s=await w(P,p.width,p.height);L=s.blob,M={width:s.width,height:s.height},console.log("Resized dimensions:",M)}console.log("Generating upload URL...");const D=await k();console.log("Upload URL generated"),console.log("Uploading to Convex storage...");const F=await fetch(D,{method:"POST",headers:{"Content-Type":P.type},body:L});if(!F.ok)throw console.error("Upload response not OK:",F.status,F.statusText),new Error("Failed to upload file");const{storageId:J}=await F.json();console.log("File uploaded, storage ID:",J);const W=Math.max(0,(c-M.width)/2),te=Math.max(0,(g-M.height)/2);console.log("Creating image record in database...");const ce=await ee({sessionId:n,userId:t,storageId:J,filename:P.name,mimeType:P.type,width:M.width,height:M.height,x:W,y:te});console.log("Image record created:",ce),e?.(ce),a()}catch(p){console.error("Upload error:",p),Y("Failed to upload image. Please try again.")}finally{X(!1)}}};return K.useEffect(()=>{const p=L=>{L.key==="Escape"&&!y&&a()};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[a,y]),r("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50",children:l("div",{className:"bg-black/90 backdrop-blur-md border border-white/20 p-6 rounded-lg shadow-lg max-w-md w-full mx-4",children:[l("div",{className:"flex items-center justify-between mb-4",children:[r("h3",{className:"text-lg font-semibold text-white",children:"Upload Image"}),r("button",{onClick:a,className:"p-1 hover:bg-white/20 rounded-sm transition-colors text-white/70 hover:text-white","aria-label":"Close",children:r(Ee,{className:"w-4 h-4"})})]}),r("input",{ref:S,type:"file",accept:Te.join(","),onChange:B,className:"hidden"}),P?l("div",{className:"space-y-4",children:[$&&r("div",{className:"relative",children:r("img",{src:$,alt:"Preview",className:"w-full h-48 object-contain rounded bg-white/10"})}),l("div",{className:"space-y-1",children:[r("p",{className:"text-sm font-medium truncate text-white",children:P.name}),l("p",{className:"text-xs text-white/60",children:[(P.size/1024/1024).toFixed(2)," MB"]})]}),l("div",{className:"flex gap-2",children:[r("button",{onClick:u,disabled:y,className:"flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 transition-colors",children:y?"Uploading...":"Upload"}),r("button",{onClick:()=>{z(null),N(null),Y(null)},disabled:y,className:"px-4 py-2 border border-white/20 text-white rounded hover:bg-white/10 transition-colors",children:"Change"})]})]}):l("div",{onClick:()=>S.current?.click(),onDrop:_,onDragOver:re,onDragLeave:i,className:`
              w-full p-8 border-2 border-dashed rounded-lg cursor-pointer
              transition-colors duration-200
              ${m?"border-blue-400 bg-blue-400/10":"border-white/20 hover:border-blue-400/50"}
            `,children:[r(ct,{className:"w-8 h-8 mx-auto mb-3 text-white/60"}),r("p",{className:"text-sm text-center text-white/70",children:"Click to select or drag and drop"}),r("p",{className:"text-xs text-center text-white/60 mt-2",children:"PNG, JPG, GIF, WebP â€¢ Max 5MB"})]}),q&&r("div",{className:"mt-4 p-3 bg-red-500/20 border border-red-500/40 rounded",children:r("p",{className:"text-sm text-red-400",children:q})})]})})}function Rt({isOpen:n,onClose:t,sessionId:e,canvasDataUrl:a,canvasWidth:c,canvasHeight:g,onGenerationComplete:S}){const[y,X]=C(""),[q,Y]=C(.85),[P,z]=C(!1),[$,N]=C(null),m=We(G.aiGeneration.generateImage),V=async()=>{if(!y.trim()){N("Please enter a prompt");return}z(!0),N(null);try{console.log("Calling generateImage with:",{sessionId:e,prompt:y.trim(),imageDataLength:a.length});const k=await m({sessionId:e,prompt:y.trim(),imageData:a,weight:q,canvasWidth:c,canvasHeight:g});console.log("AI Generation result:",k),console.log("Result type:",typeof k),console.log("Result keys:",k?Object.keys(k):"null"),k.success&&k.imageUrl?(console.log("Generated image URL:",k.imageUrl),S(k.imageUrl),t()):N(k.error||"Generation failed")}catch(k){N("Failed to generate image. Please try again."),console.error("AI generation error:",k)}finally{z(!1)}};return n?l("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[r("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:t}),l("div",{className:"relative bg-black/90 backdrop-blur-md border border-white/20 rounded-lg shadow-xl max-w-md w-full mx-4 p-6",children:[r("button",{onClick:t,className:"absolute top-4 right-4 text-white/70 hover:text-white transition-colors",disabled:P,children:r(Ee,{className:"w-5 h-5"})}),l("div",{className:"flex items-center gap-2 mb-4",children:[r(Me,{className:"w-5 h-5 text-blue-400"}),r("h2",{className:"text-lg font-semibold text-white",children:"AI Generation"})]}),l("div",{className:"mb-4",children:[r("p",{className:"text-sm text-white/70 mb-2",children:"Current canvas:"}),r("div",{className:"relative w-full h-32 bg-white/10 rounded border border-white/20 overflow-hidden",children:r("img",{src:a,alt:"Canvas preview",className:"w-full h-full object-contain"})})]}),l("div",{className:"mb-4",children:[r("label",{className:"block text-sm font-medium text-white mb-2",children:"Quick styles:"}),l("div",{className:"grid grid-cols-4 gap-2 mb-3",children:[l("button",{onClick:()=>X("transform this into a watercolor painting with soft blended colors and fluid brushstrokes"),className:"flex flex-col items-center gap-1 p-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md transition-colors text-white",disabled:P,children:[r(Ae,{className:"w-6 h-6"}),r("span",{className:"text-xs",children:"Watercolor"})]}),l("button",{onClick:()=>X("transform this into a photorealistic image with natural lighting and detailed textures"),className:"flex flex-col items-center gap-1 p-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md transition-colors text-white",disabled:P,children:[r(dt,{className:"w-6 h-6"}),r("span",{className:"text-xs",children:"Photo Real"})]}),l("button",{onClick:()=>X("transform this into a cartoon style illustration with bold colors and clean lines"),className:"flex flex-col items-center gap-1 p-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md transition-colors text-white",disabled:P,children:[r(ut,{className:"w-6 h-6"}),r("span",{className:"text-xs",children:"Cartoon"})]}),l("button",{onClick:()=>X("transform this into pixel art with a retro 8-bit video game aesthetic"),className:"flex flex-col items-center gap-1 p-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md transition-colors text-white",disabled:P,children:[r(ht,{className:"w-6 h-6"}),r("span",{className:"text-xs",children:"Pixel Art"})]})]})]}),l("div",{className:"mb-4",children:[r("label",{htmlFor:"prompt",className:"block text-sm font-medium text-white mb-2",children:"Or describe your own transformation:"}),r("textarea",{id:"prompt",value:y,onChange:k=>X(k.target.value),placeholder:"e.g., 'make it look like a watercolor painting' or 'add a sunset background'",className:"w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none text-white placeholder-white/50",rows:3,disabled:P})]}),l("div",{className:"mb-4",children:[l("label",{htmlFor:"weight",className:"block text-sm font-medium text-white mb-2",children:["Canvas influence: ",q.toFixed(2)]}),r("input",{id:"weight",type:"range",min:"0",max:"1",step:"0.05",value:q,onChange:k=>Y(parseFloat(k.target.value)),disabled:P,className:"ai-modal-slider"}),l("div",{className:"flex justify-between text-xs text-white/60 mt-1",children:[r("span",{children:"0 (ignore canvas)"}),r("span",{children:"1 (preserve canvas)"})]})]}),$&&r("div",{className:"mb-4 p-3 bg-red-500/20 border border-red-500/40 rounded-md",children:r("p",{className:"text-sm text-red-400",children:$})}),l("div",{className:"flex gap-3 justify-end",children:[r("button",{onClick:t,disabled:P,className:"px-4 py-2 text-sm font-medium text-white bg-white/10 hover:bg-white/20 rounded-md transition-colors disabled:opacity-50",children:"Cancel"}),r("button",{onClick:V,disabled:P||!y.trim(),className:"px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:P?l(Re,{children:[r(gt,{className:"w-4 h-4 animate-spin"}),"Generating..."]}):l(Re,{children:[r(Me,{className:"w-4 h-4"}),"Generate"]})})]})]})]}):null}function Mt(){return"true"==="true"}function Dt(){return!Mt()}function Et(){const n=ae(null),[t,e]=C("#000000"),[a,c]=C(20),[g,S]=C(1),[y,X]=C(.35),[q,Y]=C(.2),[P,z]=C(.4),[$,N]=C(0),[m,V]=C(!0),[k,ee]=C(0),[H,B]=C(!0),_=x=>x,[re,i]=C([]),[U,w]=C(-1),[u,p]=C(null),[L,M]=C(!1),[D,F]=C(!1),[J,W]=C("brush"),[te,ce]=C(1),[s,b]=C(!0),[O,E]=C(!1),j=Dt(),[de,se]=C(j),{createNewSession:be,presence:Ce,currentUser:ge,clearSession:Pe,undoLastStroke:fe,redoLastStroke:ue}=ze(u),me=Z(G.images.addAIGeneratedImage),pe=Z(G.images.updateAIImageTransform),{images:ve}=Oe(u),he=ve.filter(x=>x.type==="ai-generated"),{isConnected:Se,connectionMode:Ne,metrics:Ie}=$e({sessionId:u,userId:ge.id?ge.id.toString():ge.name,enabled:!!ge.id});ne(()=>{},[]),ne(()=>{if(!O&&he.length>0){E(!0);return}const x=async()=>{for(const T of he)try{T.type==="ai-generated"&&await pe({imageId:T._id,opacity:s?te:0})}catch(le){console.error("Failed to update AI image opacity:",le,T)}};he.length>0&&O&&x()},[s,te,he,pe,O]),ne(()=>{(async()=>{try{const le=new URLSearchParams(window.location.search).get("session");if(le)p(le);else{const Fe=await be("Collaborative Painting",800,600);p(Fe),window.history.replaceState({},"",`?session=${Fe}`)}}catch(T){console.error("Failed to create/join session:",T)}})()},[be]);const Ue=()=>{const x=n.current?.getImageData();if(x){const T=re.slice(0,U+1);T.push(x),i(T),w(T.length-1)}},o=async()=>{try{await fe()}catch(x){console.error("Failed to undo stroke:",x)}},d=async()=>{try{await ue()}catch(x){console.error("Failed to redo stroke:",x)}},h=async()=>{n.current?.clear(),i([]),w(-1);try{await Pe()}catch(x){console.error("Failed to clear session:",x)}},v=()=>{const x=n.current?.getImageData();if(x){const T=document.createElement("a");T.download=`wepaintai-${Date.now()}.png`,T.href=x,T.click()}},f=A(()=>{se(x=>!x)},[]),R=A(()=>{M(!0)},[]),I=A(x=>{console.log("Image uploaded:",x),M(!1),W("brush")},[]),Q=A(()=>{F(!0)},[]),oe=A(async x=>{if(!u)return;console.log("handleAIGenerationComplete called with URL:",x),console.log("URL type:",typeof x),console.log("URL length:",x.length);const T=new Image;T.crossOrigin="anonymous",T.onload=async()=>{try{const le=n.current?.getDimensions()||{width:800,height:600};await me({sessionId:u,imageUrl:x,width:T.width,height:T.height,canvasWidth:le.width,canvasHeight:le.height}),console.log("AI-generated image added to canvas"),F(!1),W("brush")}catch(le){console.error("Failed to add AI-generated image:",le)}},T.onerror=le=>{console.error("Failed to load generated image from URL:",x),console.error("Error event:",le),F(!1),W("brush")},T.src=x},[u,me]),ie=A(x=>{W(x),x==="upload"&&R()},[R]);return ne(()=>{if(!j)return;const x=T=>{T.ctrlKey&&T.shiftKey&&T.key==="A"&&(T.preventDefault(),f())};return window.addEventListener("keydown",x),()=>{window.removeEventListener("keydown",x)}},[f,j]),l("div",{className:"relative w-full h-full bg-gray-50",children:[he.length>0&&l("div",{className:"absolute top-2 right-40 z-50 flex items-center gap-2",children:[l("button",{onClick:()=>b(!s),className:"bg-black/90 backdrop-blur-md border border-white/20 hover:bg-black/80 text-white font-bold py-1 px-2 rounded text-xs",title:"Toggle AI image visibility",children:[s?"Hide":"Show"," AI"]}),s&&r("input",{type:"range",min:"0",max:"1",step:"0.1",value:te,onChange:x=>ce(parseFloat(x.target.value)),className:"ai-opacity-slider",title:`AI image opacity: ${Math.round(te*100)}%`})]}),j&&l("button",{onClick:f,className:"absolute top-2 right-28 z-50 bg-black/90 backdrop-blur-md border border-white/20 hover:bg-black/80 text-white font-bold py-1 px-2 rounded text-xs",title:"Toggle Admin Panel (Ctrl+Shift+A)",children:[de?"Hide":"Show"," Admin"]}),u?r(Ge,{ref:n,sessionId:u,color:t,size:a,opacity:g,smoothing:y,thinning:q,streamline:P,easing:_,startTaper:$,startCap:m,endTaper:k,endCap:H,onStrokeEnd:Ue}):r("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:l("div",{className:"text-center",children:[r("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),r("p",{className:"text-gray-600",children:"Creating painting session..."})]})}),j&&r(Nt,{sessionId:u,userCount:Ce.length+1,currentUser:ge}),j&&r(It,{isConnected:Se,connectionMode:Ne,metrics:Ie,className:"absolute bottom-2 left-2 z-10"}),!1,r(kt,{color:t,size:a,opacity:g,onColorChange:e,onSizeChange:c,onOpacityChange:S,onUndo:o,onRedo:d,onClear:h,onExport:v,onImageUpload:R,onAIGenerate:Q,selectedTool:J,onToolChange:ie}),L&&r(Lt,{sessionId:u,userId:ge.id,onImageUploaded:I,onClose:()=>{M(!1),W("brush")},canvasWidth:n.current?.getDimensions().width,canvasHeight:n.current?.getDimensions().height}),D&&u&&(()=>{const x=n.current?.getImageData()||"";console.log("[PaintingView] Canvas ref exists:",!!n.current),console.log("[PaintingView] Canvas data for AI generation:",x.substring(0,100)+"..."),console.log("[PaintingView] Canvas data length:",x.length),console.log("[PaintingView] Canvas data is empty:",x===""||x.length===0),(!x||x.length===0)&&(console.error("[PaintingView] ERROR: Canvas data is empty!"),setTimeout(()=>{const le=n.current?.getImageData()||"";console.log("[PaintingView] Retry canvas data length:",le.length)},100));const T=n.current?.getDimensions()||{width:800,height:600};return r(Rt,{isOpen:D,onClose:()=>{F(!1),W("brush")},sessionId:u,canvasDataUrl:x,canvasWidth:T.width,canvasHeight:T.height,onGenerationComplete:oe})})(),j&&r(St,{isVisible:de,onClose:f,size:a,onSizeChange:c,smoothing:y,onSmoothingChange:X,thinning:q,onThinningChange:Y,streamline:P,onStreamlineChange:z,startTaper:$,onStartTaperChange:N,startCap:m,onStartCapChange:V,endTaper:k,onEndTaperChange:ee,endCap:H,onEndCapChange:B})]})}const Gt=function(){return r(Et,{})};export{Gt as component};
